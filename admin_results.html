<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Exam Results</title>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
  <h1 class="text-3xl font-bold mb-8 text-purple-600 flex items-center">
    <span>ğŸ“Š Student Exam Results</span>
  </h1>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
    <!-- LEFT: Students -->
    <div class="bg-white shadow-lg p-6 rounded-xl">
      <h2 class="text-xl font-bold mb-4">Students</h2>
      <table class="w-full text-left text-sm">
        <thead>
          <tr class="border-b">
            <th class="py-2 px-2">Name</th>
            <th>ID</th>
            <th>Score</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody id="studentTableBody"></tbody>
      </table>
    </div>

    <!-- RIGHT: Details -->
    <div class="bg-white shadow-lg p-6 rounded-xl md:col-span-2">
      <h2 id="detailsTitle" class="text-xl font-bold mb-4">
        Studentâ€™s Test Details
      </h2>
      <table class="w-full text-left text-sm">
        <thead>
          <tr class="border-b bg-gray-50">
            <th class="py-2 px-2">#</th>
            <th class="px-2">Question</th>
            <th class="px-2">Correct Answer</th>
            <th class="px-2">Selected Answer</th>
          </tr>
        </thead>
        <tbody id="detailsTableBody"></tbody>
      </table>
    </div>
  </div>

<script>
/* ---------------- Firebase ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBGd_KrhvdCfxeRPcXn7f8csLUfcZkmKVs",
  authDomain: "sswt-final.firebaseapp.com",
  projectId: "sswt-final"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

/* ---------------- State ---------------- */
let selectedRow = null;

/* ------------- Helpers ------------- */
function normalizeQuestion(q, idx) {
  // qëŠ” responses.questions ì›ì†Œ ë˜ëŠ” exam_questionsì˜ ì›ì†Œì¼ ìˆ˜ ìˆìŒ
  const options = q.options && q.options.length === 4
    ? q.options
    : [q.opt1, q.opt2, q.opt3, q.opt4].filter(v => v !== undefined);

  return {
    id: q.id || `Q${idx + 1}`,
    text: q.text || q.question || "",
    options,
    answer: typeof q.answer === "number" ? q.answer : parseInt(q.answer ?? 0, 10)
  };
}

function getAnswerText(q, idx) {
  if (idx == null || idx < 0 || !q.options || !q.options[idx]) return "(no answer)";
  return q.options[idx];
}

/* -------- Load Students -------- */
async function loadStudents() {
  const snap = await db.collection("exam_responses").orderBy("createdAt","desc").get();
  const tbody = document.getElementById("studentTableBody");
  tbody.innerHTML = "";

  snap.forEach(doc => {
    const d = doc.data();
    const tr = document.createElement("tr");
    tr.className = "border-b hover:bg-purple-50 cursor-pointer transition";
    tr.onclick = () => onStudentClick(tr, doc.id);

    tr.innerHTML = `
      <td class="py-2 px-2">${d.studentName ?? "(no name)"}</td>
      <td>${d.studentId ?? ""}</td>
      <td>${d.score ?? ""}</td>
      <td>${(d.timeUsedSeconds ?? 0)}s</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ------- Load a student details ------- */
async function onStudentClick(row, docId) {
  if (selectedRow) selectedRow.classList.remove("bg-purple-100","border-l-4","border-purple-600");
  row.classList.add("bg-purple-100","border-l-4","border-purple-600");
  selectedRow = row;

  const doc = await db.collection("exam_responses").doc(docId).get();
  const d = doc.data();
  if (!d) return;

  // 1) ê¸°ë³¸ì€ ì‘ì‹œ ë¬¸ì„œì— ì €ì¥ëœ questions ì‚¬ìš© (A ë°©ì‹)
  let qArr = Array.isArray(d.questions) ? d.questions : [];
  // 2) ì—†ìœ¼ë©´ exam_questions/{examDocId}ì—ì„œ ë¡œë“œ(ë ˆê±°ì‹œ í˜¸í™˜)
  if (!qArr.length && d.examDocId) {
    const bank = await db.collection("exam_questions").doc(d.examDocId).get();
    if (bank.exists) {
      const raw = bank.data().questions || [];
      qArr = Array.isArray(raw) ? raw : Object.values(raw);
    }
  }

  const questions = qArr.map(normalizeQuestion);

  // answers: [{index, selected}] í˜¹ì€ [{qId, selected}] ë“±ì¼ ìˆ˜ë„ ìˆìœ¼ë‹ˆ ë³´ì •
  const answers = Array.isArray(d.answers) ? d.answers : [];
  const tbody = document.getElementById("detailsTableBody");
  tbody.innerHTML = "";

  let correct = 0, total = questions.length;

  for (let i = 0; i < total; i++) {
    const q = questions[i];

    // ì‘ë‹µì—ì„œ indexë¡œ ì°¾ëŠ” ê²ƒì„ ìš°ì„  (A ë°©ì‹)
    let a = answers.find(x => x.index === i);
    // í˜¹ì‹œ qIdë¡œ ì €ì¥ëœ ë ˆê±°ì‹œê°€ ìˆë‹¤ë©´ ë³´ì¡° ë§¤ì¹­
    if (!a && q.id) a = answers.find(x => x.qId === q.id);

    const selIdx = a ? a.selected : null;
    const isCorrect = (selIdx === q.answer);
    if (isCorrect) correct++;

    const correctText  = getAnswerText(q, q.answer);
    const selectedText = getAnswerText(q, selIdx);

    tbody.insertAdjacentHTML("beforeend", `
      <tr class="border-b">
        <td class="py-2 px-2">${i + 1}</td>
        <td class="px-2">${q.text}</td>
        <td class="px-2 font-semibold text-green-600">${correctText}</td>
        <td class="px-2 font-semibold ${isCorrect ? "text-green-600" : "text-red-600"}">
          ${selectedText}
        </td>
      </tr>
    `);
  }

  document.getElementById("detailsTitle").textContent =
    `Studentâ€™s Test Details (${correct} / ${total || 0})`;
}

/* -------- Init -------- */
loadStudents();
</script>
</body>
</html>
