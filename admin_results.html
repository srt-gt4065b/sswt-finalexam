<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin â€“ Student Results</title>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 p-10">

<h1 class="text-3xl font-bold mb-6 text-purple-600">ğŸ“Š Student Exam Results</h1>

<!-- ==================== LEFT STUDENT LIST ==================== -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-10">

<div class="bg-white shadow-lg p-6 rounded-xl">
    <h2 class="text-xl font-bold mb-4">Students</h2>
    <table class="w-full text-left">
        <thead>
            <tr class="border-b">
                <th class="py-2">Name</th>
                <th>ID</th>
                <th>Score</th>
                <th>Time</th>
            </tr>
        </thead>
        <tbody id="studentTableBody"></tbody>
    </table>
</div>

<!-- ==================== RIGHT WRONG ANSWERS ==================== -->
<div class="bg-white shadow-lg p-6 rounded-xl md:col-span-2">
    <h2 class="text-xl font-bold mb-4">Wrong questions</h2>
    <table class="w-full text-left text-sm">
        <thead>
            <tr class="border-b bg-gray-50">
                <th class="py-2 px-2">#</th>
                <th class="px-2">Question</th>
                <th class="px-2">Correct Answer</th>
                <th class="px-2">Selected Answer</th>
            </tr>
        </thead>
        <tbody id="wrongTableBody"></tbody>
    </table>
</div>

</div>

<!-- ==================== FIREBASE + LOGIC ==================== -->
<script>
/* ------------------------------------------------------
   FIREBASE INIT
------------------------------------------------------ */
const firebaseConfig = {
    apiKey: "AIzaSyBGd_KrhvdCfxeRPcXn7f8csLUfcZkmKVs",
    authDomain: "sswt-final.firebaseapp.com",
    projectId: "sswt-final"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let questionBank = [];

/* ------------------------------------------------------
   1) ë¬¸ì œì€í–‰ ë¡œë“œ (exam_questions/current)
------------------------------------------------------ */
async function loadQuestionBank() {
    const doc = await db.collection("exam_questions").doc("current").get();
    const data = doc.data();
    if (!data) return;

    questionBank = data.questions.map(q => ({
        id: q.id,
        text: q.question,
        options: q.options ?? [q.opt1, q.opt2, q.opt3, q.opt4],
        correct: q.answer
    }));
}

/* ------------------------------------------------------
   2) ì œì¶œí•œ í•™ìƒë“¤ ë¶ˆëŸ¬ì˜¤ê¸°
------------------------------------------------------ */
async function loadStudents() {
    const snap = await db.collection("exam_responses").get();
    const table = document.getElementById("studentTableBody");
    table.innerHTML = "";

    snap.forEach(doc => {
        const d = doc.data();
        table.insertAdjacentHTML("beforeend", `
            <tr class="border-b hover:bg-purple-50 cursor-pointer"
                onclick="onStudentClick('${doc.id}')">
                <td class="py-2">${d.studentName}</td>
                <td>${d.studentId}</td>
                <td>${d.score}</td>
                <td>${d.timeUsedSeconds}s</td>
            </tr>
        `);
    });
}

/* ------------------------------------------------------
   3) íŠ¹ì • í•™ìƒ ì‘ë‹µ ë¬¸ì„œ ê°€ì ¸ì˜¤ê¸°
------------------------------------------------------ */
async function getStudentResponse(docId) {
    const doc = await db.collection("exam_responses").doc(docId).get();
    return doc.data();
}

/* ------------------------------------------------------
   4) ì˜¤ë‹µ í‘œì‹œ
------------------------------------------------------ */
function showWrongAnswers(studentData) {
    const tbody = document.getElementById("wrongTableBody");
    tbody.innerHTML = "";

    studentData.answers.forEach((ans, idx) => {
        const q = questionBank.find(q => q.id === ans.qId);
        if (!q) return;

        const correctText = q.options[q.correct];
        const selectedText = q.options[ans.selected] ?? "(no answer)";
        
        if (ans.selected === q.correct) return;  // ì •ë‹µì´ë©´ pass

        tbody.insertAdjacentHTML("beforeend", `
            <tr class="border-b">
                <td class="py-2">${idx + 1}</td>
                <td class="px-2">${q.text}</td>
                <td class="px-2 font-semibold text-green-600">${correctText}</td>
                <td class="px-2 text-red-600">${selectedText}</td>
            </tr>
        `);
    });
}

/* ------------------------------------------------------
   5) í•™ìƒ í´ë¦­ ì‹œ ì‹¤í–‰ë˜ëŠ” í•¨ìˆ˜
------------------------------------------------------ */
async function onStudentClick(docId) {
    await loadQuestionBank();
    const studentData = await getStudentResponse(docId);
    showWrongAnswers(studentData);
}

/* ------------------------------------------------------
   INITIAL LOAD
------------------------------------------------------ */
loadStudents();
</script>

</body>
</html>
