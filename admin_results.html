<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Exam Results</title>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 p-10">

<h1 class="text-3xl font-bold mb-8 text-purple-600 flex items-center">
    <span>ðŸ“Š Student Exam Results</span>
</h1>

<div class="grid grid-cols-1 md:grid-cols-3 gap-10">

<!-- ========== LEFT: STUDENT LIST ========== -->
<div class="bg-white shadow-lg p-6 rounded-xl">
    <h2 class="text-xl font-bold mb-4">Students</h2>

    <table class="w-full text-left text-sm">
        <thead>
            <tr class="border-b">
                <th class="py-2 px-2">Name</th>
                <th>ID</th>
                <th>Score</th>
                <th>Time</th>
            </tr>
        </thead>
        <tbody id="studentTableBody"></tbody>
    </table>
</div>

<!-- ========== RIGHT: SELECTED STUDENT DETAILS ========== -->
<div class="bg-white shadow-lg p-6 rounded-xl md:col-span-2">
    <h2 id="detailsTitle" class="text-xl font-bold mb-4">Studentâ€™s Test Details</h2>

    <table class="w-full text-left text-sm">
        <thead>
            <tr class="border-b bg-gray-50">
                <th class="py-2 px-2">#</th>
                <th class="px-2">Question</th>
                <th class="px-2">Correct Answer</th>
                <th class="px-2">Selected Answer</th>
            </tr>
        </thead>
        <tbody id="detailsTableBody"></tbody>
    </table>
</div>

</div>

<script>
/* ------------------------------------------------------
   FIREBASE INIT
------------------------------------------------------ */
const firebaseConfig = {
    apiKey: "AIzaSyBGd_KrhvdCfxeRPcXn7f8csLUfcZkmKVs",
    authDomain: "sswt-final.firebaseapp.com",
    projectId: "sswt-final"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let selectedRow = null;
let questionBank = [];

/* ------------------------------------------------------
   LOAD QUESTION BANK FOR SPECIFIC EXAM VERSION
------------------------------------------------------ */
async function loadQuestionBank(examVersion) {

    const snap = await db.collection("exam_questions").doc(examVersion).get();
    const data = snap.data();
    if (!data || !data.questions) {
        console.error("âŒ No questions found for exam:", examVersion);
        return [];
    }

    return data.questions.map(q => ({
        qId: q.id,
        text: q.question,
        options: q.options ?? [q.opt1, q.opt2, q.opt3, q.opt4],
        correct: q.answer
    }));
}

/* ------------------------------------------------------
   LOAD STUDENTS LIST
------------------------------------------------------ */
async function loadStudents() {
    const snap = await db.collection("exam_responses").get();
    const table = document.getElementById("studentTableBody");
    table.innerHTML = "";

    snap.forEach(doc => {
        const d = doc.data();
        const tr = document.createElement("tr");

        tr.className = "border-b hover:bg-purple-50 cursor-pointer transition";
        tr.onclick = () => onStudentClick(tr, doc.id);

        tr.innerHTML = `
            <td class="py-2 px-2">${d.studentName ?? "(no name)"}</td>
            <td>${d.studentId}</td>
            <td>${d.score}</td>
            <td>${d.timeUsedSeconds}s</td>
        `;

        table.appendChild(tr);
    });
}

/* ------------------------------------------------------
   LOAD A SINGLE STUDENT RESPONSE
------------------------------------------------------ */
async function getStudentResponse(docId) {
    const doc = await db.collection("exam_responses").doc(docId).get();
    return doc.data();
}

/* ------------------------------------------------------
   SHOW ALL QUESTIONS + MARK CORRECT/WRONG
------------------------------------------------------ */
function showStudentDetails(studentData, questionBank) {

    const tbody = document.getElementById("detailsTableBody");
    tbody.innerHTML = "";

    let correctCount = 0;
    const totalQuestions = studentData.answers.length;

    studentData.answers.forEach((ans, idx) => {
        const q = questionBank.find(q => q.qId === ans.qId);
        if (!q) return;

        const correctAns = q.options[q.correct];
        const selectedAns =
            ans.selected != null ? q.options[ans.selected] : "(no answer)";

        const isCorrect = ans.selected === q.correct;
        if (isCorrect) correctCount++;

        tbody.insertAdjacentHTML(
            "beforeend",
            `
            <tr class="border-b">
                <td class="py-2 px-2">${idx + 1}</td>
                <td class="px-2">${q.text}</td>
                <td class="px-2 font-semibold text-green-600">${correctAns}</td>
                <td class="px-2 font-semibold ${isCorrect ? "text-green-600" : "text-red-600"}">
                    ${selectedAns}
                </td>
            </tr>`
        );
    });

    document.getElementById("detailsTitle").textContent =
        `Studentâ€™s Test Details (${correctCount} / ${totalQuestions})`;
}

/* ------------------------------------------------------
   WHEN A STUDENT IS CLICKED
------------------------------------------------------ */
async function onStudentClick(row, docId) {

    // highlight selected row
    if (selectedRow) selectedRow.classList.remove("bg-purple-100", "border-l-4", "border-purple-600");
    row.classList.add("bg-purple-100", "border-l-4", "border-purple-600");
    selectedRow = row;

    // load student record
    const studentData = await getStudentResponse(docId);

    // find exam version (ex: current, test10, final2025)
    const examVersion = studentData.examDocId || "current";

    // load the correct question bank for that exam
    questionBank = await loadQuestionBank(examVersion);

    // show full details
    showStudentDetails(studentData, questionBank);
}

/* ------------------------------------------------------
   INITIAL LOAD
------------------------------------------------------ */
loadStudents();
</script>

</body>
</html>
