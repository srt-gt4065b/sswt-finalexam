<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹œí—˜ ê²°ê³¼ ë¦¬í¬íŠ¸ ìƒì„±ê¸°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .action-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .action-section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        button {
            padding: 15px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
        }

        .student-list {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
        }

        .student-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .student-item:last-child {
            border-bottom: none;
        }

        .student-info {
            flex: 1;
        }

        .student-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
        }

        .student-details {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #eee;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .log-area {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            margin-top: 20px;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        /* ë¦¬í¬íŠ¸ ë¯¸ë¦¬ë³´ê¸° ìŠ¤íƒ€ì¼ */
        .report-preview {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 30px;
            background: white;
            margin: 20px 0;
            display: none;
        }

        .report-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .report-title {
            font-size: 2em;
            color: #333;
            margin-bottom: 10px;
        }

        .report-subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 30px 0;
        }

        .info-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .info-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .chart-container {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .problem-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 5px;
            margin: 20px 0;
        }

        .problem-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .problem-correct {
            background: #28a745;
            color: white;
        }

        .problem-wrong {
            background: #dc3545;
            color: white;
        }

        .problem-cell:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .explanation-section {
            margin: 30px 0;
        }

        .explanation-item {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .explanation-question {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .explanation-answer {
            color: #dc3545;
            margin: 5px 0;
        }

        .explanation-correct {
            color: #28a745;
            margin: 5px 0;
        }

        .explanation-detail {
            color: #666;
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š ì‹œí—˜ ê²°ê³¼ ë¦¬í¬íŠ¸ ìƒì„±ê¸°</h1>
        <p class="subtitle">í•™ìƒë³„ ì‹œí—˜ ê²°ê³¼ ë¶„ì„ ë° PDF ë¦¬í¬íŠ¸ ìë™ ìƒì„±</p>

        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">ì´ ì‘ì‹œ í•™ìƒ</div>
                <div class="stat-value" id="totalStudents">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">í‰ê·  ì ìˆ˜</div>
                <div class="stat-value" id="avgScore">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ìµœê³  ì ìˆ˜</div>
                <div class="stat-value" id="maxScore">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ìµœì € ì ìˆ˜</div>
                <div class="stat-value" id="minScore">0</div>
            </div>
        </div>

        <!-- ì•¡ì…˜ ë²„íŠ¼ -->
        <div class="action-section">
            <h2>ğŸ¯ ë¦¬í¬íŠ¸ ìƒì„±</h2>
            <div class="button-group">
                <button class="btn-primary" onclick="loadStudents()">
                    ğŸ”„ í•™ìƒ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                </button>
                <button class="btn-success" id="generateAllBtn" onclick="generateAllReports()" disabled>
                    ğŸ“„ ì „ì²´ PDF ìƒì„± (ZIP)
                </button>
                <button class="btn-warning" id="previewBtn" onclick="showPreview()" disabled>
                    ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°
                </button>
            </div>

            <!-- ì§„í–‰ë¥  í‘œì‹œ -->
            <div id="progressContainer" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar">0%</div>
                </div>
            </div>
        </div>

        <!-- í•™ìƒ ëª©ë¡ -->
        <div class="action-section">
            <h2>ğŸ‘¥ ì‘ì‹œ í•™ìƒ ëª©ë¡</h2>
            <div class="student-list" id="studentList">
                <div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ 'í•™ìƒ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
            </div>
        </div>

        <!-- ë¦¬í¬íŠ¸ ë¯¸ë¦¬ë³´ê¸° -->
        <div class="report-preview" id="reportPreview">
            <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
        </div>

        <!-- ë¡œê·¸ ì˜ì—­ -->
        <div class="action-section">
            <h2>ğŸ“ ì‘ì—… ë¡œê·¸</h2>
            <div class="log-area" id="logArea">
                <div class="log-entry">ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ...</div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- FileSaver.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        // âš ï¸ Firebase ì„¤ì •ì„ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”
        const firebaseConfig = {
            apiKey: "AIzaSyBGd_KrhvdCfxeRPcXn7f8csLUfcZkmKVs",
  authDomain: "sswt-final.firebaseapp.com",
  projectId: "sswt-final",
  storageBucket: "sswt-final.firebasestorage.app",
  messagingSenderId: "824707188580",
  appId: "1:824707188580:web:747ba4d91ab781e1a15c71",
  measurementId: "G-VKYGVZCS2T"
        };

        // Firebase ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let studentsData = [];
        let questionsData = {};

        // ë¡œê·¸ ì¶”ê°€
        function addLog(message) {
            const logArea = document.getElementById('logArea');
            const time = new Date().toLocaleTimeString('ko-KR');
            logArea.innerHTML += `<div class="log-entry">[${time}] ${message}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        // í•™ìƒ ë°ì´í„° ë¡œë“œ
        async function loadStudents() {
            addLog('ğŸ“¥ í•™ìƒ ë°ì´í„° ë¡œë”© ì‹œì‘...');
            const studentList = document.getElementById('studentList');
            studentList.innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            try {
                // exam_responsesì—ì„œ í•™ìƒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const responsesSnapshot = await db.collection('exam_responses').get();
                studentsData = [];

                responsesSnapshot.forEach(doc => {
                    const data = doc.data();
                    studentsData.push({
                        id: doc.id,
                        studentId: data.studentId || '-',
                        studentName: data.studentName || '-',
                        score: data.score || 0,
                        startedAt: data.startedAt || null,
                        timeUsedSeconds: data.timeUsedSeconds || 0,
                        totalQuestions: data.totalQuestions || 100,
                        correctAnswers: data.correctAnswers || {},
                        userAnswers: data.userAnswers || {}
                    });
                });

                // exam_questionsì—ì„œ ë¬¸ì œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const questionsSnapshot = await db.collection('exam_questions').get();
                questionsSnapshot.forEach(doc => {
                    const data = doc.data();
                    questionsData[doc.id] = data;
                });

                // í†µê³„ ê³„ì‚°
                if(studentsData.length > 0) {
                    const scores = studentsData.map(s => s.score);
                    const avgScore = (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1);
                    const maxScore = Math.max(...scores);
                    const minScore = Math.min(...scores);

                    document.getElementById('totalStudents').textContent = studentsData.length;
                    document.getElementById('avgScore').textContent = avgScore;
                    document.getElementById('maxScore').textContent = maxScore;
                    document.getElementById('minScore').textContent = minScore;
                }

                // í•™ìƒ ëª©ë¡ í‘œì‹œ
                displayStudentList();

                // ë²„íŠ¼ í™œì„±í™”
                document.getElementById('generateAllBtn').disabled = false;
                document.getElementById('previewBtn').disabled = false;

                addLog(`âœ… ${studentsData.length}ëª…ì˜ í•™ìƒ ë°ì´í„° ë¡œë“œ ì™„ë£Œ`);
                addLog(`âœ… ${Object.keys(questionsData).length}ê°œì˜ ì‹œí—˜ ë¬¸ì œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ`);
            } catch (error) {
                addLog(`âŒ ì˜¤ë¥˜: ${error.message}`);
                studentList.innerHTML = '<div class="loading">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>';
            }
        }

        // í•™ìƒ ëª©ë¡ í‘œì‹œ
        function displayStudentList() {
            const studentList = document.getElementById('studentList');
            
            if(studentsData.length === 0) {
                studentList.innerHTML = '<div class="loading">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            studentList.innerHTML = studentsData.map((student, index) => {
                const time = student.startedAt ? new Date(student.startedAt).toLocaleString('ko-KR') : '-';
                const percentage = ((student.score / student.totalQuestions) * 100).toFixed(1);
                
                return `
                    <div class="student-item">
                        <div class="student-info">
                            <div class="student-name">${index + 1}. ${student.studentName} (${student.studentId})</div>
                            <div class="student-details">
                                ì ìˆ˜: ${student.score}/${student.totalQuestions} (${percentage}%) | 
                                ì‹œê°„: ${Math.floor(student.timeUsedSeconds / 60)}ë¶„ ${student.timeUsedSeconds % 60}ì´ˆ | 
                                ì‘ì‹œ: ${time}
                            </div>
                        </div>
                        <button class="btn-primary" onclick="generateSingleReport(${index})" style="padding: 8px 16px; font-size: 0.9em;">
                            ğŸ“„ PDF
                        </button>
                    </div>
                `;
            }).join('');
        }

        // ë¦¬í¬íŠ¸ ë¯¸ë¦¬ë³´ê¸°
        function showPreview() {
            if(studentsData.length === 0) {
                alert('í•™ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const student = studentsData[0];
            const previewDiv = document.getElementById('reportPreview');
            
            previewDiv.innerHTML = generateReportHTML(student);
            previewDiv.style.display = 'block';
            
            // ì°¨íŠ¸ ìƒì„±
            createCharts(student);
            
            addLog('ğŸ‘ï¸ ì²« ë²ˆì§¸ í•™ìƒ ë¦¬í¬íŠ¸ ë¯¸ë¦¬ë³´ê¸°');
        }

        // ë¦¬í¬íŠ¸ HTML ìƒì„±
        function generateReportHTML(student) {
            const percentage = ((student.score / student.totalQuestions) * 100).toFixed(1);
            const time = student.startedAt ? new Date(student.startedAt).toLocaleString('ko-KR') : '-';
            const wrongCount = student.totalQuestions - student.score;
            
            // í‹€ë¦° ë¬¸ì œ ì°¾ê¸°
            const wrongProblems = [];
            for(let i = 0; i < student.totalQuestions; i++) {
                if(student.correctAnswers[i] !== 0) {
                    wrongProblems.push(i);
                }
            }

            let html = `
                <div class="report-header">
                    <div class="report-title">ğŸ“Š ì‹œí—˜ ê²°ê³¼ ë¦¬í¬íŠ¸</div>
                    <div class="report-subtitle">ê°œì¸ë³„ ì„±ì  ë¶„ì„ ë° ì˜¤ë‹µ í•´ì„¤</div>
                </div>

                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">í•™ë²ˆ</div>
                        <div class="info-value">${student.studentId}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ì´ë¦„</div>
                        <div class="info-value">${student.studentName}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ì ìˆ˜</div>
                        <div class="info-value">${student.score} / ${student.totalQuestions}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ì •ë‹µë¥ </div>
                        <div class="info-value">${percentage}%</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ì†Œìš” ì‹œê°„</div>
                        <div class="info-value">${Math.floor(student.timeUsedSeconds / 60)}ë¶„ ${student.timeUsedSeconds % 60}ì´ˆ</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ì‘ì‹œ ì‹œê°„</div>
                        <div class="info-value">${time}</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 style="margin-bottom: 15px;">ğŸ“ˆ ì ìˆ˜ ë¶„ì„</h3>
                    <canvas id="scoreChart" width="400" height="200"></canvas>
                </div>

                <div style="margin: 30px 0;">
                    <h3 style="margin-bottom: 15px;">ğŸ¯ ë¬¸ì œë³„ ì •ì˜¤ë‹µ í˜„í™© (ì´ ${student.totalQuestions}ë¬¸ì œ)</h3>
                    <div class="problem-grid">
            `;

            // ë¬¸ì œë³„ ì •ì˜¤ë‹µ ê·¸ë¦¬ë“œ
            for(let i = 0; i < student.totalQuestions; i++) {
                const isCorrect = student.correctAnswers[i] === 0;
                const className = isCorrect ? 'problem-correct' : 'problem-wrong';
                html += `<div class="problem-cell ${className}" title="ë¬¸ì œ ${i + 1}">${i + 1}</div>`;
            }

            html += `
                    </div>
                </div>

                <div class="explanation-section">
                    <h3 style="margin-bottom: 15px;">âŒ ì˜¤ë‹µ ë¶„ì„ (${wrongCount}ê°œ)</h3>
            `;

            if(wrongProblems.length === 0) {
                html += '<p style="text-align: center; padding: 30px; color: #28a745; font-size: 1.2em;">ğŸ‰ ëª¨ë“  ë¬¸ì œë¥¼ ë§í˜”ìŠµë‹ˆë‹¤!</p>';
            } else {
                // í‹€ë¦° ë¬¸ì œ ì¤‘ ì¼ë¶€ë§Œ í‘œì‹œ (ì¤‘ìš” ë¬¸ì œ)
                const importantWrong = wrongProblems.slice(0, Math.min(10, wrongProblems.length));
                
                importantWrong.forEach(problemNum => {
                    const userAnswer = student.userAnswers[problemNum] || '-';
                    html += `
                        <div class="explanation-item">
                            <div class="explanation-question">ğŸ“Œ ë¬¸ì œ ${problemNum + 1}</div>
                            <div class="explanation-answer">âŒ ì„ íƒí•œ ë‹µ: ${userAnswer}</div>
                            <div class="explanation-correct">âœ… ì •ë‹µ: (ë¬¸ì œ ë°ì´í„°ì—ì„œ ê°€ì ¸ì˜¤ê¸°)</div>
                            <div class="explanation-detail">
                                <strong>ğŸ’¡ í•´ì„¤:</strong><br>
                                ì´ ë¬¸ì œëŠ” [ê°œë…]ì— ëŒ€í•œ ë¬¸ì œì…ë‹ˆë‹¤. [ìƒì„¸ í•´ì„¤ ë‚´ìš©]
                            </div>
                        </div>
                    `;
                });

                if(wrongProblems.length > 10) {
                    html += `<p style="text-align: center; color: #666; margin-top: 20px;">ë‚˜ë¨¸ì§€ ${wrongProblems.length - 10}ê°œì˜ í‹€ë¦° ë¬¸ì œëŠ” PDFì—ì„œ í™•ì¸í•˜ì„¸ìš”.</p>`;
                }
            }

            html += `
                </div>
            `;

            return html;
        }

        // ì°¨íŠ¸ ìƒì„±
        function createCharts(student) {
            const ctx = document.getElementById('scoreChart');
            if(!ctx) return;

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ì •ë‹µ', 'ì˜¤ë‹µ'],
                    datasets: [{
                        label: 'ë¬¸ì œ ìˆ˜',
                        data: [student.score, student.totalQuestions - student.score],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(220, 53, 69, 0.8)'
                        ],
                        borderColor: [
                            'rgba(40, 167, 69, 1)',
                            'rgba(220, 53, 69, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 10
                            }
                        }
                    }
                }
            });
        }

        // ë‹¨ì¼ í•™ìƒ PDF ìƒì„±
        async function generateSingleReport(index) {
            const student = studentsData[index];
            addLog(`ğŸ“„ ${student.studentName} í•™ìƒì˜ ë¦¬í¬íŠ¸ ìƒì„± ì¤‘...`);

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // í•œê¸€ í°íŠ¸ ë¬¸ì œë¡œ ì˜ë¬¸ìœ¼ë¡œ ì‘ì„±í•˜ê±°ë‚˜, ì´ë¯¸ì§€ë¡œ ë³€í™˜ í•„ìš”
                // ê°„ë‹¨í•œ í…ìŠ¤íŠ¸ ë¦¬í¬íŠ¸ ìƒì„±
                doc.setFontSize(20);
                doc.text('Exam Report', 105, 20, { align: 'center' });
                
                doc.setFontSize(12);
                doc.text(`Student ID: ${student.studentId}`, 20, 40);
                doc.text(`Name: ${student.studentName}`, 20, 50);
                doc.text(`Score: ${student.score} / ${student.totalQuestions}`, 20, 60);
                doc.text(`Percentage: ${((student.score / student.totalQuestions) * 100).toFixed(1)}%`, 20, 70);
                doc.text(`Time Used: ${Math.floor(student.timeUsedSeconds / 60)}min ${student.timeUsedSeconds % 60}sec`, 20, 80);

                // í‹€ë¦° ë¬¸ì œ ëª©ë¡
                doc.text('Wrong Answers:', 20, 100);
                let yPos = 110;
                for(let i = 0; i < student.totalQuestions; i++) {
                    if(student.correctAnswers[i] !== 0) {
                        doc.text(`Problem ${i + 1}: Your answer - ${student.userAnswers[i] || 'N/A'}`, 30, yPos);
                        yPos += 10;
                        if(yPos > 280) {
                            doc.addPage();
                            yPos = 20;
                        }
                    }
                }

                // PDF ì €ì¥
                doc.save(`${student.studentId}_${student.studentName}_report.pdf`);
                addLog(`âœ… ${student.studentName} í•™ìƒ ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ`);
            } catch (error) {
                addLog(`âŒ PDF ìƒì„± ì‹¤íŒ¨: ${error.message}`);
            }
        }

        // ì „ì²´ í•™ìƒ ë¦¬í¬íŠ¸ ìƒì„± ë° ZIP ë‹¤ìš´ë¡œë“œ
        async function generateAllReports() {
            if(studentsData.length === 0) {
                alert('í•™ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            addLog('ğŸ“¦ ì „ì²´ í•™ìƒ ë¦¬í¬íŠ¸ ìƒì„± ì‹œì‘...');
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('generateAllBtn').disabled = true;

            try {
                const zip = new JSZip();
                const { jsPDF } = window.jspdf;

                for(let i = 0; i < studentsData.length; i++) {
                    const student = studentsData[i];
                    const progress = ((i + 1) / studentsData.length * 100).toFixed(0);
                    
                    // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
                    const progressBar = document.getElementById('progressBar');
                    progressBar.style.width = progress + '%';
                    progressBar.textContent = progress + '%';

                    addLog(`ğŸ“„ ${i + 1}/${studentsData.length} - ${student.studentName} ì²˜ë¦¬ ì¤‘...`);

                    // PDF ìƒì„±
                    const doc = new jsPDF();
                    
                    doc.setFontSize(20);
                    doc.text('Exam Report', 105, 20, { align: 'center' });
                    
                    doc.setFontSize(12);
                    doc.text(`Student ID: ${student.studentId}`, 20, 40);
                    doc.text(`Name: ${student.studentName}`, 20, 50);
                    doc.text(`Score: ${student.score} / ${student.totalQuestions}`, 20, 60);
                    doc.text(`Percentage: ${((student.score / student.totalQuestions) * 100).toFixed(1)}%`, 20, 70);
                    doc.text(`Time: ${Math.floor(student.timeUsedSeconds / 60)}m ${student.timeUsedSeconds % 60}s`, 20, 80);

                    // í‹€ë¦° ë¬¸ì œ
                    doc.text('Wrong Answers:', 20, 100);
                    let yPos = 110;
                    for(let j = 0; j < student.totalQuestions; j++) {
                        if(student.correctAnswers[j] !== 0) {
                            doc.text(`Q${j + 1}: ${student.userAnswers[j] || 'N/A'}`, 30, yPos);
                            yPos += 10;
                            if(yPos > 280) {
                                doc.addPage();
                                yPos = 20;
                            }
                        }
                    }

                    // PDFë¥¼ blobìœ¼ë¡œ ë³€í™˜í•˜ì—¬ ZIPì— ì¶”ê°€
                    const pdfBlob = doc.output('blob');
                    zip.file(`${student.studentId}_${student.studentName}.pdf`, pdfBlob);
                }

                // ZIP íŒŒì¼ ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
                addLog('ğŸ“¦ ZIP íŒŒì¼ ìƒì„± ì¤‘...');
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                saveAs(zipBlob, `exam_reports_${new Date().toISOString().split('T')[0]}.zip`);
                
                addLog(`âœ… ì „ì²´ ${studentsData.length}ê°œ ë¦¬í¬íŠ¸ ZIP ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!`);
            } catch (error) {
                addLog(`âŒ ì˜¤ë¥˜: ${error.message}`);
            } finally {
                document.getElementById('progressContainer').style.display = 'none';
                document.getElementById('generateAllBtn').disabled = false;
            }
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ
        window.onload = function() {
            addLog('ğŸš€ ì‹œí—˜ ê²°ê³¼ ë¦¬í¬íŠ¸ ìƒì„±ê¸° ì‹œì‘');
        };
    </script>
</body>
</html>
