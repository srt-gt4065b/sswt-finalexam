<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Statistics with SW Tools - 2025 Fall Final Exam</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-slate-100 flex items-center justify-center p-4 select-none">

  <!-- ===========================
       LOGIN SCREEN
  ============================ -->
  <div id="loginScreen"
       class="w-full max-w-xl bg-white rounded-2xl shadow-2xl p-6 space-y-6">

    <div>
      <h1 class="text-2xl md:text-3xl font-bold text-purple-700 mb-1">
        Statistics with SW Tools - 2025 Fall Final Exam
      </h1>
      <p class="text-sm text-gray-600">
        Please enter your name and student ID to begin.
      </p>
    </div>

    <div class="space-y-4">
      <div>
        <label for="studentName" class="block text-sm font-semibold text-gray-700 mb-1">
          Name
        </label>
        <input id="studentName"
               type="text"
               class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:outline-none" />
      </div>

      <div>
        <label for="studentId" class="block text-sm font-semibold text-gray-700 mb-1">
          Student ID
        </label>
        <input id="studentId"
               type="text"
               class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:outline-none" />
      </div>
    </div>

    <div class="pt-2">
      <button onclick="openInstructions()"
              class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-xl">
        Continue to Instructions
      </button>
    </div>

    <p class="text-xs text-gray-500">
      You will have <span class="font-semibold">35 minutes</span> to answer all questions.
      Once you start, you cannot pause or restart the exam.
    </p>
  </div>

  <!-- ===========================
       INSTRUCTIONS MODAL
  ============================ -->
  <div id="instructionModal"
       class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 hidden">
    <div class="bg-white max-w-2xl w-full mx-4 p-6 rounded-2xl shadow-2xl space-y-4">
      <h2 class="text-2xl font-bold text-purple-700">
        Final Exam Instructions
      </h2>

      <p class="text-sm text-gray-700">
        This exam is part of <span class="font-semibold">‚ÄúStatistics with SW Tools‚Äù</span>.
        The exam consists of multiple-choice questions drawn from the course topics.
        Please read the instructions carefully before starting.
      </p>

      <ul class="list-disc pl-5 space-y-2 text-sm text-gray-700">
        <li>Total exam time is <span class="font-semibold">35 minutes</span> (no pause or restart).</li>
        <li>Only <span class="font-semibold">one attempt per student</span> is allowed. Re-taking is not possible under any circumstances.</li>
        <li>Questions will appear <span class="font-semibold">one at a time</span>. After you move to the next question, you cannot go back.</li>
        <li>Question order is <span class="font-semibold">randomized</span> for each student.</li>
        <li>Do not use AI tools or share questions/answers with others.</li>
      </ul>

      <div class="flex items-center gap-2 mt-4">
        <input id="agreeCheck" type="checkbox"
               class="w-4 h-4 border-gray-400 rounded" />
        <label for="agreeCheck" class="text-sm text-gray-700">
          I have read and understood the instructions, and I agree to take this exam honestly.
        </label>
      </div>

      <div class="flex justify-end gap-2 pt-2">
        <button onclick="closeInstructions()"
                class="px-4 py-2 rounded-lg border border-gray-300 text-sm">
          Cancel
        </button>
        <button onclick="beginExamFromModal()"
                class="px-5 py-2 rounded-lg bg-purple-600 hover:bg-purple-700 text-white text-sm font-bold">
          Start Exam
        </button>
      </div>
    </div>
  </div>

  <!-- ===========================
       EXAM SCREEN
  ============================ -->
  <div id="examScreen" class="hidden w-full max-w-4xl mx-auto">

    <!-- Header -->
    <div class="w-full bg-white rounded-xl shadow-lg p-4 mb-4 flex justify-between items-center">
      <div>
        <h2 id="examStudentInfo" class="text-lg font-bold"></h2>
        <p class="text-xs text-gray-600">
          Statistics with SW Tools - 2025 Fall Final Exam
        </p>
      </div>

      <div class="text-right">
        <div class="text-xs text-gray-500">Time Remaining</div>
        <div id="timeLeft" class="text-3xl font-bold text-purple-600">35:00</div>
      </div>
    </div>

    <!-- Question Card -->
    <div class="bg-white rounded-2xl shadow-xl p-6 w-full mb-6">
      <h3 id="questionNumber" class="text-lg font-bold mb-3">
        Question
      </h3>

      <p id="questionText" class="text-gray-800 mb-6 text-base leading-relaxed">
        Loading question...
      </p>

      <div class="space-y-3">
        <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-purple-50">
          <input type="radio" name="choice" value="0" class="w-4 h-4" />
          <span id="opt1label" class="text-gray-800 text-sm">Option 1</span>
        </label>
        <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-purple-50">
          <input type="radio" name="choice" value="1" class="w-4 h-4" />
          <span id="opt2label" class="text-gray-800 text-sm">Option 2</span>
        </label>
        <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-purple-50">
          <input type="radio" name="choice" value="2" class="w-4 h-4" />
          <span id="opt3label" class="text-gray-800 text-sm">Option 3</span>
        </label>
        <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-purple-50">
          <input type="radio" name="choice" value="3" class="w-4 h-4" />
          <span id="opt4label" class="text-gray-800 text-sm">Option 4</span>
        </label>
      </div>

      <div class="flex justify-end mt-6">
        <button onclick="nextQuestion()"
                class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded-lg">
          Next ‚Üí
        </button>
      </div>
    </div>
  </div>

  <!-- ===========================
       FINISH SCREEN
  ============================ -->
  <div id="finishScreen" class="hidden w-full max-w-xl mx-auto">
    <div class="bg-white rounded-2xl shadow-2xl p-8 text-center space-y-4">
      <h2 class="text-2xl font-bold text-purple-700">üéâ Exam Submitted</h2>
      <p class="text-sm text-gray-700">
        Your responses have been saved. Thank you for completing the exam.
      </p>
      <p class="text-lg text-gray-800">
        Your raw score (number of correct answers):
      </p>
      <div id="finalScore" class="text-4xl font-extrabold text-purple-600">0</div>

      <button onclick="location.reload()"
              class="mt-4 px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-xl">
        Return to Start
      </button>
    </div>
  </div>

  <!-- ===========================
       FIREBASE & EXAM LOGIC
  ============================ -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    // =====================
    // FIREBASE INIT
    // =====================
    const firebaseConfig = {
      apiKey: "AIzaSyBGd_KrhvdCfxeRPcXn7f8csLUfcZkmKVs",
      authDomain: "sswt-final.firebaseapp.com",
      projectId: "sswt-final",
      storageBucket: "sswt-final.firebasestorage.app",
      messagingSenderId: "824707188580",
      appId: "1:824707188580:web:747ba4d91ab781e1a15c71"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // =====================
    // GLOBAL STATE
    // =====================
    const TOTAL_TIME = 35 * 60; // 35 minutes
    const EXAM_DOC_ID = "current";

    let questions = [];
    let answers = [];
    let currentIndex = 0;
    let examTimerId = null;

    let studentName = "";
    let studentId = "";

    // =====================
    // UTILS
    // =====================
    function shuffle(arr) {
      const a = [...arr];
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    // =====================
    // LOGIN / INSTRUCTIONS
    // =====================
    function openInstructions() {
      const name = document.getElementById("studentName").value.trim();
      const id = document.getElementById("studentId").value.trim();

      if (!name || !id) {
        alert("Please enter both your name and student ID.");
        return;
      }
      studentName = name;
      studentId = id;

      document.getElementById("instructionModal").classList.remove("hidden");
    }

    function closeInstructions() {
      document.getElementById("instructionModal").classList.add("hidden");
    }

    async function beginExamFromModal() {
      const agree = document.getElementById("agreeCheck").checked;
      if (!agree) {
        alert("You must confirm that you have read and understood the instructions.");
        return;
      }

      // Ïû¨ÏùëÏãú Ïó¨Î∂Ä ÌôïÏù∏
      const canTake = await verifyAttempt(studentId);
      if (!canTake) {
        alert("You have already taken this exam. Retake is not allowed.");
        return;
      }

      document.getElementById("instructionModal").classList.add("hidden");
      await startExam();
    }

    // =====================
    // FIRESTORE HELPERS
    // =====================
    async function verifyAttempt(id) {
      try {
        const snap = await db.collection("exam_responses").doc(id).get();
        return !snap.exists;
      } catch (err) {
        console.error("Error checking attempt:", err);
        // Î¨∏Ï†úÍ∞Ä ÏûàÏñ¥ÎèÑ ÏãúÌóòÏùÄ Î≥º Ïàò ÏûàÍ≤å true Î∞òÌôò
        return true;
      }
    }

    async function loadQuestions(docId = EXAM_DOC_ID) {
      try {
        const snap = await db.collection("exam_questions").doc(docId).get();
        if (!snap.exists) {
          alert("Exam questions not found. Please contact your instructor.");
          return false;
        }

        const data = snap.data();
        let raw = data.questions || [];
        questions = Array.isArray(raw) ? raw : Object.values(raw);

        if (!questions.length) {
          alert("No questions are available in the exam set.");
          return false;
        }
        return true;
      } catch (err) {
        console.error("Error loading questions:", err);
        alert("Failed to load exam questions.");
        return false;
      }
    }

    // =====================
    // EXAM FLOW
    // =====================
    async function startExam() {
      const loaded = await loadQuestions(EXAM_DOC_ID);
      if (!loaded) return;

      questions = shuffle(questions);
      answers = new Array(questions.length).fill(null);
      currentIndex = 0;

      // UI Ï†ÑÌôò
      document.getElementById("loginScreen").classList.add("hidden");
      document.getElementById("examScreen").classList.remove("hidden");
      document.getElementById("examStudentInfo").textContent =
        `${studentName} (${studentId})`;

      startTimer();
      showQuestion();
    }

    function startTimer() {
      let remaining = TOTAL_TIME;

      if (examTimerId) clearInterval(examTimerId);

      examTimerId = setInterval(() => {
        remaining--;

        const mm = String(Math.floor(remaining / 60)).padStart(2, "0");
        const ss = String(remaining % 60).padStart(2, "0");
        document.getElementById("timeLeft").textContent = `${mm}:${ss}`;

        if (remaining <= 0) {
          clearInterval(examTimerId);
          finishExam();
        }
      }, 1000);
    }

    function showQuestion() {
      const q = questions[currentIndex];
      if (!q) return;

      document.getElementById("questionNumber").textContent =
        `Question ${currentIndex + 1} of ${questions.length}`;
      document.getElementById("questionText").textContent = q.text || "";

      const opts = q.options || ["", "", "", ""];

      document.getElementById("opt1label").textContent = opts[0] || "";
      document.getElementById("opt2label").textContent = opts[1] || "";
      document.getElementById("opt3label").textContent = opts[2] || "";
      document.getElementById("opt4label").textContent = opts[3] || "";

      // Í∏∞Ï°¥ ÏÑ†ÌÉù Î≥µÏõê
      const saved = answers[currentIndex];
      document.querySelectorAll("input[name='choice']").forEach(r => {
        r.checked = (parseInt(r.value, 10) === saved);
      });
    }

    function nextQuestion() {
      const selected = document.querySelector("input[name='choice']:checked");
      if (!selected) {
        alert("Please select an answer before moving on.");
        return;
      }

      answers[currentIndex] = parseInt(selected.value, 10);

      // ÏÑ†ÌÉù Ï¥àÍ∏∞Ìôî
      document.querySelectorAll("input[name='choice']").forEach(r => {
        r.checked = false;
      });

      currentIndex++;
      if (currentIndex >= questions.length) {
        finishExam();
        return;
      }
      showQuestion();
    }

    async function finishExam() {
      if (examTimerId) clearInterval(examTimerId);

      let score = 0;
      for (let i = 0; i < questions.length; i++) {
        const correct = typeof questions[i].answer === "number"
          ? questions[i].answer
          : parseInt(questions[i].answer || 0, 10);

        if (answers[i] === correct) score++;
      }

      const payload = {
        studentId,
        name: studentName,
        score,
        totalQuestions: questions.length,
        selectedAnswers: answers,
        correctAnswers: questions.map(q =>
          typeof q.answer === "number" ? q.answer : parseInt(q.answer || 0, 10)
        ),
        examVersion: EXAM_DOC_ID,
        submittedAt: new Date().toISOString()
      };

      try {
        await db.collection("exam_responses").doc(studentId).set(payload);
      } catch (err) {
        console.error("Error saving responses:", err);
        alert("There was a problem saving your answers, but the exam will now end.");
      }

      document.getElementById("examScreen").classList.add("hidden");
      document.getElementById("finishScreen").classList.remove("hidden");
      document.getElementById("finalScore").textContent = score;
    }
  </script>
</body>
</html>