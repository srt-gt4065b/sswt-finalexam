<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistics Challenge 2025</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        /* ì‚¼ì„± í—¬ìŠ¤ ìŠ¤íƒ€ì¼ ê·¸ë¼ë””ì–¸íŠ¸ */
        .health-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        /* í”„ë¡œê·¸ë ˆìŠ¤ ë°” ì• ë‹ˆë©”ì´ì…˜ */
        @keyframes fillProgress {
            from { width: 0%; }
        }
        
        .progress-fill {
            animation: fillProgress 1s ease-out;
        }
        
        /* ë ˆë²¨ ë±ƒì§€ */
        .level-badge {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        /* íƒ€ì´ë¨¸ ê¹œë¹¡ì„ */
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0.5; }
        }
        
        .timer-warning {
            animation: blink 1s infinite;
        }
        
        /* ì°¨íŠ¸ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .chart-container {
            max-width: 600px;
            margin: 20px auto;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .chart-container img {
            width: 100%;
            height: auto;
            border-radius: 4px;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold mb-2 health-gradient bg-clip-text text-transparent">
                    Statistics Challenge
                </h1>
                <p class="text-gray-600">2025 í†µê³„í•™ ì˜¨ë¼ì¸ ì‹œí—˜</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì´ë¦„</label>
                    <input type="text" id="studentName" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                           placeholder="í™ê¸¸ë™">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">í•™ë²ˆ</label>
                    <input type="text" id="studentId" 
                           class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"
                           placeholder="20241234">
                </div>
                
                <div class="flex gap-3">
                    <button onclick="startExam('practice')" 
                            class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                        ì—°ìŠµ ëª¨ë“œ ì‹œì‘
                    </button>
                    <button onclick="startExam('real')" 
                            class="flex-1 health-gradient text-white font-bold py-3 px-6 rounded-lg hover:opacity-90 transition duration-200">
                        ì‹¤ì „ ì‹œí—˜ ì‹œì‘
                    </button>
                </div>
            </div>
            
            <div class="mt-6 text-center text-sm text-gray-500">
                <p>ğŸ’¡ ì—°ìŠµ ëª¨ë“œ: ë¬´ì œí•œ ì¬ì‘ì‹œ ê°€ëŠ¥</p>
                <p>ğŸ¯ ì‹¤ì „ ëª¨ë“œ: 1íšŒ ì‘ì‹œ ì œí•œ</p>
            </div>
            
            <div class="mt-6 text-center">
                <button onclick="viewMyData()" 
                        class="text-purple-600 hover:text-purple-700 font-semibold text-sm underline">
                    ğŸ“Š ë‚´ ê°œì¸í™” ë°ì´í„° í™•ì¸í•˜ê¸°
                </button>
            </div>
        </div>
    </div>
    
    <!-- ì‹œí—˜ í™”ë©´ -->
    <div id="examScreen" class="hidden min-h-screen p-4">
        <!-- í—¤ë” -->
        <div class="bg-white rounded-lg shadow-lg p-4 mb-4 sticky top-4 z-10">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold" id="studentInfo"></h2>
                    <p class="text-sm text-gray-600" id="modeInfo"></p>
                </div>
                <div class="text-right">
                    <div class="text-3xl font-bold text-purple-600" id="timer">00:00</div>
                    <p class="text-sm text-gray-600">ë‚¨ì€ ì‹œê°„</p>
                </div>
            </div>
        </div>
        
        <!-- ë¬¸ì œ ì˜ì—­ -->
        <div id="questionsContainer" class="space-y-6 mb-6"></div>
        
        <!-- ì œì¶œ ë²„íŠ¼ -->
        <div class="text-center mb-8">
            <button onclick="submitExam()" 
                    class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-8 rounded-lg text-lg transition duration-200">
                ì‹œí—˜ ì œì¶œí•˜ê¸°
            </button>
        </div>
    </div>
    
    <!-- ë‚´ ë°ì´í„° í™•ì¸ ëª¨ë‹¬ -->
    <div id="myDataModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-purple-600">ğŸ“Š ë‚´ ê°œì¸í™” ë°ì´í„°</h2>
                <button onclick="closeMyDataModal()" 
                        class="text-gray-500 hover:text-gray-700 text-3xl leading-none">
                    Ã—
                </button>
            </div>
            
            <div id="myDataContent"></div>
            
            <div class="flex gap-3 mt-6">
                <button onclick="downloadMyDataCSV()" 
                        class="flex-1 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                    ğŸ“¥ CSV ë‹¤ìš´ë¡œë“œ
                </button>
                <button onclick="closeMyDataModal()" 
                        class="flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
                    ë‹«ê¸°
                </button>
            </div>
        </div>
    </div>
    
    <!-- ê²°ê³¼ í™”ë©´ -->
    <div id="resultScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-2xl w-full">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4">ğŸ‰</div>
                <h2 class="text-3xl font-bold mb-2">ì‹œí—˜ ì™„ë£Œ!</h2>
                <p class="text-gray-600">ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤</p>
            </div>
            
            <div id="resultContent" class="space-y-4"></div>
            
            <div class="text-center mt-8">
                <button onclick="location.reload()" 
                        class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-8 rounded-lg transition duration-200">
                    ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ê¸°
                </button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // Firebase ì„¤ì •
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyBGd_KrhvdCfxeRPcXn7f8csLUfcZkmKVs",
  authDomain: "sswt-final.firebaseapp.com",
  projectId: "sswt-final",
  storageBucket: "sswt-final.firebasestorage.app",
  messagingSenderId: "824707188580",
  appId: "1:824707188580:web:747ba4d91ab781e1a15c71",
  measurementId: "G-VKYGVZCS2T"
        };

        // Firebase ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ============================================
        // ì „ì—­ ë³€ìˆ˜
        // ============================================
        let currentMode = '';
        let studentData = {};
        let questions = [];
        let examStartTime = null;
        let timerInterval = null;
        let timeLimit = 0; // ì´ˆ ë‹¨ìœ„

        // ============================================
        // Seed Random (í•™ë²ˆ ê¸°ë°˜ ë‚œìˆ˜ ìƒì„±)
        // ============================================
        function seedRandom(seed) {
            let x = Math.sin(seed++) * 10000;
            return x - Math.floor(x);
        }

        // ============================================
        // í•™ìƒ ë°ì´í„° ìƒì„± (ê°œì¸í™”)
        // ============================================
        function generateStudentData(studentId) {
            const seed = parseInt(studentId) || 12345;
            const scores = [];
            
            // 20íšŒ Galaga í”Œë ˆì´ ì ìˆ˜ ìƒì„±
            for (let i = 0; i < 20; i++) {
                const score = Math.floor(seedRandom(seed + i) * 50000) + 10000;
                scores.push(score);
            }
            
            const first5 = scores.slice(0, 5);
            const last5 = scores.slice(15, 20);
            const sum = scores.reduce((a, b) => a + b, 0);
            const avg = sum / scores.length;
            const variance = scores.reduce((sum, score) => sum + Math.pow(score - avg, 2), 0) / scores.length;
            const stdDev = Math.sqrt(variance);
            
            return {
                scores: scores,
                first5Scores: first5.join(', '),
                last5Scores: last5.join(', '),
                first5Avg: (first5.reduce((a, b) => a + b, 0) / 5).toFixed(2),
                last5Avg: (last5.reduce((a, b) => a + b, 0) / 5).toFixed(2),
                maxScore: Math.max(...scores),
                minScore: Math.min(...scores),
                avgScore: avg.toFixed(2),
                stdDev: stdDev.toFixed(2),
                randomNum1: Math.floor(seedRandom(seed + 100) * 300) + 600,
                randomNum2: Math.floor(seedRandom(seed + 200) * 100) + 150,
                randomNum3: Math.floor(seedRandom(seed + 300) * 50) + 20,
                randomPValue: (seedRandom(seed + 400) * 0.1).toFixed(3)
            };
        }

        // ============================================
        // ë³€ìˆ˜ ì¹˜í™˜
        // ============================================
        function replaceVariables(text, data) {
            if (!text) return text;
            let result = text;
            Object.keys(data).forEach(key => {
                const regex = new RegExp(`\\{${key}\\}`, 'g');
                result = result.replace(regex, data[key]);
            });
            return result;
        }

        // ============================================
        // ì°¨íŠ¸ ìƒì„± (Canvas â†’ Base64)
        // ============================================
        function generateChartImage(chartType, data) {
            const canvas = document.createElement('canvas');
            canvas.width = 600;
            canvas.height = 400;
            const ctx = canvas.getContext('2d');
            
            // ë°°ê²½
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, 600, 400);
            
            const scores = data.scores;
            
            if (chartType === 'histogram') {
                drawHistogram(ctx, scores);
            } else if (chartType === 'scatter') {
                drawScatterPlot(ctx, scores);
            } else if (chartType === 'boxplot') {
                drawBoxPlot(ctx, scores);
            } else if (chartType === 'residual') {
                drawResidualPlot(ctx, scores);
            }
            
            return canvas.toDataURL();
        }

        function drawHistogram(ctx, scores) {
            const bins = 8;
            const min = Math.min(...scores);
            const max = Math.max(...scores);
            const binWidth = (max - min) / bins;
            const freq = new Array(bins).fill(0);
            
            scores.forEach(score => {
                const binIndex = Math.min(Math.floor((score - min) / binWidth), bins - 1);
                freq[binIndex]++;
            });
            
            const maxFreq = Math.max(...freq);
            const barWidth = 500 / bins;
            const maxHeight = 300;
            
            ctx.fillStyle = 'rgba(102, 126, 234, 0.7)';
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2;
            
            freq.forEach((f, i) => {
                const barHeight = (f / maxFreq) * maxHeight;
                const x = 50 + i * barWidth;
                const y = 350 - barHeight;
                ctx.fillRect(x, y, barWidth - 5, barHeight);
                ctx.strokeRect(x, y, barWidth - 5, barHeight);
            });
            
            // ì¶•
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(50, 350);
            ctx.lineTo(550, 350);
            ctx.lineTo(550, 50);
            ctx.stroke();
            
            // ë ˆì´ë¸”
            ctx.fillStyle = '#000';
            ctx.font = '14px Arial';
            ctx.fillText('ì ìˆ˜ ë¶„í¬ (íˆìŠ¤í† ê·¸ë¨)', 200, 30);
        }

        function drawScatterPlot(ctx, scores) {
            const maxScore = Math.max(...scores);
            const scaleX = 500 / 20;
            const scaleY = 300 / maxScore;
            
            ctx.fillStyle = 'rgba(102, 126, 234, 0.7)';
            scores.forEach((score, i) => {
                const x = 50 + i * scaleX;
                const y = 350 - score * scaleY;
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, 2 * Math.PI);
                ctx.fill();
            });
            
            // ì¶•
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(50, 350);
            ctx.lineTo(550, 350);
            ctx.lineTo(550, 50);
            ctx.stroke();
            
            ctx.fillStyle = '#000';
            ctx.font = '14px Arial';
            ctx.fillText('ì‹œë„ë³„ ì ìˆ˜ (ì‚°ì ë„)', 200, 30);
        }

        function drawBoxPlot(ctx, scores) {
            const sorted = [...scores].sort((a, b) => a - b);
            const q1 = sorted[Math.floor(sorted.length * 0.25)];
            const median = sorted[Math.floor(sorted.length * 0.5)];
            const q3 = sorted[Math.floor(sorted.length * 0.75)];
            const min = sorted[0];
            const max = sorted[sorted.length - 1];
            
            const scale = 500 / (max - min);
            const yCenter = 200;
            
            // ë°•ìŠ¤
            ctx.fillStyle = 'rgba(102, 126, 234, 0.3)';
            ctx.fillRect(50 + (q1 - min) * scale, yCenter - 50, (q3 - q1) * scale, 100);
            ctx.strokeStyle = '#667eea';
            ctx.lineWidth = 2;
            ctx.strokeRect(50 + (q1 - min) * scale, yCenter - 50, (q3 - q1) * scale, 100);
            
            // ì¤‘ì•™ê°’
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(50 + (median - min) * scale, yCenter - 50);
            ctx.lineTo(50 + (median - min) * scale, yCenter + 50);
            ctx.stroke();
            
            // ìˆ˜ì—¼
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(50, yCenter);
            ctx.lineTo(50 + (q1 - min) * scale, yCenter);
            ctx.moveTo(50 + (q3 - min) * scale, yCenter);
            ctx.lineTo(550, yCenter);
            ctx.stroke();
            
            ctx.fillStyle = '#000';
            ctx.font = '14px Arial';
            ctx.fillText('ì ìˆ˜ ë¶„í¬ (ë°•ìŠ¤í”Œë¡¯)', 200, 30);
        }

        function drawResidualPlot(ctx, scores) {
            // ë‹¨ìˆœ ì„ í˜• íšŒê·€
            const n = scores.length;
            const x = Array.from({length: n}, (_, i) => i + 1);
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = scores.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((sum, xi, i) => sum + xi * scores[i], 0);
            const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
            
            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            
            const residuals = scores.map((score, i) => score - (slope * (i + 1) + intercept));
            const maxResidual = Math.max(...residuals.map(Math.abs));
            
            const scaleX = 500 / n;
            const scaleY = 150 / maxResidual;
            
            // 0ì„ 
            ctx.strokeStyle = '#ccc';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(50, 200);
            ctx.lineTo(550, 200);
            ctx.stroke();
            
            // ì”ì°¨ ì 
            residuals.forEach((residual, i) => {
                const x = 50 + i * scaleX;
                const y = 200 - residual * scaleY;
                ctx.fillStyle = residual > 0 ? 'rgba(76, 175, 80, 0.7)' : 'rgba(244, 67, 54, 0.7)';
                ctx.beginPath();
                ctx.arc(x, y, 4, 0, 2 * Math.PI);
                ctx.fill();
            });
            
            ctx.fillStyle = '#000';
            ctx.font = '14px Arial';
            ctx.fillText('ì”ì°¨ í”Œë¡¯', 250, 30);
        }

        // ============================================
        // Firebaseì—ì„œ ë¬¸ì œ ë° ì‹œê°„ ì„¤ì • ë¡œë“œ
        // ============================================
       // ============================================
// Firebase ëŒ€ì‹  í•˜ë“œì½”ë”© ë¬¸ì œ ë¡œë“œ
// ============================================
async function loadQuestionsFromFirebase(mode) {

    // ì‹œí—˜ ì‹œê°„: 40ë¶„ = 2400ì´ˆ
    const fixedTimeLimit = 2400;

    const hardcodedQuestions = [
        {
            questionId: "Q1",
            questionText: `
You are given the following 20 Galaga scores generated from your student ID:

Scores: {scores}

1) Extract only the odd-indexed attempts (1st, 3rd, 5th, â€¦).  
2) From those values, keep only the scores greater than your student IDâ€™s last digit.  
3) Compute the sample mean of the remaining values.  
4) Round to two decimals.
            `,
            type: "short",
            difficulty: "medium",
            points: 10
        },
        {
            questionId: "Q2",
            questionText: `
Using the same 20 scores:

1) Split the 20 scores into four groups of five.  
2) From each group, take the middle value (the 3rd score).  
3) From these four selected values, keep only the ones greater than {avgScore}.  
4) Compute the sample variance.  
5) Round to two decimals.
            `,
            type: "short",
            difficulty: "hard",
            points: 10
        },
        {
            questionId: "Q3",
            questionText: `
Using the full 20-score dataset:

1) Keep all values between {minScore} and {maxScore}, inclusive.  
2) From these, select only those for which (value mod 3) = 2.  
3) Compute the median of the selected values.
            `,
            type: "short",
            difficulty: "medium",
            points: 10
        },
        {
            questionId: "Q4",
            questionText: `
Using your first 10 attempts:

X = attempts 1 to 10  
Y = the first 10 values from {scores}

1) Use only attempts whose score is greater than {first5Avg}.  
2) Compute the slope Î²â‚ of the regression line predicting:
   Score = Î²â‚€ + Î²â‚(Attempt)
3) Round Î²â‚ to three decimals.
            `,
            type: "short",
            difficulty: "hard",
            points: 10
        },
        {
            questionId: "Q5",
            questionText: `
Using attempts 11â€“20:

1) Compute their sample mean.  
2) Compare it to the value {randomNum1}.  
3) Answer:
   (a) the mean  
   (b) whether it is "Higher", "Lower", or "Equal" to {randomNum1}.
            `,
            type: "short",
            difficulty: "easy",
            points: 10
        },
        {
            questionId: "Q6",
            questionText: `
Let d be the last digit of your student ID.

1) From all 20 scores, keep only the values â‰¥ d Ã— 1000.  
2) Compute the sample standard deviation.  
3) Round to two decimals.
            `,
            type: "short",
            difficulty: "medium",
            points: 10
        },
        {
            questionId: "Q7",
            questionText: `
Using the full score list:

1) Select scores greater than {avgScore}.  
2) From those, keep only values whose digit-sum is even.  
3) Report how many values remain.
            `,
            type: "short",
            difficulty: "easy",
            points: 10
        },
        {
            questionId: "Q8",
            questionText: `
Using attempts 6â€“15:

1) Select only scores within Â±{stdDev} of {avgScore}.  
2) From those, keep only scores whose attempt number is prime.  
3) Compute the range (max â€“ min) of the selected values.
            `,
            type: "short",
            difficulty: "hard",
            points: 10
        },
        {
            questionId: "Q9",
            questionText: `
Let X be your first 5 scores:

X = {first5Scores}

1) Compute the sample mean of X.  
2) Compute a 95% confidence interval for the population mean assuming normality.  
3) Use your own sample standard deviation of X.  
4) Write the interval as (Lower, Upper).
            `,
            type: "essay",
            difficulty: "hard",
            points: 10
        },
        {
            questionId: "Q10",
            questionText: `
Given p = {randomPValue}:

1) Assume X ~ Binomial(n = 10, p).  
2) Compute P(X â‰¥ 2).  
3) Round to four decimals.
            `,
            type: "short",
            difficulty: "medium",
            points: 10
        }
    ];

    return {
        questions: hardcodedQuestions,
        timeLimit: fixedTimeLimit
    };
}


        // ============================================
        // ë‚´ ë°ì´í„° í™•ì¸
        // ============================================
        function viewMyData() {
            const name = document.getElementById('studentName').value.trim();
            const id = document.getElementById('studentId').value.trim();
            
            if (!name || !id) {
                alert('ì´ë¦„ê³¼ í•™ë²ˆì„ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            // í•™ìƒ ë°ì´í„° ìƒì„±
            const data = generateStudentData(id);
            
            // ëª¨ë‹¬ í‘œì‹œ
            document.getElementById('myDataModal').classList.remove('hidden');
            
            // ë°ì´í„° í‘œì‹œ
            const content = document.getElementById('myDataContent');
            content.innerHTML = `
                <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white p-6 rounded-lg mb-6">
                    <h3 class="text-2xl font-bold mb-2">${name} (${id})</h3>
                    <p class="text-lg">ê°œì¸í™”ëœ Galaga ê²Œì„ ë°ì´í„°</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h4 class="font-bold text-blue-900 mb-2">ğŸ“ˆ í†µê³„ ìš”ì•½</h4>
                        <div class="space-y-2 text-sm">
                            <p><span class="font-semibold">ìµœê³  ì ìˆ˜:</span> ${data.maxScore.toLocaleString()}</p>
                            <p><span class="font-semibold">ìµœì € ì ìˆ˜:</span> ${data.minScore.toLocaleString()}</p>
                            <p><span class="font-semibold">í‰ê·  ì ìˆ˜:</span> ${Number(data.avgScore).toLocaleString()}</p>
                            <p><span class="font-semibold">í‘œì¤€í¸ì°¨:</span> ${Number(data.stdDev).toLocaleString()}</p>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h4 class="font-bold text-green-900 mb-2">ğŸ® êµ¬ê°„ë³„ í‰ê· </h4>
                        <div class="space-y-2 text-sm">
                            <p><span class="font-semibold">ì²˜ìŒ 5íšŒ í‰ê· :</span> ${Number(data.first5Avg).toLocaleString()}</p>
                            <p><span class="font-semibold">ë§ˆì§€ë§‰ 5íšŒ í‰ê· :</span> ${Number(data.last5Avg).toLocaleString()}</p>
                            <p><span class="font-semibold">ì‹¤ë ¥ ë³€í™”:</span> ${(Number(data.last5Avg) - Number(data.first5Avg)).toFixed(2)}</p>
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 p-4 rounded-lg">
                        <h4 class="font-bold text-purple-900 mb-2">ğŸ² ë‚œìˆ˜ ë°ì´í„°</h4>
                        <div class="space-y-2 text-sm">
                            <p><span class="font-semibold">randomNum1:</span> ${data.randomNum1}</p>
                            <p><span class="font-semibold">randomNum2:</span> ${data.randomNum2}</p>
                            <p><span class="font-semibold">randomNum3:</span> ${data.randomNum3}</p>
                            <p><span class="font-semibold">randomPValue:</span> ${data.randomPValue}</p>
                        </div>
                    </div>
                    
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <h4 class="font-bold text-yellow-900 mb-2">â„¹ï¸ ì‚¬ìš© ì•ˆë‚´</h4>
                        <div class="space-y-2 text-sm text-yellow-800">
                            <p>ë¬¸ì œì—ì„œ {avgScore} ê°™ì€ ë³€ìˆ˜ê°€ ìˆìœ¼ë©´ ìœ„ì˜ ê°’ìœ¼ë¡œ ìë™ ì¹˜í™˜ë©ë‹ˆë‹¤.</p>
                            <p class="mt-2 font-semibold">ì˜ˆ: "í‰ê· ì€ {avgScore}ì…ë‹ˆë‹¤"<br>â†’ "í‰ê· ì€ ${data.avgScore}ì…ë‹ˆë‹¤"</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-4 rounded-lg">
                    <h4 class="font-bold text-gray-900 mb-3">ğŸ¯ ì „ì²´ 20íšŒ í”Œë ˆì´ ì ìˆ˜</h4>
                    <div class="grid grid-cols-4 md:grid-cols-5 gap-2 text-sm">
                        ${data.scores.map((score, i) => `
                            <div class="bg-white p-2 rounded text-center border ${i < 5 ? 'border-green-300' : i >= 15 ? 'border-blue-300' : 'border-gray-200'}">
                                <div class="text-xs text-gray-500">#${i + 1}</div>
                                <div class="font-semibold">${score.toLocaleString()}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="mt-3 text-xs text-gray-600">
                        <span class="inline-block px-2 py-1 bg-green-100 border border-green-300 rounded mr-2">ì²˜ìŒ 5íšŒ</span>
                        <span class="inline-block px-2 py-1 bg-blue-100 border border-blue-300 rounded">ë§ˆì§€ë§‰ 5íšŒ</span>
                    </div>
                </div>
                
                <div class="bg-orange-50 border-l-4 border-orange-500 p-4 rounded mt-4">
                    <h4 class="font-bold text-orange-900 mb-2">ğŸ’¡ ì‚¬ìš© ê°€ëŠ¥í•œ ë³€ìˆ˜</h4>
                    <div class="text-sm text-orange-800 space-y-1">
                        <code class="bg-white px-2 py-1 rounded">{maxScore}</code>
                        <code class="bg-white px-2 py-1 rounded">{minScore}</code>
                        <code class="bg-white px-2 py-1 rounded">{avgScore}</code>
                        <code class="bg-white px-2 py-1 rounded">{stdDev}</code><br>
                        <code class="bg-white px-2 py-1 rounded">{first5Avg}</code>
                        <code class="bg-white px-2 py-1 rounded">{last5Avg}</code>
                        <code class="bg-white px-2 py-1 rounded">{first5Scores}</code>
                        <code class="bg-white px-2 py-1 rounded">{last5Scores}</code><br>
                        <code class="bg-white px-2 py-1 rounded">{randomNum1}</code>
                        <code class="bg-white px-2 py-1 rounded">{randomNum2}</code>
                        <code class="bg-white px-2 py-1 rounded">{randomNum3}</code>
                        <code class="bg-white px-2 py-1 rounded">{randomPValue}</code>
                    </div>
                </div>
            `;
        }
        
        function closeMyDataModal() {
            document.getElementById('myDataModal').classList.add('hidden');
        }
        
        function downloadMyDataCSV() {
            const name = document.getElementById('studentName').value.trim();
            const id = document.getElementById('studentId').value.trim();
            const data = generateStudentData(id);
            
            // CSV ìƒì„±
            let csv = 'í•­ëª©,ê°’\n';
            csv += `í•™ë²ˆ,${id}\n`;
            csv += `ì´ë¦„,${name}\n`;
            csv += `ìµœê³ ì ìˆ˜,${data.maxScore}\n`;
            csv += `ìµœì €ì ìˆ˜,${data.minScore}\n`;
            csv += `í‰ê· ì ìˆ˜,${data.avgScore}\n`;
            csv += `í‘œì¤€í¸ì°¨,${data.stdDev}\n`;
            csv += `ì²˜ìŒ5íšŒí‰ê· ,${data.first5Avg}\n`;
            csv += `ë§ˆì§€ë§‰5íšŒí‰ê· ,${data.last5Avg}\n`;
            csv += `randomNum1,${data.randomNum1}\n`;
            csv += `randomNum2,${data.randomNum2}\n`;
            csv += `randomNum3,${data.randomNum3}\n`;
            csv += `randomPValue,${data.randomPValue}\n`;
            csv += '\nì‹œë„,ì ìˆ˜\n';
            data.scores.forEach((score, i) => {
                csv += `${i + 1},${score}\n`;
            });
            
            // BOM ì¶”ê°€ (í•œê¸€ ê¹¨ì§ ë°©ì§€)
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${name}_${id}_data.csv`;
            link.click();
            
            alert('CSV íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // ============================================
        // ì‹œí—˜ ì‹œì‘
        // ============================================
        async function startExam(mode) {
            const name = document.getElementById('studentName').value.trim();
            const id = document.getElementById('studentId').value.trim();
            
            if (!name || !id) {
                alert('ì´ë¦„ê³¼ í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            // ì‹¤ì „ ëª¨ë“œ ì¬ì‘ì‹œ ì²´í¬
            if (mode === 'real') {
                try {
                    const responseDoc = await db.collection('responses').doc(id).get();
                    if (responseDoc.exists) {
                        alert('ì´ë¯¸ ì‹¤ì „ ì‹œí—˜ì„ ì‘ì‹œí•˜ì…¨ìŠµë‹ˆë‹¤. ì¬ì‘ì‹œëŠ” ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.');
                        return;
                    }
                } catch (error) {
                    console.error('ì‘ì‹œ ì´ë ¥ í™•ì¸ ì˜¤ë¥˜:', error);
                }
            }
            
            currentMode = mode;
            studentData = {
                name: name,
                id: id,
                ...generateStudentData(id)
            };
            
            // Firebaseì—ì„œ ë¬¸ì œ ë° ì‹œê°„ ì„¤ì • ë¡œë“œ
            const { questions: loadedQuestions, timeLimit: loadedTimeLimit } = await loadQuestionsFromFirebase(mode);
            questions = loadedQuestions;
            timeLimit = loadedTimeLimit;
            
            if (questions.length === 0) {
                alert('ë“±ë¡ëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.');
                return;
            }
            
            // í™”ë©´ ì „í™˜
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('examScreen').classList.remove('hidden');
            
            // í—¤ë” ì •ë³´
            document.getElementById('studentInfo').textContent = `${name} (${id})`;
            document.getElementById('modeInfo').textContent = mode === 'practice' ? 'ì—°ìŠµ ëª¨ë“œ' : 'ì‹¤ì „ ì‹œí—˜';
            
            // ë¬¸ì œ ë Œë”ë§
            renderQuestions();
            
            // íƒ€ì´ë¨¸ ì‹œì‘
            examStartTime = Date.now();
            startTimer();
        }

        // ============================================
        // ë¬¸ì œ ë Œë”ë§
        // ============================================
        function renderQuestions() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';
            
            questions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'bg-white rounded-lg shadow-lg p-6';
                
                // ë‚œì´ë„ ì´ëª¨ì§€
                const difficultyEmoji = {
                    'easy': 'ğŸ˜Š',
                    'medium': 'ğŸ¤”',
                    'hard': 'ğŸ˜°'
                };
                
                let questionText = replaceVariables(q.questionText, studentData);
                
                // ì°¨íŠ¸ ì´ë¯¸ì§€ ì‚½ì…
                let chartHtml = '';
                if (q.chartType) {
                    const chartImage = generateChartImage(q.chartType, studentData);
                    chartHtml = `
                        <div class="chart-container">
                            <img src="${chartImage}" alt="Chart">
                        </div>
                    `;
                }
                
                questionDiv.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-xl font-bold text-gray-800">
                            ${index + 1}. ${q.questionId || ''}
                            <span class="text-2xl ml-2">${difficultyEmoji[q.difficulty] || 'ğŸ“'}</span>
                        </h3>
                        <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-semibold">
                            ${q.points}ì 
                        </span>
                    </div>
                    <div class="mb-4 text-gray-700 leading-relaxed">
                        ${questionText}
                    </div>
                    ${chartHtml}
                    <div class="mt-4">
                        ${renderAnswerInput(q, index)}
                    </div>
                `;
                
                container.appendChild(questionDiv);
            });
        }

        function renderAnswerInput(question, index) {
            const type = question.type;
            
            if (type === 'essay' || type === 'interpretation') {
                return `
                    <textarea 
                        id="answer_${index}" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 min-h-32"
                        placeholder="ë‹µì•ˆì„ ì…ë ¥í•˜ì„¸ìš”..."
                    ></textarea>
                `;
            } else {
                return `
                    <input 
                        type="text" 
                        id="answer_${index}" 
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                        placeholder="ë‹µì•ˆì„ ì…ë ¥í•˜ì„¸ìš”..."
                    >
                `;
            }
        }

        // ============================================
        // íƒ€ì´ë¨¸
        // ============================================
        function startTimer() {
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - examStartTime) / 1000);
                const remaining = timeLimit - elapsed;
                
                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    alert('ì‹œí—˜ ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                    submitExam();
                    return;
                }
                
                const minutes = Math.floor(remaining / 60);
                const seconds = remaining % 60;
                const timerElement = document.getElementById('timer');
                timerElement.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                // 1ë¶„ ë¯¸ë§Œ ê²½ê³ 
                if (remaining < 60) {
                    timerElement.classList.add('timer-warning', 'text-red-600');
                }
            }, 1000);
        }

        // ============================================
        // ì‹œí—˜ ì œì¶œ
        // ============================================
        async function submitExam() {
            clearInterval(timerInterval);
            
            // ë‹µì•ˆ ìˆ˜ì§‘
            const answers = [];
            questions.forEach((q, index) => {
                const answerElement = document.getElementById(`answer_${index}`);
                answers.push({
                    questionId: q.questionId,
                    answer: answerElement ? answerElement.value : '',
                    points: q.points
                });
            });
            
            // Firebaseì— ì €ì¥ (ì‹¤ì „ ëª¨ë“œë§Œ)
            if (currentMode === 'real') {
                try {
                    await db.collection('responses').doc(studentData.id).set({
                        name: studentData.name,
                        studentId: studentData.id,
                        mode: currentMode,
                        answers: answers,
                        submittedAt: new Date().toISOString(),
                        timeSpent: Math.floor((Date.now() - examStartTime) / 1000)
                    });
                } catch (error) {
                    console.error('ë‹µì•ˆ ì €ì¥ ì˜¤ë¥˜:', error);
                    alert('ë‹µì•ˆ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    return;
                }
            }
            
            // ê²°ê³¼ í™”ë©´
            showResults(answers);
        }

        // ============================================
        // ê²°ê³¼ í‘œì‹œ
        // ============================================
        function showResults(answers) {
            document.getElementById('examScreen').classList.add('hidden');
            document.getElementById('resultScreen').classList.remove('hidden');
            
            const resultContent = document.getElementById('resultContent');
            const totalPoints = questions.reduce((sum, q) => sum + (q.points || 0), 0);
            
            let html = `
                <div class="bg-gradient-to-r from-purple-500 to-pink-500 text-white p-6 rounded-lg mb-6">
                    <h3 class="text-2xl font-bold mb-2">${studentData.name} (${studentData.id})</h3>
                    <p class="text-lg">${currentMode === 'practice' ? 'ì—°ìŠµ ëª¨ë“œ' : 'ì‹¤ì „ ì‹œí—˜'} ì™„ë£Œ</p>
                    <p class="text-sm mt-2">ì´ ${questions.length}ë¬¸í•­ / ${totalPoints}ì </p>
                </div>
                
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                    <h4 class="font-bold text-blue-900 mb-2">ğŸ“ ì œì¶œëœ ë‹µì•ˆ</h4>
                    <p class="text-sm text-blue-800">
                        ${currentMode === 'practice' ? 'ì—°ìŠµ ëª¨ë“œì´ë¯€ë¡œ ì •ë‹µ ë° í•´ì„¤ì€ êµìˆ˜ë‹˜ê»˜ ë¬¸ì˜í•˜ì„¸ìš”.' : 'ì‹¤ì „ ì‹œí—˜ ë‹µì•ˆì´ ì œì¶œë˜ì—ˆìŠµë‹ˆë‹¤. ì±„ì  ê²°ê³¼ëŠ” ì¶”í›„ ê³µì§€ë©ë‹ˆë‹¤.'}
                    </p>
                </div>
                
                <div class="mt-6 space-y-3">
            `;
            
            answers.forEach((answer, index) => {
                html += `
                    <div class="bg-gray-50 p-4 rounded">
                        <p class="font-semibold text-gray-700">${index + 1}ë²ˆ ë¬¸í•­ (${answer.points}ì )</p>
                        <p class="text-gray-600 mt-2">${answer.answer || '(ë‹µì•ˆ ë¯¸ì‘ì„±)'}</p>
                    </div>
                `;
            });
            
            html += '</div>';
            resultContent.innerHTML = html;
        }
    </script>
</body>
</html>
