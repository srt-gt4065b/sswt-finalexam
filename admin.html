<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í†µê³„í•™ ì‹œí—˜ ê´€ë¦¬ì í˜ì´ì§€</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <style>
        .admin-gradient {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .success-message {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .tab-active {
            border-bottom: 3px solid #667eea;
            color: #667eea;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- í—¤ë” -->
    <div class="admin-gradient text-white p-6 shadow-lg">
        <div class="max-w-7xl mx-auto">
            <h1 class="text-3xl font-bold mb-2">ğŸ“Š í†µê³„í•™ ì‹œí—˜ ê´€ë¦¬ì</h1>
            <p class="text-sm opacity-90">ë¬¸ì œ ì—…ë¡œë“œ ë° ì‹œí—˜ ì‹œê°„ ì„¤ì •</p>
        </div>
    </div>

    <!-- ë©”ì¸ ì»¨í…ì¸  -->
    <div class="max-w-7xl mx-auto p-6">
        <!-- íƒ­ ë©”ë‰´ -->
        <div class="bg-white rounded-lg shadow-lg mb-6">
            <div class="flex border-b">
                <button onclick="switchTab('practice')" id="tab-practice" class="tab-active flex-1 px-6 py-4 font-semibold transition">
                    ì—°ìŠµ ëª¨ë“œ
                </button>
                <button onclick="switchTab('real')" id="tab-real" class="flex-1 px-6 py-4 font-semibold text-gray-600 transition">
                    ì‹¤ì „ ì‹œí—˜
                </button>
            </div>
        </div>

        <!-- ì—°ìŠµ ëª¨ë“œ íŒ¨ë„ -->
        <div id="panel-practice" class="space-y-6">
            <!-- ì‹œê°„ ì„¤ì • -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <span class="text-2xl mr-2">â±ï¸</span>
                    ì—°ìŠµ ëª¨ë“œ ì‹œí—˜ ì‹œê°„ ì„¤ì •
                </h2>
                <div class="flex items-center gap-4">
                    <input type="number" id="practiceTime" value="10" min="1" max="120"
                           class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 w-24">
                    <span class="text-gray-700">ë¶„</span>
                    <button onclick="saveTimeLimit('practice')" 
                            class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-semibold transition">
                        ì‹œê°„ ì €ì¥
                    </button>
                    <span id="practiceTimeStatus" class="text-sm text-gray-500"></span>
                </div>
            </div>

            <!-- CSV ì—…ë¡œë“œ -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <span class="text-2xl mr-2">ğŸ“¤</span>
                    ì—°ìŠµ ë¬¸ì œ ì—…ë¡œë“œ (CSV)
                </h2>
                
                <div class="mb-4">
                    <input type="file" id="practiceCSV" accept=".csv" 
                           class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
                </div>
                
                <button onclick="uploadQuestions('practice')" 
                        class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                    ë¬¸ì œ ì—…ë¡œë“œ
                </button>
                
                <div id="practiceUploadStatus" class="mt-4"></div>
            </div>

            <!-- ì—…ë¡œë“œëœ ë¬¸ì œ ë¯¸ë¦¬ë³´ê¸° -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold flex items-center">
                        <span class="text-2xl mr-2">ğŸ“‹</span>
                        ì—…ë¡œë“œëœ ì—°ìŠµ ë¬¸ì œ
                    </h2>
                    <button onclick="loadQuestions('practice')" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition">
                        ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
                <div id="practicePreview" class="overflow-x-auto"></div>
            </div>
        </div>

        <!-- ì‹¤ì „ ì‹œí—˜ íŒ¨ë„ -->
        <div id="panel-real" class="hidden space-y-6">
            <!-- ì‹œê°„ ì„¤ì • -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <span class="text-2xl mr-2">â±ï¸</span>
                    ì‹¤ì „ ì‹œí—˜ ì‹œê°„ ì„¤ì •
                </h2>
                <div class="flex items-center gap-4">
                    <input type="number" id="realTime" value="20" min="1" max="180"
                           class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 w-24">
                    <span class="text-gray-700">ë¶„</span>
                    <button onclick="saveTimeLimit('real')" 
                            class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-lg font-semibold transition">
                        ì‹œê°„ ì €ì¥
                    </button>
                    <span id="realTimeStatus" class="text-sm text-gray-500"></span>
                </div>
            </div>

            <!-- CSV ì—…ë¡œë“œ -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold mb-4 flex items-center">
                    <span class="text-2xl mr-2">ğŸ“¤</span>
                    ì‹¤ì „ ë¬¸ì œ ì—…ë¡œë“œ (CSV)
                </h2>
                
                <div class="mb-4">
                    <input type="file" id="realCSV" accept=".csv" 
                           class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
                </div>
                
                <button onclick="uploadQuestions('real')" 
                        class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                    ë¬¸ì œ ì—…ë¡œë“œ
                </button>
                
                <div id="realUploadStatus" class="mt-4"></div>
            </div>

            <!-- ì—…ë¡œë“œëœ ë¬¸ì œ ë¯¸ë¦¬ë³´ê¸° -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold flex items-center">
                        <span class="text-2xl mr-2">ğŸ“‹</span>
                        ì—…ë¡œë“œëœ ì‹¤ì „ ë¬¸ì œ
                    </h2>
                    <button onclick="loadQuestions('real')" 
                            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-semibold transition">
                        ìƒˆë¡œê³ ì¹¨
                    </button>
                </div>
                <div id="realPreview" class="overflow-x-auto"></div>
            </div>
        </div>

        <!-- CSV í˜•ì‹ ê°€ì´ë“œ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
            <h2 class="text-xl font-bold mb-4 flex items-center">
                <span class="text-2xl mr-2">ğŸ“–</span>
                CSV í˜•ì‹ ê°€ì´ë“œ
            </h2>
            
            <div class="bg-gray-50 p-4 rounded-lg mb-4">
                <h3 class="font-semibold mb-2">í•„ìˆ˜ ì»¬ëŸ¼ (ìˆœì„œëŒ€ë¡œ):</h3>
                <ol class="list-decimal list-inside space-y-1 text-sm text-gray-700">
                    <li><strong>questionId</strong> - ë¬¸ì œ ë²ˆí˜¸ (ì˜ˆ: Q1, Q2)</li>
                    <li><strong>type</strong> - calculation, short, essay, interpretation, chart</li>
                    <li><strong>questionText</strong> - ë¬¸ì œ ë‚´ìš© (HTML ì‚¬ìš© ê°€ëŠ¥)</li>
                    <li><strong>points</strong> - ë°°ì  (ìˆ«ì)</li>
                    <li><strong>answerKey</strong> - ì •ë‹µ ë˜ëŠ” ì±„ì  ê¸°ì¤€</li>
                    <li><strong>useStudentData</strong> - true/false (í•™ìƒ ë°ì´í„° ì‚¬ìš© ì—¬ë¶€)</li>
                    <li><strong>chartType</strong> - histogram, scatter, boxplot, residual (ì„ íƒ)</li>
                    <li><strong>difficulty</strong> - easy, medium, hard</li>
                </ol>
            </div>
            
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                <h3 class="font-semibold text-blue-900 mb-2">ğŸ’¡ ì‚¬ìš© ê°€ëŠ¥ ë³€ìˆ˜:</h3>
                <p class="text-sm text-blue-800">
                    ë¬¸ì œ í…ìŠ¤íŠ¸ì—ì„œ ì¤‘ê´„í˜¸ë¡œ ë³€ìˆ˜ ì‚¬ìš©: {maxScore}, {avgScore}, {first5Avg}, {last5Avg}, 
                    {stdDev}, {randomNum1}, {randomNum2}, {randomNum3}, {randomPValue}
                </p>
            </div>

            <button onclick="downloadTemplate()" 
                    class="mt-4 bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg font-semibold transition">
                ì˜ˆì œ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
            </button>
        </div>

        <!-- í•™ìƒ ì‘ë‹µ ê´€ë¦¬ -->
        <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
            <h2 class="text-xl font-bold mb-4 flex items-center">
                <span class="text-2xl mr-2">ğŸ“Š</span>
                í•™ìƒ ì‘ë‹µ ì¡°íšŒ
            </h2>
            <button onclick="viewResponses()" 
                    class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                ì „ì²´ ì‘ë‹µ ë³´ê¸°
            </button>
            <div id="responsesView" class="mt-4"></div>
        </div>
        
        <!-- ì „ì²´ í•™ìƒ ë°ì´í„° ìƒì„± -->
        <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
            <h2 class="text-xl font-bold mb-4 flex items-center">
                <span class="text-2xl mr-2">ğŸ‘¥</span>
                ì „ì²´ í•™ìƒ ê°œì¸í™” ë°ì´í„° ìƒì„±
            </h2>
            
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded mb-4">
                <h3 class="font-semibold text-blue-900 mb-2">ğŸ’¡ ì‚¬ìš© ì•ˆë‚´</h3>
                <p class="text-sm text-blue-800 mb-2">
                    í•™ìƒ í•™ë²ˆ ëª©ë¡ì„ ì…ë ¥í•˜ë©´ ëª¨ë“  í•™ìƒì˜ ê°œì¸í™”ëœ ë°ì´í„°ê°€ í¬í•¨ëœ CSV íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤.
                </p>
                <p class="text-sm text-blue-800">
                    í•™ìƒë“¤ì€ ì´ íŒŒì¼ì„ ì°¸ê³ í•˜ì—¬ ìì‹ ì˜ ë°ì´í„°({`{avgScore}`}, {`{maxScore}`} ë“±)ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                </p>
            </div>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    í•™ë²ˆ ëª©ë¡ (í•œ ì¤„ì— í•˜ë‚˜ì”©, ë˜ëŠ” ì‰¼í‘œë¡œ êµ¬ë¶„)
                </label>
                <textarea id="studentIdList" 
                          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 min-h-32"
                          placeholder="20241001&#10;20241002&#10;20241003&#10;ë˜ëŠ”: 20241001, 20241002, 20241003"></textarea>
            </div>
            
            <div class="flex gap-3">
                <button onclick="generateAllStudentData()" 
                        class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-3 rounded-lg font-semibold transition">
                    ğŸ“¥ ì „ì²´ í•™ìƒ ë°ì´í„° CSV ìƒì„±
                </button>
                <button onclick="loadSampleStudentIds()" 
                        class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition">
                    ì˜ˆì‹œ í•™ë²ˆ ë¶ˆëŸ¬ì˜¤ê¸°
                </button>
            </div>
            
            <div id="studentDataStatus" class="mt-4"></div>
        </div>
    </div>

    <script>
        // ============================================
        // Firebase ì„¤ì •
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyBGd_KrhvdCfxeRPcXn7f8csLUfcZkmKVs",
  authDomain: "sswt-final.firebaseapp.com",
  projectId: "sswt-final",
  storageBucket: "sswt-final.firebasestorage.app",
  messagingSenderId: "824707188580",
  appId: "1:824707188580:web:747ba4d91ab781e1a15c71",
  measurementId: "G-VKYGVZCS2T"
        };

        // Firebase ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentTab = 'practice';

        // ============================================
        // íƒ­ ì „í™˜
        // ============================================
        function switchTab(mode) {
            currentTab = mode;
            
            // íƒ­ ë²„íŠ¼ ìŠ¤íƒ€ì¼
            document.getElementById('tab-practice').classList.remove('tab-active');
            document.getElementById('tab-real').classList.remove('tab-active');
            document.getElementById('tab-practice').classList.add('text-gray-600');
            document.getElementById('tab-real').classList.add('text-gray-600');
            
            document.getElementById(`tab-${mode}`).classList.add('tab-active');
            document.getElementById(`tab-${mode}`).classList.remove('text-gray-600');
            
            // íŒ¨ë„ í‘œì‹œ
            document.getElementById('panel-practice').classList.add('hidden');
            document.getElementById('panel-real').classList.add('hidden');
            document.getElementById(`panel-${mode}`).classList.remove('hidden');
            
            // ë¬¸ì œ ë¡œë“œ
            loadQuestions(mode);
        }

        // ============================================
        // ì‹œê°„ ì œí•œ ì €ì¥
        // ============================================
        async function saveTimeLimit(mode) {
            const timeInput = document.getElementById(`${mode}Time`);
            const minutes = parseInt(timeInput.value);
            
            if (!minutes || minutes < 1) {
                alert('ì˜¬ë°”ë¥¸ ì‹œê°„ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }
            
            const seconds = minutes * 60;
            const statusElement = document.getElementById(`${mode}TimeStatus`);
            
            try {
                // ê¸°ì¡´ ë¬¸ì œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const doc = await db.collection('questions').doc(mode).get();
                const existingQuestions = doc.exists ? doc.data().questions || [] : [];
                
                // ì‹œê°„ ì„¤ì • ì €ì¥
                await db.collection('questions').doc(mode).set({
                    questions: existingQuestions,
                    timeLimit: seconds,
                    updatedAt: new Date().toISOString()
                }, { merge: true });
                
                statusElement.textContent = `âœ… ì €ì¥ ì™„ë£Œ! (${minutes}ë¶„)`;
                statusElement.className = 'text-sm text-green-600 success-message';
                
                setTimeout(() => {
                    statusElement.textContent = '';
                }, 3000);
            } catch (error) {
                console.error('ì‹œê°„ ì €ì¥ ì˜¤ë¥˜:', error);
                statusElement.textContent = 'âŒ ì €ì¥ ì‹¤íŒ¨';
                statusElement.className = 'text-sm text-red-600';
            }
        }

        // ============================================
        // CSV íŒŒì‹±
        // ============================================
        function parseCSV(text) {
            const lines = text.split('\n').filter(line => line.trim());
            if (lines.length < 2) return [];
            
            const headers = lines[0].split(',').map(h => h.trim());
            const questions = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
                
                if (values.length < 8) continue;
                
                questions.push({
                    questionId: values[0],
                    type: values[1],
                    questionText: values[2],
                    points: parseInt(values[3]) || 10,
                    answerKey: values[4],
                    useStudentData: values[5] === 'true',
                    chartType: values[6] || null,
                    difficulty: values[7] || 'medium'
                });
            }
            
            return questions;
        }

        // ============================================
        // ë¬¸ì œ ì—…ë¡œë“œ
        // ============================================
        async function uploadQuestions(mode) {
            const fileInput = document.getElementById(`${mode}CSV`);
            const statusElement = document.getElementById(`${mode}UploadStatus`);
            
            if (!fileInput.files.length) {
                statusElement.innerHTML = '<div class="bg-red-50 border-l-4 border-red-500 p-4 rounded"><p class="text-red-700">CSV íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.</p></div>';
                return;
            }
            
            const file = fileInput.files[0];
            const reader = new FileReader();
            
            reader.onload = async (e) => {
                try {
                    const text = e.target.result;
                    const questions = parseCSV(text);
                    
                    if (questions.length === 0) {
                        throw new Error('ì˜¬ë°”ë¥¸ CSV í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.');
                    }
                    
                    // ê¸°ì¡´ ì‹œê°„ ì„¤ì • ê°€ì ¸ì˜¤ê¸°
                    const doc = await db.collection('questions').doc(mode).get();
                    const existingTimeLimit = doc.exists ? doc.data().timeLimit : (mode === 'practice' ? 600 : 1200);
                    
                    // Firebaseì— ì €ì¥
                    await db.collection('questions').doc(mode).set({
                        questions: questions,
                        timeLimit: existingTimeLimit,
                        updatedAt: new Date().toISOString(),
                        count: questions.length
                    });
                    
                    statusElement.innerHTML = `
                        <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded success-message">
                            <p class="text-green-700 font-semibold">âœ… ì—…ë¡œë“œ ì„±ê³µ!</p>
                            <p class="text-green-600 text-sm mt-1">${questions.length}ê°œ ë¬¸ì œê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                        </div>
                    `;
                    
                    // ë¯¸ë¦¬ë³´ê¸° ìƒˆë¡œê³ ì¹¨
                    loadQuestions(mode);
                    
                    // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
                    fileInput.value = '';
                } catch (error) {
                    console.error('ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
                    statusElement.innerHTML = `
                        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                            <p class="text-red-700 font-semibold">âŒ ì—…ë¡œë“œ ì‹¤íŒ¨</p>
                            <p class="text-red-600 text-sm mt-1">${error.message}</p>
                        </div>
                    `;
                }
            };
            
            reader.readAsText(file, 'UTF-8');
        }

        // ============================================
        // ë¬¸ì œ ë¡œë“œ ë° ë¯¸ë¦¬ë³´ê¸°
        // ============================================
        async function loadQuestions(mode) {
            const previewElement = document.getElementById(`${mode}Preview`);
            previewElement.innerHTML = '<p class="text-gray-500 text-center py-4">ë¡œë”© ì¤‘...</p>';
            
            try {
                const doc = await db.collection('questions').doc(mode).get();
                
                if (!doc.exists || !doc.data().questions || doc.data().questions.length === 0) {
                    previewElement.innerHTML = '<p class="text-gray-500 text-center py-4">ì—…ë¡œë“œëœ ë¬¸ì œê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }
                
                const data = doc.data();
                const questions = data.questions;
                const timeLimit = data.timeLimit || 0;
                
                let html = `
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded mb-4">
                        <p class="text-blue-900 font-semibold">
                            ğŸ“Š ì´ ${questions.length}ê°œ ë¬¸ì œ | â±ï¸ ì‹œí—˜ ì‹œê°„: ${Math.floor(timeLimit / 60)}ë¶„
                        </p>
                        <p class="text-blue-700 text-sm mt-1">
                            ìµœì¢… ì—…ë°ì´íŠ¸: ${new Date(data.updatedAt).toLocaleString('ko-KR')}
                        </p>
                    </div>
                    <table class="min-w-full bg-white border">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-2 border">ë²ˆí˜¸</th>
                                <th class="px-4 py-2 border">ë¬¸ì œID</th>
                                <th class="px-4 py-2 border">ìœ í˜•</th>
                                <th class="px-4 py-2 border">ë¬¸ì œ ë‚´ìš©</th>
                                <th class="px-4 py-2 border">ë°°ì </th>
                                <th class="px-4 py-2 border">ë‚œì´ë„</th>
                                <th class="px-4 py-2 border">ì°¨íŠ¸</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                questions.forEach((q, index) => {
                    const difficultyColor = {
                        'easy': 'text-green-600',
                        'medium': 'text-yellow-600',
                        'hard': 'text-red-600'
                    };
                    
                    html += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 border text-center">${index + 1}</td>
                            <td class="px-4 py-2 border font-semibold">${q.questionId}</td>
                            <td class="px-4 py-2 border text-sm">${q.type}</td>
                            <td class="px-4 py-2 border text-sm max-w-md truncate">${q.questionText.substring(0, 100)}...</td>
                            <td class="px-4 py-2 border text-center font-semibold">${q.points}ì </td>
                            <td class="px-4 py-2 border text-center ${difficultyColor[q.difficulty] || ''}">${q.difficulty}</td>
                            <td class="px-4 py-2 border text-center text-sm">${q.chartType || '-'}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
                previewElement.innerHTML = html;
                
                // ì‹œê°„ ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
                document.getElementById(`${mode}Time`).value = Math.floor(timeLimit / 60);
                
            } catch (error) {
                console.error('ë¬¸ì œ ë¡œë“œ ì˜¤ë¥˜:', error);
                previewElement.innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                        <p class="text-red-700">ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
                        <p class="text-red-600 text-sm mt-1">${error.message}</p>
                    </div>
                `;
            }
        }

        // ============================================
        // í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
        // ============================================
        function downloadTemplate() {
            const template = `questionId,type,questionText,points,answerKey,useStudentData,chartType,difficulty
Q1,calculation,"ë‹¹ì‹ ì˜ ì²˜ìŒ 5íšŒ í‰ê·  ì ìˆ˜ëŠ” {first5Avg}ì…ë‹ˆë‹¤. ì´ë¥¼ ì†Œìˆ˜ì  ë‘˜ì§¸ ìë¦¬ê¹Œì§€ ë°˜ì˜¬ë¦¼í•˜ë©´?",10,"{first5Avg}",true,,easy
Q2,calculation,"ìµœê³  ì ìˆ˜ {maxScore}ì™€ í‰ê·  ì ìˆ˜ {avgScore}ì˜ ì°¨ì´ë¥¼ ê³„ì‚°í•˜ì‹œì˜¤.",10,"ì°¨ì´ê°’",true,,easy
Q3,essay,"ì²˜ìŒ 5íšŒ í‰ê· ({first5Avg})ê³¼ ë§ˆì§€ë§‰ 5íšŒ í‰ê· ({last5Avg})ì„ ë¹„êµí•˜ì—¬ ì‹¤ë ¥ ë³€í™”ë¥¼ ì„œìˆ í•˜ì‹œì˜¤.",15,"ì‹¤ë ¥ ë³€í™”ì— ëŒ€í•œ ë¶„ì„",true,,medium
Q4,chart,"ì•„ë˜ íˆìŠ¤í† ê·¸ë¨ì„ ë³´ê³  ë°ì´í„°ì˜ ì •ê·œì„±ì„ íŒë‹¨í•˜ì‹œì˜¤.",20,"ì •ê·œì„± íŒë‹¨ ë° ê·¼ê±°",true,histogram,hard
Q5,calculation,"í‰ê· ì´ {randomNum1}ì´ê³  í‘œì¤€í¸ì°¨ê°€ {randomNum2}ì¼ ë•Œ, z-scoreë¥¼ ê³„ì‚°í•˜ì‹œì˜¤.",15,"z-score ê³„ì‚°",false,,medium
Q6,interpretation,"p-valueê°€ {randomPValue}ì¼ ë•Œ, ê·€ë¬´ê°€ì„¤ì— ëŒ€í•œ ê²°ë¡ ì„ ë‚´ë¦¬ì‹œì˜¤ (ìœ ì˜ìˆ˜ì¤€ 0.05).",15,"ê·€ë¬´ê°€ì„¤ ê¸°ê°/ì±„íƒ ë° í•´ì„",false,,medium
Q7,essay,"íšŒê·€ë¶„ì„ì—ì„œ ì”ì°¨(residual)ì™€ ì˜¤ì°¨(error)ì˜ ì°¨ì´ë¥¼ ì„¤ëª…í•˜ì‹œì˜¤.",15,"ê°œë… ì„¤ëª…",false,,hard
Q8,chart,"ì•„ë˜ ì”ì°¨ í”Œë¡¯ì„ ë³´ê³  íšŒê·€ ëª¨ë¸ì˜ ì í•©ì„±ì„ í‰ê°€í•˜ì‹œì˜¤.",15,"ëª¨ë¸ ì í•©ì„± í‰ê°€",true,residual,hard
Q9,calculation,"í‘œì¤€í¸ì°¨ê°€ {stdDev}ì¼ ë•Œ, ë¶„ì‚°ì€?",10,"ë¶„ì‚° ê³„ì‚°",true,,easy
Q10,interpretation,"í‘œì¤€í¸ì°¨ {stdDev}ì˜ ì˜ë¯¸ë¥¼ í•´ì„í•˜ì‹œì˜¤.",15,"í‘œì¤€í¸ì°¨ í•´ì„",true,,medium`;
            
            const blob = new Blob([template], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'question_template.csv';
            link.click();
        }

        // ============================================
        // í•™ìƒ ì‘ë‹µ ì¡°íšŒ
        // ============================================
        async function viewResponses() {
            const viewElement = document.getElementById('responsesView');
            viewElement.innerHTML = '<p class="text-gray-500 text-center py-4">ë¡œë”© ì¤‘...</p>';
            
            try {
                const snapshot = await db.collection('responses').get();
                
                if (snapshot.empty) {
                    viewElement.innerHTML = '<p class="text-gray-500 text-center py-4">ì œì¶œëœ ë‹µì•ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }
                
                let html = `
                    <div class="overflow-x-auto mt-4">
                        <table class="min-w-full bg-white border">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="px-4 py-2 border">í•™ë²ˆ</th>
                                    <th class="px-4 py-2 border">ì´ë¦„</th>
                                    <th class="px-4 py-2 border">ëª¨ë“œ</th>
                                    <th class="px-4 py-2 border">ì œì¶œ ì‹œê°„</th>
                                    <th class="px-4 py-2 border">ì†Œìš” ì‹œê°„</th>
                                    <th class="px-4 py-2 border">ë‹µì•ˆ ìˆ˜</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const timeSpent = Math.floor(data.timeSpent / 60);
                    html += `
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-2 border font-semibold">${data.studentId}</td>
                            <td class="px-4 py-2 border">${data.name}</td>
                            <td class="px-4 py-2 border">
                                <span class="px-2 py-1 rounded text-sm ${data.mode === 'practice' ? 'bg-green-100 text-green-800' : 'bg-purple-100 text-purple-800'}">
                                    ${data.mode === 'practice' ? 'ì—°ìŠµ' : 'ì‹¤ì „'}
                                </span>
                            </td>
                            <td class="px-4 py-2 border text-sm">${new Date(data.submittedAt).toLocaleString('ko-KR')}</td>
                            <td class="px-4 py-2 border text-center">${timeSpent}ë¶„</td>
                            <td class="px-4 py-2 border text-center">${data.answers.length}</td>
                        </tr>
                    `;
                });
                
                html += `
                        </tbody>
                    </table>
                </div>
                `;
                
                viewElement.innerHTML = html;
                
            } catch (error) {
                console.error('ì‘ë‹µ ì¡°íšŒ ì˜¤ë¥˜:', error);
                viewElement.innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                        <p class="text-red-700">ì‘ë‹µì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
                        <p class="text-red-600 text-sm mt-1">${error.message}</p>
                    </div>
                `;
            }
        }

        // ============================================
        // í•™ìƒ ê°œì¸í™” ë°ì´í„° ìƒì„± (index.htmlê³¼ ë™ì¼í•œ ë¡œì§)
        // ============================================
        function seedRandom(seed) {
            let x = Math.sin(seed++) * 10000;
            return x - Math.floor(x);
        }

        function generateStudentData(studentId) {
            const seed = parseInt(studentId) || 12345;
            const scores = [];
            
            for (let i = 0; i < 20; i++) {
                const score = Math.floor(seedRandom(seed + i) * 50000) + 10000;
                scores.push(score);
            }
            
            const first5 = scores.slice(0, 5);
            const last5 = scores.slice(15, 20);
            const sum = scores.reduce((a, b) => a + b, 0);
            const avg = sum / scores.length;
            const variance = scores.reduce((sum, score) => sum + Math.pow(score - avg, 2), 0) / scores.length;
            const stdDev = Math.sqrt(variance);
            
            return {
                scores: scores,
                first5Avg: (first5.reduce((a, b) => a + b, 0) / 5).toFixed(2),
                last5Avg: (last5.reduce((a, b) => a + b, 0) / 5).toFixed(2),
                maxScore: Math.max(...scores),
                minScore: Math.min(...scores),
                avgScore: avg.toFixed(2),
                stdDev: stdDev.toFixed(2),
                randomNum1: Math.floor(seedRandom(seed + 100) * 300) + 600,
                randomNum2: Math.floor(seedRandom(seed + 200) * 100) + 150,
                randomNum3: Math.floor(seedRandom(seed + 300) * 50) + 20,
                randomPValue: (seedRandom(seed + 400) * 0.1).toFixed(3)
            };
        }

        // ============================================
        // ì „ì²´ í•™ìƒ ë°ì´í„° CSV ìƒì„±
        // ============================================
        function generateAllStudentData() {
            const input = document.getElementById('studentIdList').value.trim();
            const statusElement = document.getElementById('studentDataStatus');
            
            if (!input) {
                statusElement.innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                        <p class="text-red-700">í•™ë²ˆ ëª©ë¡ì„ ì…ë ¥í•˜ì„¸ìš”.</p>
                    </div>
                `;
                return;
            }
            
            // í•™ë²ˆ íŒŒì‹± (ì¤„ë°”ê¿ˆ ë˜ëŠ” ì‰¼í‘œë¡œ êµ¬ë¶„)
            const studentIds = input
                .split(/[\n,]/)
                .map(id => id.trim())
                .filter(id => id.length > 0);
            
            if (studentIds.length === 0) {
                statusElement.innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded">
                        <p class="text-red-700">ì˜¬ë°”ë¥¸ í•™ë²ˆì„ ì…ë ¥í•˜ì„¸ìš”.</p>
                    </div>
                `;
                return;
            }
            
            // CSV í—¤ë”
            let csv = 'í•™ë²ˆ,ìµœê³ ì ìˆ˜,ìµœì €ì ìˆ˜,í‰ê· ì ìˆ˜,í‘œì¤€í¸ì°¨,ì²˜ìŒ5íšŒí‰ê· ,ë§ˆì§€ë§‰5íšŒí‰ê· ,randomNum1,randomNum2,randomNum3,randomPValue';
            
            // 20íšŒ ì ìˆ˜ ì»¬ëŸ¼ ì¶”ê°€
            for (let i = 1; i <= 20; i++) {
                csv += `,ì‹œë„${i}`;
            }
            csv += '\n';
            
            // ê° í•™ìƒ ë°ì´í„° ìƒì„±
            studentIds.forEach(studentId => {
                const data = generateStudentData(studentId);
                csv += `${studentId},${data.maxScore},${data.minScore},${data.avgScore},${data.stdDev},`;
                csv += `${data.first5Avg},${data.last5Avg},${data.randomNum1},${data.randomNum2},${data.randomNum3},${data.randomPValue}`;
                
                // 20íšŒ ì ìˆ˜ ì¶”ê°€
                data.scores.forEach(score => {
                    csv += `,${score}`;
                });
                csv += '\n';
            });
            
            // CSV ë‹¤ìš´ë¡œë“œ
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ì „ì²´í•™ìƒ_ê°œì¸í™”ë°ì´í„°_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
            
            statusElement.innerHTML = `
                <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded success-message">
                    <p class="text-green-700 font-semibold">âœ… CSV ìƒì„± ì™„ë£Œ!</p>
                    <p class="text-green-600 text-sm mt-1">
                        ${studentIds.length}ëª…ì˜ í•™ìƒ ë°ì´í„°ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.
                    </p>
                    <p class="text-green-600 text-sm mt-2">
                        ğŸ“ íŒŒì¼ëª…: ì „ì²´í•™ìƒ_ê°œì¸í™”ë°ì´í„°_${new Date().toISOString().slice(0,10)}.csv
                    </p>
                </div>
            `;
        }

        // ============================================
        // ì˜ˆì‹œ í•™ë²ˆ ë¶ˆëŸ¬ì˜¤ê¸°
        // ============================================
        function loadSampleStudentIds() {
            const sampleIds = `20241001
20241002
20241003
20241004
20241005
20241006
20241007
20241008
20241009
20241010`;
            
            document.getElementById('studentIdList').value = sampleIds;
            
            const statusElement = document.getElementById('studentDataStatus');
            statusElement.innerHTML = `
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                    <p class="text-blue-700">ì˜ˆì‹œ í•™ë²ˆ 10ê°œê°€ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ì • í›„ "ì „ì²´ í•™ìƒ ë°ì´í„° CSV ìƒì„±" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
                </div>
            `;
        }

        // ============================================
        // ì´ˆê¸°í™”
        // ============================================
        window.onload = function() {
            loadQuestions('practice');
        };
    </script>
</body>
</html>
