<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin ‚Äì MCQ Question Manager V10</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>

<body class="bg-gray-100 min-h-screen p-6">

<!-- ========================================================= -->
<!-- PASSWORD GATE -->
<!-- ========================================================= -->
<div id="passwordGate"
     class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center">

        <h2 class="text-2xl font-bold text-purple-600 mb-4">Admin Access</h2>
        <p class="text-gray-600 mb-6">Enter the admin password to continue.</p>

        <input id="adminPass"
               type="password"
               class="w-full px-4 py-3 border rounded-lg text-center text-lg focus:ring-2 focus:ring-purple-500"
               placeholder="Enter password">

        <button onclick="checkAdminPassword()"
                class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg mt-4">
            Unlock
        </button>

        <p id="passError" class="text-red-500 font-semibold mt-3 hidden">
            ‚ùå Incorrect password
        </p>
    </div>
</div>

<script>
function checkAdminPassword() {
    const input = document.getElementById("adminPass").value.trim();
    if (input === "1230") {
        document.getElementById("passwordGate").classList.add("hidden");
    } else {
        document.getElementById("passError").classList.remove("hidden");
    }
}
</script>

<!-- ========================================================= -->
<!-- MAIN WRAPPER -->
<!-- ========================================================= -->
<div class="max-w-7xl mx-auto bg-white p-6 md:p-10 rounded-2xl shadow-xl">

    <h1 class="text-3xl md:text-4xl font-bold text-center text-purple-600 mb-6">
        Admin ‚Äì MCQ Question Manager V10
    </h1>

    <!-- Version selector -->
    <div class="flex flex-wrap items-center gap-3 mb-6 justify-between">
        <div class="flex items-center gap-2">
            <label class="font-semibold text-gray-700">Target exam version (docId):</label>
            <input id="docIdInput"
                   class="border rounded-lg px-3 py-2"
                   value="current"
                   placeholder="e.g., current, final2025, midterm2025">
        </div>
        <div class="text-sm text-gray-500">
            Saved to Firestore ‚Üí <span class="font-mono">exam_questions / [docId]</span>
        </div>
    </div>

    <!-- Tabs -->
    <div class="border-b mb-4 flex flex-wrap gap-2">
        <button class="tab-btn px-4 py-2 text-sm font-semibold border-b-2 border-purple-600 text-purple-700"
                data-tab="uploadTab">Upload (CSV / JSON)</button>
        <button class="tab-btn px-4 py-2 text-sm font-semibold text-gray-500"
                data-tab="randomTab">Random Generator</button>
        <button class="tab-btn px-4 py-2 text-sm font-semibold text-gray-500"
                data-tab="templateTab">Template Loader</button>
        <button class="tab-btn px-4 py-2 text-sm font-semibold text-gray-500"
                data-tab="previewTab">Preview & Edit</button>
        <button class="tab-btn px-4 py-2 text-sm font-semibold text-gray-500"
                data-tab="firestoreTab">Firestore Upload</button>
        <!-- NEW: Final 100 Generator tab -->
        <button class="tab-btn px-4 py-2 text-sm font-semibold text-gray-500"
                data-tab="final100Tab">Final 100 Generator</button>
    </div>

    <!-- ===================== -->
    <!-- TAB: UPLOAD (CSV/JSON) -->
    <!-- ===================== -->
    <div id="uploadTab" class="tab-pane block">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

            <!-- CSV Upload -->
            <div class="border rounded-xl p-6 bg-gray-50">
                <h2 class="text-xl font-bold mb-3 text-purple-700">Upload Questions via CSV</h2>
                <p class="text-sm text-gray-600 mb-2">
                    Format: <span class="font-mono">id,question,opt1,opt2,opt3,opt4,answer</span>
                </p>
                <input id="csvFile" type="file" accept=".csv"
                       class="w-full border p-3 rounded bg-white shadow-sm">
                <button onclick="previewCSV()"
                        class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-bold">
                    Preview CSV
                </button>
            </div>

            <!-- JSON Upload -->
            <div class="border rounded-xl p-6 bg-gray-50">
                <h2 class="text-xl font-bold mb-3 text-purple-700">Upload Questions via JSON</h2>
                <p class="text-sm text-gray-600 mb-2">
                    Supported formats:
                </p>
                <ul class="text-xs text-gray-600 list-disc ml-5 mb-2">
                    <li><span class="font-mono">[{"id","text","options","answer"}, ...]</span></li>
                    <li><span class="font-mono">{"Low":[...], "Medium":[...], "High":[...]}</span></li>
                </ul>
                <input id="jsonFile" type="file" accept=".json"
                       class="w-full border p-3 rounded bg-white shadow-sm">
                <button onclick="previewJSON()"
                        class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-bold">
                    Preview JSON
                </button>
            </div>
        </div>
    </div>

    <!-- ===================== -->
    <!-- TAB: RANDOM GENERATOR -->
    <!-- ===================== -->
    <div id="randomTab" class="tab-pane hidden mt-4">
        <div class="border rounded-xl p-6 bg-gray-50">
            <h2 class="text-xl font-bold mb-4 text-purple-700">Random Question Generator</h2>

            <div class="grid md:grid-cols-3 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-semibold mb-1">Topic</label>
                    <select id="topicSelect"
                            class="w-full p-2 border rounded">
                        <option>Descriptive Statistics</option>
                        <option>Probability</option>
                        <option>Sampling & Sampling Distribution</option>
                        <option>Estimation (Confidence Interval)</option>
                        <option>Hypothesis Testing</option>
                        <option>Regression Basics</option>
                        <option>Practical Real-World Applications</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1">Difficulty</label>
                    <select id="levelSelect"
                            class="w-full p-2 border rounded">
                        <option>Low</option>
                        <option>Medium</option>
                        <option>High</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold mb-1">Number of questions</label>
                    <input id="numQuestions" type="number" min="1" value="10"
                           class="w-full p-2 border rounded">
                </div>
            </div>

            <button onclick="generateRandomQuestions()"
                    class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-lg font-bold">
                Generate & Add to Preview
            </button>

            <p class="text-xs text-gray-500 mt-3">
                ‚Äª ÌÖúÌîåÎ¶ø ÌíÄ ÌÅ¨Í∏∞Î≥¥Îã§ ÎßéÏù¥ ÏÉùÏÑ± ÏöîÏ≤≠ÌïòÎ©¥, Í∞ÄÎä•Ìïú Î≤îÏúÑ ÎÇ¥ÏóêÏÑúÎßå ÏÉùÏÑ±Ìï©ÎãàÎã§.
            </p>
        </div>
    </div>

    <!-- ===================== -->
    <!-- TAB: TEMPLATE LOADER -->
    <!-- ===================== -->
    <div id="templateTab" class="tab-pane hidden mt-4">
        <div class="border rounded-xl p-6 bg-gray-50">
            <h2 class="text-xl font-bold mb-4 text-purple-700">Load Topic Templates (JSON)</h2>

            <p class="text-sm text-gray-600 mb-3">
                /templates Ìè¥ÎçîÏóê ÏûàÎäî Ï£ºÏ†úÎ≥Ñ JSON ÌååÏùºÏùÑ Î∂àÎü¨ÏôÄÏÑú PreviewÏóê Ï∂îÍ∞ÄÌï©ÎãàÎã§.
            </p>

            <div class="grid md:grid-cols-3 gap-3">
                <button onclick="loadTemplateJSON('descriptive.json','Descriptive Statistics')"
                        class="bg-gray-800 hover:bg-gray-900 text-white py-2 rounded-lg text-sm">
                    descriptive.json
                </button>
                <button onclick="loadTemplateJSON('probability.json','Probability')"
                        class="bg-gray-800 hover:bg-gray-900 text-white py-2 rounded-lg text-sm">
                    probability.json
                </button>
                <button onclick="loadTemplateJSON('sampling.json','Sampling & Sampling Distribution')"
                        class="bg-gray-800 hover:bg-gray-900 text-white py-2 rounded-lg text-sm">
                    sampling.json
                </button>
                <button onclick="loadTemplateJSON('estimation.json','Estimation (Confidence Interval)')"
                        class="bg-gray-800 hover:bg-gray-900 text-white py-2 rounded-lg text-sm">
                    estimation.json
                </button>
                <button onclick="loadTemplateJSON('hypothesis.json','Hypothesis Testing')"
                        class="bg-gray-800 hover:bg-gray-900 text-white py-2 rounded-lg text-sm">
                    hypothesis.json
                </button>
                <button onclick="loadTemplateJSON('regression.json','Regression Basics')"
                        class="bg-gray-800 hover:bg-gray-900 text-white py-2 rounded-lg text-sm">
                    regression.json
                </button>
                <button onclick="loadTemplateJSON('practical.json','Practical Real-World Applications')"
                        class="bg-gray-800 hover:bg-gray-900 text-white py-2 rounded-lg text-sm md:col-span-3">
                    practical.json
                </button>
            </div>
        </div>
    </div>

    <!-- ===================== -->
    <!-- TAB: PREVIEW & EDIT -->
    <!-- ===================== -->
    <div id="previewTab" class="tab-pane hidden mt-4">
        <div class="flex justify-between items-center mb-3">
            <h2 class="text-xl font-bold text-gray-800">Preview & Inline Edit</h2>
            <div class="flex gap-2">
                <button onclick="removeDuplicateQuestions()"
                        class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded text-sm font-semibold">
                    Remove Duplicates
                </button>
                <button onclick="addEmptyQuestion()"
                        class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-sm font-semibold">
                    + Add Empty Question
                </button>
                <button onclick="clearPreview()"
                        class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded text-sm font-semibold">
                    Clear All
                </button>
            </div>
        </div>

        <div id="previewArea" class="border rounded-xl p-2 bg-gray-50 max-h-[600px] overflow-auto">
            <p class="text-sm text-gray-500">No questions loaded yet.</p>
        </div>
    </div>

    <!-- ===================== -->
    <!-- TAB: FIRESTORE UPLOAD -->
    <!-- ===================== -->
    <div id="firestoreTab" class="tab-pane hidden mt-4">
        <div class="border rounded-xl p-6 bg-gray-50">
            <h2 class="text-xl font-bold text-purple-700 mb-4">Upload to Firestore</h2>

            <p class="text-sm text-gray-700 mb-4">
                ÌòÑÏû¨ previewÏóê ÏûàÎäî Î¨∏Ìï≠Îì§ÏùÑ ÏÑ†ÌÉùÏ†ÅÏúºÎ°ú ÎòêÎäî Ï†ÑÏ≤¥ ÏóÖÎ°úÎìúÌï† Ïàò ÏûàÏäµÎãàÎã§.<br>
                Ï†ÄÏû• ÏúÑÏπò: <span class="font-mono">exam_questions / [docId]</span>
            </p>

            <div class="flex flex-col md:flex-row gap-3 mb-4">
                <button onclick="uploadSelectedQuestions()"
                        class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-bold">
                    Upload Checked Questions Only
                </button>
                <button onclick="uploadAllQuestions()"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold">
                    Upload ALL Questions in Preview
                </button>
            </div>

            <p class="text-xs text-gray-500">
                ÏóÖÎ°úÎìú Ïãú, <span class="font-mono">exam_questions/versions/history/[timestamp]</span> ÏóêÎèÑ ÏûêÎèô Î∞±ÏóÖÎêòÍ≥†,
                backup JSON ÌååÏùºÏù¥ ÏûêÎèôÏúºÎ°ú Îã§Ïö¥Î°úÎìúÎê©ÎãàÎã§.
            </p>
        </div>
    </div>

    <!-- ===================== -->
    <!-- TAB: FINAL 100 GENERATOR (NEW) -->
    <!-- ===================== -->
    <div id="final100Tab" class="tab-pane hidden mt-4">
        <div class="border rounded-xl p-6 bg-gray-50">
            <h2 class="text-2xl font-bold mb-4 text-purple-700">
                Final 100 Generator (Balanced Exam Builder)
            </h2>

            <p class="text-gray-600 text-sm mb-4">
                Generates 100 questions using balanced distribution:<br>
                <b>Descriptive 15, Probability 15, Sampling 15, Estimation 15,<br>
                Hypothesis 15, Regression 15, Practical 10</b><br>
                Title: <b>Statistics with SW Tools ‚Äì Fall 2025 Final Exam</b>
            </p>

            <button onclick="generateFinal100()"
                    class="w-full bg-orange-600 hover:bg-orange-700 text-white py-3 rounded-lg font-bold">
                Generate Balanced 100 Questions
            </button>

            <div id="final100Status" class="mt-4 text-center text-sm text-gray-600"></div>

            <div id="final100Preview"
                 class="border mt-4 p-4 rounded-xl bg-white max-h-[500px] overflow-auto text-sm">
                <p class="text-gray-500">No questions generated yet.</p>
            </div>

            <div class="flex gap-3 mt-4">
                <button onclick="saveFinal100Version()"
                        class="flex-1 bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-bold">
                    Save as New Exam Version
                </button>

                <button onclick="applyAsCurrentFinal()"
                        class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold">
                    Apply as Current Final Exam
                </button>
            </div>
        </div>
    </div>

    <p id="statusMsg" class="text-center mt-6 text-lg font-semibold"></p>

</div>

<!-- ========================================================= -->
<!-- FIREBASE INIT -->
<!-- ========================================================= -->
<script>
const firebaseConfig = {
    apiKey: "AIzaSyBGd_KrhvdCfxeRPcXn7f8csLUfcZkmKVs",
    authDomain: "sswt-final.firebaseapp.com",
    projectId: "sswt-final",
    storageBucket: "sswt-final.firebasestorage.app",
    messagingSenderId: "824707188580",
    appId: "1:824707188580:web:747ba4d91ab781e1a15c71"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script>

<!-- ========================================================= -->
<!-- GLOBAL STATE + UTILITIES -->
<!-- ========================================================= -->
<script>
let previewData = []; // {id, question, opt1, opt2, opt3, opt4, answer, topic?, level?}
let final100Data = []; // Final 100 exam set

function normalizeQuestionText(text) {
    return (text || "")
        .trim()
        .toLowerCase()
        .replace(/\s+/g, " ");
}

function shuffleArray(array) {
    return array
        .map(x => x)
        .sort(() => Math.random() - 0.5);
}

function removeDuplicateQuestions() {
    if (!previewData.length) {
        alert("No questions to clean.");
        return;
    }
    const seen = new Set();
    const before = previewData.length;
    previewData = previewData.filter(q => {
        const key = normalizeQuestionText(q.question);
        if (!key) return false;
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
    });
    const after = previewData.length;
    renderPreviewTable();
    const removed = before - after;
    document.getElementById("statusMsg").textContent =
        `üßπ Removed ${removed} duplicate questions. Final count: ${after}`;
    document.getElementById("statusMsg").className =
        "text-yellow-600 text-center text-lg font-semibold";
}
</script>

<!-- ========================================================= -->
<!-- TABS LOGIC -->
<!-- ========================================================= -->
<script>
const tabButtons = document.querySelectorAll(".tab-btn");
const tabPanes = document.querySelectorAll(".tab-pane");

tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
        const target = btn.dataset.tab;
        tabButtons.forEach(b => {
            b.classList.remove("border-purple-600","text-purple-700");
            b.classList.add("text-gray-500");
        });
        btn.classList.add("border-purple-600","text-purple-700");
        btn.classList.remove("text-gray-500");

        tabPanes.forEach(pane => {
            pane.classList.add("hidden");
        });
        document.getElementById(target).classList.remove("hidden");
    });
});
</script>

<!-- ========================================================= -->
<!-- CSV PARSE + PREVIEW -->
<!-- ========================================================= -->
<script>
function parseCSV(text) {
    const lines = text.trim().split("\n");
    const headers = lines[0].split(",").map(h => h.trim());

    return lines.slice(1).map(line => {
        const cols = line.split(",").map(c => c.trim());
        let obj = {};
        headers.forEach((h, i) => obj[h] = cols[i]);
        return obj;
    });
}

function previewCSV() {
    const file = document.getElementById("csvFile").files[0];
    if (!file) {
        alert("Select a CSV file first.");
        return;
    }
    const reader = new FileReader();
    reader.onload = e => {
        const rows = parseCSV(e.target.result);
        rows.forEach(r => {
            previewData.push({
                id: r.id || "",
                question: r.question || "",
                opt1: r.opt1 || "",
                opt2: r.opt2 || "",
                opt3: r.opt3 || "",
                opt4: r.opt4 || "",
                answer: r.answer ? parseInt(r.answer) : 0
            });
        });
        removeDuplicateQuestions();
        renderPreviewTable();
        document.getElementById("statusMsg").textContent =
            `‚úÖ Added ${rows.length} questions from CSV (duplicates removed).`;
        document.getElementById("statusMsg").className =
            "text-green-600 text-center text-lg font-semibold";
    };
    reader.readAsText(file);
}
</script>

<!-- ========================================================= -->
<!-- JSON PREVIEW (2 FORMATS ÏßÄÏõê) + DEDUPE -->
<!-- ========================================================= -->
<script>
function previewJSON() {
    const file = document.getElementById("jsonFile").files[0];
    if (!file) {
        alert("Select a JSON file first.");
        return;
    }
    const reader = new FileReader();
    reader.onload = e => {
        try {
            const data = JSON.parse(e.target.result);

            if (Array.isArray(data)) {
                data.forEach((q, idx) => {
                    previewData.push({
                        id: q.id || `J${previewData.length + idx + 1}`,
                        question: q.text || q.question || "",
                        opt1: q.options ? (q.options[0] || "") : (q.opt1 || ""),
                        opt2: q.options ? (q.options[1] || "") : (q.opt2 || ""),
                        opt3: q.options ? (q.options[2] || "") : (q.opt3 || ""),
                        opt4: q.options ? (q.options[3] || "") : (q.opt4 || ""),
                        answer: typeof q.answer === "number" ? q.answer : parseInt(q.answer || 0),
                        topic: q.topic || "",
                        level: q.level || ""
                    });
                });
            }
            else if (data.Low || data.Medium || data.High) {
                ["Low","Medium","High"].forEach(level=>{
                    if (Array.isArray(data[level])) {
                        data[level].forEach((q, idx) => {
                            previewData.push({
                                id: q.id || `J${previewData.length + idx + 1}`,
                                question: q.q || q.text || q.question || "",
                                opt1: q.opts ? (q.opts[0] || "") : (q.options ? q.options[0] : ""),
                                opt2: q.opts ? (q.opts[1] || "") : (q.options ? q.options[1] : ""),
                                opt3: q.opts ? (q.opts[2] || "") : (q.options ? q.options[2] : ""),
                                opt4: q.opts ? (q.opts[3] || "") : (q.options ? q.options[3] : ""),
                                answer: typeof q.ans === "number" ? q.ans : parseInt(q.answer || 0),
                                topic: "",
                                level: level
                            });
                        });
                    }
                });
            } else {
                alert("Unsupported JSON structure.");
                return;
            }

            removeDuplicateQuestions();
            renderPreviewTable();
            document.getElementById("statusMsg").textContent =
                "‚úÖ JSON questions loaded into preview (duplicates removed).";
            document.getElementById("statusMsg").className =
                "text-green-600 text-center text-lg font-semibold";

        } catch(err) {
            console.error(err);
            alert("Invalid JSON file.");
        }
    };
    reader.readAsText(file);
}
</script>

<!-- ========================================================= -->
<!-- TEMPLATE JSON LOADER (Ï£ºÏ†úÎ≥Ñ ÌååÏùº) + DEDUPE -->
<!-- ========================================================= -->
<script>
async function loadTemplateJSON(filename, topicLabel) {
    try {
        const res = await fetch(`templates/${filename}`);
        if (!res.ok) {
            alert(`Cannot load ${filename}. Check path.`);
            return;
        }
        const data = await res.json();
        let added = 0;
        ["Low","Medium","High"].forEach(level=>{
            if (Array.isArray(data[level])) {
                data[level].forEach(q=>{
                    previewData.push({
                        id: q.id || `T${previewData.length + 1}`,
                        question: q.q || q.text || q.question || "",
                        opt1: q.opts ? (q.opts[0] || "") : (q.options ? q.options[0] : ""),
                        opt2: q.opts ? (q.opts[1] || "") : (q.options ? q.options[1] : ""),
                        opt3: q.opts ? (q.opts[2] || "") : (q.options ? q.options[2] : ""),
                        opt4: q.opts ? (q.opts[3] || "") : (q.options ? q.options[3] : ""),
                        answer: typeof q.ans === "number" ? q.ans : parseInt(q.answer || 0),
                        topic: topicLabel,
                        level: level
                    });
                    added++;
                });
            }
        });
        removeDuplicateQuestions();
        renderPreviewTable();
        document.getElementById("statusMsg").textContent =
            `‚úÖ Loaded ${added} questions from ${filename} (duplicates removed).`;
        document.getElementById("statusMsg").className =
            "text-green-600 text-center text-lg font-semibold";
        document.querySelector('[data-tab="previewTab"]').click();
    } catch(err) {
        console.error(err);
        alert("Failed to load template JSON.");
    }
}
</script>

<!-- ========================================================= -->
<!-- RANDOM GENERATOR (Í∞ÑÎã® ÌÖúÌîåÎ¶ø ÏòàÏãú) + DEDUPE -->
<!-- ========================================================= -->
<script>
const templates = {
    "Descriptive Statistics": {
        Low: [
            { q: "What does the mean represent?", opts: ["Average", "Median", "Mode", "Range"], ans: 0 },
            { q: "Which is a measure of spread?", opts: ["Variance", "Mean", "Median", "Mode"], ans: 0 }
        ],
        Medium: [
            { q: "Why is standard deviation useful?", opts: ["It measures variability", "It finds the median", "It reduces errors", "It increases sample size"], ans: 0 }
        ],
        High: [
            { q: "Why is variance squared but SD not?", opts: ["Mathematical convenience", "No reason", "Just tradition", "To confuse students"], ans: 0 }
        ]
    },
    "Probability": {
        Low: [
            { q: "Probability of a fair coin landing heads?", opts: ["1/2", "1/3", "1/4", "1"], ans: 0 }
        ],
        Medium: [
            { q: "What is conditional probability?", opts: ["Probability given another event", "Always 1", "Always 0", "Independent event"], ans: 0 }
        ],
        High: [
            { q: "Bayes‚Äô theorem links:", opts: ["Prior and posterior", "Mean and variance", "CI and ME", "Slope and intercept"], ans: 0 }
        ]
    },
    "Sampling & Sampling Distribution": {
        Low: [
            { q: "What is a sample?", opts: ["Subset of population", "Entire population", "Median", "Error"], ans: 0 }
        ],
        Medium: [
            { q: "Sampling distribution is distribution of:", opts: ["Statistics", "Raw data", "Errors", "Residuals"], ans: 0 }
        ],
        High: [
            { q: "Why is sampling distribution important?", opts: ["Basis of inference", "To draw histograms", "To reduce errors", "No reason"], ans: 0 }
        ]
    },
    "Estimation (Confidence Interval)": {
        Low: [
            { q: "CI is used to estimate:", opts: ["Population parameter", "Sample mean only", "Variance only", "P-value"], ans: 0 }
        ],
        Medium: [
            { q: "95% CI means:", opts: ["Interval capturing true parameter 95% of times", "95% of data inside", "Mean=95", "Variance small"], ans: 0 }
        ],
        High: [
            { q: "CI width depends on:", opts: ["Variability & sample size", "Color of bars", "Test type only", "Nothing"], ans: 0 }
        ]
    },
    "Hypothesis Testing": {
        Low: [
            { q: "Null hypothesis symbol is:", opts: ["H0", "H1", "CI", "œÉ¬≤"], ans: 0 }
        ],
        Medium: [
            { q: "Type I error is:", opts: ["Rejecting true null", "Failing to reject false null", "Wrong mean", "Sampling error"], ans: 0 }
        ],
        High: [
            { q: "Test power is:", opts: ["1 - Type II error", "1 - Type I error", "Variance", "Std. error"], ans: 0 }
        ]
    },
    "Regression Basics": {
        Low: [
            { q: "Regression predicts:", opts: ["Outcome variable", "Sample size", "Variance", "Errors"], ans: 0 }
        ],
        Medium: [
            { q: "Slope represents:", opts: ["Rate of change", "Mean", "Median", "CI"], ans: 0 }
        ],
        High: [
            { q: "R¬≤ is used to:", opts: ["Explain variability", "Compute p-value", "Compute n", "Fix errors"], ans: 0 }
        ]
    },
    "Practical Real-World Applications": {
        Low: [
            { q: "Which field uses statistics?", opts: ["Business", "None", "Only math", "Only art"], ans: 0 }
        ],
        Medium: [
            { q: "A/B testing is used to:", opts: ["Compare two strategies", "Find variance", "Run regression", "Estimate median"], ans: 0 }
        ],
        High: [
            { q: "Predictive analytics helps by:", opts: ["Forecasting outcomes", "Removing all errors", "Making variance 0", "Eliminating sampling"], ans: 0 }
        ]
    }
};

function generateRandomQuestions() {
    const topic = document.getElementById("topicSelect").value;
    const level = document.getElementById("levelSelect").value;
    const num = parseInt(document.getElementById("numQuestions").value) || 10;

    const pool = templates[topic] && templates[topic][level];
    if (!pool || pool.length === 0) {
        alert("No templates for this topic/level.");
        return;
    }

    let uniqueUsed = new Set(previewData.map(q => normalizeQuestionText(q.question)));
    let generated = [];
    let tries = 0;

    while (generated.length < num && tries < num * 10) {
        const item = pool[Math.floor(Math.random() * pool.length)];
        const key = normalizeQuestionText(item.q);
        if (!uniqueUsed.has(key)) {
            uniqueUsed.add(key);
            generated.push({
                id: `R${previewData.length + generated.length + 1}`,
                question: item.q,
                opt1: item.opts[0],
                opt2: item.opts[1],
                opt3: item.opts[2],
                opt4: item.opts[3],
                answer: item.ans,
                topic: topic,
                level: level
            });
        }
        tries++;
    }

    if (generated.length === 0) {
        alert("No new unique questions could be generated (pool too small).");
        return;
    }

    previewData = previewData.concat(generated);
    removeDuplicateQuestions();
    renderPreviewTable();
    document.getElementById("statusMsg").textContent =
        `‚ú® Generated ${generated.length} questions for ${topic} (${level}) (duplicates removed).`;
    document.getElementById("statusMsg").className =
        "text-blue-600 text-center text-lg font-semibold";

    document.querySelector('[data-tab="previewTab"]').click();
}
</script>

<!-- ========================================================= -->
<!-- PREVIEW TABLE + INLINE EDIT -->
<!-- ========================================================= -->
<script>
function renderPreviewTable() {
    const container = document.getElementById("previewArea");
    if (!previewData.length) {
        container.innerHTML = `<p class="text-sm text-gray-500">No questions loaded yet.</p>`;
        return;
    }

    let html = `
        <table class="min-w-full border text-xs md:text-sm">
            <thead>
                <tr class="bg-gray-200">
                    <th class="border px-2 py-1">Use</th>
                    <th class="border px-2 py-1">#</th>
                    <th class="border px-2 py-1">ID</th>
                    <th class="border px-2 py-1">Topic</th>
                    <th class="border px-2 py-1">Level</th>
                    <th class="border px-2 py-1 w-[30%]">Question</th>
                    <th class="border px-2 py-1">Opt1</th>
                    <th class="border px-2 py-1">Opt2</th>
                    <th class="border px-2 py-1">Opt3</th>
                    <th class="border px-2 py-1">Opt4</th>
                    <th class="border px-2 py-1">Ans(0-3)</th>
                    <th class="border px-2 py-1">Del</th>
                </tr>
            </thead>
            <tbody>
    `;

    previewData.forEach((q, idx) => {
        html += `
        <tr class="bg-white">
            <td class="border px-1 py-1 text-center">
                <input type="checkbox" class="select-q" data-index="${idx}" checked>
            </td>
            <td class="border px-1 py-1 text-center">${idx + 1}</td>
            <td class="border px-1 py-1" contenteditable="true" data-index="${idx}" data-field="id">${q.id || ""}</td>
            <td class="border px-1 py-1" contenteditable="true" data-index="${idx}" data-field="topic">${q.topic || ""}</td>
            <td class="border px-1 py-1" contenteditable="true" data-index="${idx}" data-field="level">${q.level || ""}</td>
            <td class="border px-1 py-1" contenteditable="true" data-index="${idx}" data-field="question">${q.question || ""}</td>
            <td class="border px-1 py-1" contenteditable="true" data-index="${idx}" data-field="opt1">${q.opt1 || ""}</td>
            <td class="border px-1 py-1" contenteditable="true" data-index="${idx}" data-field="opt2">${q.opt2 || ""}</td>
            <td class="border px-1 py-1" contenteditable="true" data-index="${idx}" data-field="opt3">${q.opt3 || ""}</td>
            <td class="border px-1 py-1" contenteditable="true" data-index="${idx}" data-field="opt4">${q.opt4 || ""}</td>
            <td class="border px-1 py-1" contenteditable="true" data-index="${idx}" data-field="answer">${q.answer ?? 0}</td>
            <td class="border px-1 py-1 text-center">
                <button class="text-red-600 font-bold text-xs" onclick="deleteQuestion(${idx})">X</button>
            </td>
        </tr>`;
    });

    html += `</tbody></table>`;
    container.innerHTML = html;
}

document.getElementById("previewArea").addEventListener("blur", function(e) {
    const target = e.target;
    const idx = target.getAttribute("data-index");
    const field = target.getAttribute("data-field");
    if (idx === null || field === null) return;

    const value = target.textContent.trim();
    if (!previewData[idx]) return;

    if (field === "answer") {
        let num = parseInt(value);
        if (isNaN(num) || num < 0 || num > 3) num = 0;
        previewData[idx][field] = num;
        target.textContent = num;
    } else {
        previewData[idx][field] = value;
    }
}, true);

function deleteQuestion(index) {
    if (!confirm("Delete this question?")) return;
    previewData.splice(index,1);
    renderPreviewTable();
}

function addEmptyQuestion() {
    previewData.push({
        id: `Q${previewData.length + 1}`,
        question: "",
        opt1: "",
        opt2: "",
        opt3: "",
        opt4: "",
        answer: 0,
        topic: "",
        level: ""
    });
    renderPreviewTable();
}

function clearPreview() {
    if (!confirm("Clear ALL questions in preview?")) return;
    previewData = [];
    renderPreviewTable();
}
</script>

<!-- ========================================================= -->
<!-- FIRESTORE UPLOAD (ÏÑ†ÌÉù / Ï†ÑÏ≤¥) + VERSIONING -->
<!-- ========================================================= -->
<script>
async function uploadSelectedQuestions() {
    if (!previewData.length) {
        alert("No questions loaded.");
        return;
    }
    const selected = [];
    document.querySelectorAll(".select-q").forEach(cb => {
        if (cb.checked) {
            const idx = parseInt(cb.dataset.index);
            selected.push(previewData[idx]);
        }
    });
    if (!selected.length) {
        alert("No questions selected.");
        return;
    }
    await saveQuestionsToFirestore(selected);
}

async function uploadAllQuestions() {
    if (!previewData.length) {
        alert("No questions loaded.");
        return;
    }
    await saveQuestionsToFirestore(previewData);
}

async function saveQuestionsToFirestore(list) {
    const docId = document.getElementById("docIdInput").value.trim() || "current";
    const questions = list.map(q => ({
        id: q.id || "",
        text: q.question || "",
        options: [q.opt1 || "", q.opt2 || "", q.opt3 || "", q.opt4 || ""],
        answer: typeof q.answer === "number" ? q.answer : parseInt(q.answer || 0),
        topic: q.topic || "",
        level: q.level || ""
    }));

    const count = questions.length;
    const versionKey = new Date().toISOString().replace(/[-:T.Z]/g, "").slice(0,14);

    try {
        await db.collection("exam_questions").doc(docId).set({
            questions,
            count,
            updatedAt: new Date().toISOString()
        });

        await db.collection("exam_questions")
                .doc("versions")
                .collection("history")
                .doc(`${docId}_${versionKey}`)
                .set({
                    docId,
                    questions,
                    count,
                    savedAt: new Date().toISOString()
                });

        downloadBackupJSON(questions, docId, versionKey);

        document.getElementById("statusMsg").innerHTML =
            `‚úÖ Uploaded ${count} questions to <span class="font-mono">${docId}</span>. Version <span class="font-mono">${docId}_${versionKey}</span> saved.`;
        document.getElementById("statusMsg").className =
            "text-green-600 text-center text-lg font-semibold";
    } catch(err) {
        console.error(err);
        alert("Upload failed.");
    }
}

function downloadBackupJSON(questions, docId, versionKey) {
    const blob = new Blob([JSON.stringify(questions, null, 2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `backup_${docId}_${versionKey}.json`;
    a.click();
    URL.revokeObjectURL(url);
}
</script>

<!-- ========================================================= -->
<!-- FINAL 100 GENERATOR LOGIC (V10) -->
<!-- ========================================================= -->
<script>
// helper: load & flatten one category file for Final 100
async function loadCategoryForFinal(filename, topicLabel) {
    const res = await fetch(`templates/${filename}`);
    if (!res.ok) throw new Error(`Cannot load ${filename}`);
    const data = await res.json();
    const out = [];
    ["Low","Medium","High"].forEach(level => {
        if (Array.isArray(data[level])) {
            data[level].forEach(q => {
                out.push({
                    question: q.q || q.text || q.question || "",
                    opt1: q.opts ? (q.opts[0] || "") : (q.options ? q.options[0] : ""),
                    opt2: q.opts ? (q.opts[1] || "") : (q.options ? q.options[1] : ""),
                    opt3: q.opts ? (q.opts[2] || "") : (q.options ? q.options[2] : ""),
                    opt4: q.opts ? (q.opts[3] || "") : (q.options ? q.options[3] : ""),
                    answer: typeof q.ans === "number" ? q.ans : parseInt(q.answer || 0),
                    topic: topicLabel,
                    level: level
                });
            });
        }
    });
    return out;
}

function renderFinal100Preview() {
    const container = document.getElementById("final100Preview");
    if (!final100Data.length) {
        container.innerHTML = `<p class="text-gray-500">No questions generated yet.</p>`;
        return;
    }
    let html = `
      <table class="min-w-full border text-xs md:text-sm">
        <thead>
          <tr class="bg-gray-200">
            <th class="border px-2 py-1">#</th>
            <th class="border px-2 py-1">Topic</th>
            <th class="border px-2 py-1">Level</th>
            <th class="border px-2 py-1 w-[35%]">Question</th>
            <th class="border px-2 py-1">Opt1</th>
            <th class="border px-2 py-1">Opt2</th>
            <th class="border px-2 py-1">Opt3</th>
            <th class="border px-2 py-1">Opt4</th>
            <th class="border px-2 py-1">Ans</th>
          </tr>
        </thead>
        <tbody>
    `;
    final100Data.forEach((q, idx) => {
        html += `
          <tr class="bg-white">
            <td class="border px-1 py-1 text-center">${idx + 1}</td>
            <td class="border px-1 py-1">${q.topic || ""}</td>
            <td class="border px-1 py-1">${q.level || ""}</td>
            <td class="border px-1 py-1">${q.question || ""}</td>
            <td class="border px-1 py-1">${q.opt1 || ""}</td>
            <td class="border px-1 py-1">${q.opt2 || ""}</td>
            <td class="border px-1 py-1">${q.opt3 || ""}</td>
            <td class="border px-1 py-1">${q.opt4 || ""}</td>
            <td class="border px-1 py-1 text-center">${q.answer}</td>
          </tr>
        `;
    });
    html += `</tbody></table>`;
    container.innerHTML = html;
}

async function generateFinal100() {
    const status = document.getElementById("final100Status");
    status.textContent = "Loading templates & generating balanced exam...";
    status.className = "mt-4 text-center text-sm text-gray-700";

    try {
        const [
            descriptive,
            probability,
            sampling,
            estimation,
            hypothesis,
            regression,
            practical
        ] = await Promise.all([
            loadCategoryForFinal("descriptive.json","Descriptive Statistics"),
            loadCategoryForFinal("probability.json","Probability"),
            loadCategoryForFinal("sampling.json","Sampling & Sampling Distribution"),
            loadCategoryForFinal("estimation.json","Estimation (Confidence Interval)"),
            loadCategoryForFinal("hypothesis.json","Hypothesis Testing"),
            loadCategoryForFinal("regression.json","Regression Basics"),
            loadCategoryForFinal("practical.json","Practical Real-World Applications")
        ]);

        final100Data = [];
        const used = new Set();

        function pickFrom(list, n) {
            let added = 0;
            const shuffled = shuffleArray(list);
            for (const q of shuffled) {
                if (added >= n) break;
                const key = normalizeQuestionText(q.question);
                if (!key || used.has(key)) continue;
                used.add(key);
                final100Data.push(q);
                added++;
            }
            return added;
        }

        pickFrom(descriptive, 15);
        pickFrom(probability, 15);
        pickFrom(sampling, 15);
        pickFrom(estimation, 15);
        pickFrom(hypothesis, 15);
        pickFrom(regression, 15);
        pickFrom(practical, 10);

        if (final100Data.length < 100) {
            status.textContent =
                `‚ö† Generated only ${final100Data.length} unique questions. Check template sizes or duplicates.`;
            status.className = "mt-4 text-center text-sm text-yellow-700";
        } else {
            status.textContent = `‚úÖ Generated ${final100Data.length} questions for the Final exam.`;
            status.className = "mt-4 text-center text-sm text-green-700";
        }

        final100Data = shuffleArray(final100Data);
        renderFinal100Preview();

    } catch (err) {
        console.error(err);
        status.textContent = "‚ùå Failed to generate Final 100. Check console.";
        status.className = "mt-4 text-center text-sm text-red-700";
    }
}

async function saveFinal100Version() {
    if (!final100Data.length) {
        alert("No Final 100 data. Please generate first.");
        return;
    }

    const versionId = prompt("Enter exam version id (e.g., final2025)", "final2025");
    if (!versionId) return;

    const questions = final100Data.map((q, idx) => ({
        index: idx + 1,
        q: q.question || "",
        opts: [q.opt1 || "", q.opt2 || "", q.opt3 || "", q.opt4 || ""],
        ans: typeof q.answer === "number" ? q.answer : parseInt(q.answer || 0),
        topic: q.topic || "",
        level: q.level || ""
    }));

    const payload = {
        title: "Statistics with SW Tools ‚Äì Fall 2025 Final Exam",
        count: questions.length,
        questions,
        createdAt: new Date().toISOString()
    };

    try {
        await db.collection("exam_versions").doc(versionId).set(payload);
        document.getElementById("final100Status").textContent =
            `‚úÖ Saved Final 100 as exam_versions / ${versionId}`;
        document.getElementById("final100Status").className =
            "mt-4 text-center text-sm text-green-700";
    } catch (err) {
        console.error(err);
        alert("Failed to save exam version.");
    }
}

async function applyAsCurrentFinal() {
    if (!final100Data.length) {
        alert("No Final 100 data. Please generate first.");
        return;
    }

    const versionId = prompt("Label for this 'current' final version? (e.g., final2025)", "final2025") || "final2025";

    const questions = final100Data.map((q, idx) => ({
        index: idx + 1,
        q: q.question || "",
        opts: [q.opt1 || "", q.opt2 || "", q.opt3 || "", q.opt4 || ""],
        ans: typeof q.answer === "number" ? q.answer : parseInt(q.answer || 0),
        topic: q.topic || "",
        level: q.level || ""
    }));

    const payload = {
        title: "Statistics with SW Tools ‚Äì Fall 2025 Final Exam",
        refVersion: versionId,
        count: questions.length,
        questions,
        updatedAt: new Date().toISOString()
    };

    try {
        await db.collection("exam_versions").doc("current").set(payload);
        document.getElementById("final100Status").textContent =
            `‚úÖ Applied this set as exam_versions / current (ref=${versionId})`;
        document.getElementById("final100Status").className =
            "mt-4 text-center text-sm text-green-700";
    } catch (err) {
        console.error(err);
        alert("Failed to apply as current final.");
    }
}
</script>

</body>
</html>
