<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin – MCQ Question Manager V3</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

</head>

<body class="bg-gray-100 min-h-screen p-10">

<!-- ========================================================= -->
<!-- PASSWORD GATE -->
<!-- ========================================================= -->
<div id="passwordGate"
     class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
    <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center">

        <h2 class="text-2xl font-bold text-purple-600 mb-4">Admin Access</h2>
        <p class="text-gray-600 mb-6">Enter the admin password to continue.</p>

        <input id="adminPass"
               type="password"
               class="w-full px-4 py-3 border rounded-lg text-center text-lg focus:ring-2 focus:ring-purple-500"
               placeholder="Enter password">

        <button onclick="checkAdminPassword()"
                class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg mt-4">
            Unlock
        </button>

        <p id="passError" class="text-red-500 font-semibold mt-3 hidden">
            ❌ Incorrect password
        </p>
    </div>
</div>

<script>
function checkAdminPassword() {
    const input = document.getElementById("adminPass").value.trim();
    if (input === "1230") {
        document.getElementById("passwordGate").classList.add("hidden");
    } else {
        document.getElementById("passError").classList.remove("hidden");
    }
}
</script>


<!-- ========================================================= -->
<!-- MAIN CONTENT -->
<!-- ========================================================= -->

<div class="max-w-6xl mx-auto bg-white p-10 rounded-2xl shadow-xl">

    <h1 class="text-4xl font-bold text-center text-purple-600 mb-10">
        Admin – MCQ Question Manager V3
    </h1>


    <!-- GRID: CSV UPLOAD + TOOLS -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">

        <!-- CSV Upload -->
        <div class="border rounded-xl p-6 bg-gray-50">
            <h2 class="text-xl font-bold mb-4 text-purple-700">Upload Questions via CSV</h2>
            <input id="csvFile" type="file" accept=".csv"
                class="w-full border p-3 rounded bg-white shadow-sm">
            <button onclick="previewCSV()"
                class="mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold">
                Preview CSV
            </button>
            <button onclick="uploadCSV()"
                class="mt-3 w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-bold">
                Upload to Firestore
            </button>
        </div>


        <!-- Tools -->
        <div class="border rounded-xl p-6 bg-gray-50">

            <h2 class="text-xl font-bold mb-4 text-purple-700">Tools</h2>

            <button onclick="downloadExampleCSV()"
                class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-bold mb-4">
                Download Example CSV
            </button>

            <button onclick="openRandomModal()"
                class="w-full bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-lg font-bold mb-4">
                Generate Random Questions (Topic + Level)
            </button>

            <button onclick="clearPreview()"
                class="w-full bg-gray-600 hover:bg-gray-700 text-white py-3 rounded-lg font-bold">
                Clear Preview
            </button>
        </div>

    </div>


    <!-- Preview Area -->
    <div id="previewArea" class="hidden mt-10">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Preview</h2>
        <div id="previewTable" class="overflow-auto border rounded-xl p-4 bg-gray-50"></div>
        <button onclick="uploadSelectedQuestions()"
            class="mt-6 w-full bg-purple-700 hover:bg-purple-800 text-white py-4 rounded-lg font-bold">
            Upload Checked Questions Only
        </button>
    </div>


    <p id="statusMsg" class="text-center mt-8 text-xl font-semibold"></p>

</div>


<!-- ========================================================= -->
<!-- RANDOM QUESTION MODAL -->
<!-- ========================================================= -->

<div id="randomModal"
     class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-6 z-50">

    <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-lg w-full">
        <h2 class="text-3xl font-bold text-purple-600 mb-6 text-center">
            Generate Random Questions
        </h2>

        <label class="block font-semibold mb-2">Select Topic:</label>
        <select id="topicSelect" class="w-full p-3 border rounded-lg mb-4">
            <option>Descriptive Statistics</option>
            <option>Probability</option>
            <option>Sampling & Sampling Distribution</option>
            <option>Estimation (Confidence Interval)</option>
            <option>Hypothesis Testing</option>
            <option>Regression Basics</option>
            <option>Practical Real-World Applications</option>
        </select>

        <label class="block font-semibold mb-2">Select Difficulty:</label>
        <select id="levelSelect" class="w-full p-3 border rounded-lg mb-4">
            <option>Low</option>
            <option>Medium</option>
            <option>High</option>
        </select>

        <label class="block font-semibold mb-2">How many questions?</label>
        <input id="numQuestions" type="number" min="1" value="10"
               class="w-full p-3 border rounded-lg mb-6">

        <button onclick="generateRandomQuestions()"
            class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-lg font-bold">
            Generate
        </button>

        <button onclick="closeRandomModal()"
            class="w-full mt-4 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-lg font-bold">
            Cancel
        </button>
    </div>
</div>


<!-- ========================================================= -->
<!-- FIREBASE INIT -->
<!-- ========================================================= -->
<script>
const firebaseConfig = {
    apiKey: "AIzaSyBGd_KrhvdCfxeRPcXn7f8csLUfcZkmKVs",
    authDomain: "sswt-final.firebaseapp.com",
    projectId: "sswt-final",
    storageBucket: "sswt-final.firebasestorage.app",
    messagingSenderId: "824707188580",
    appId: "1:824707188580:web:747ba4d91ab781e1a15c71"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
</script>



<!-- ========================================================= -->
<!-- CSV PARSING -->
<!-- ========================================================= -->
<script>
let previewData = [];

function parseCSV(text) {
    const lines = text.trim().split("\n");
    const headers = lines[0].split(",").map(h => h.trim());

    return lines.slice(1).map(line => {
        const cols = line.split(",").map(c => c.trim());
        let obj = {};
        headers.forEach((h, i) => (obj[h] = cols[i]));
        return obj;
    });
}

function previewCSV() {
    const file = document.getElementById("csvFile").files[0];
    if (!file) return alert("Please select a CSV file.");

    const reader = new FileReader();
    reader.onload = e => {
        previewData = parseCSV(e.target.result);
        renderPreviewTable(previewData);
    };
    reader.readAsText(file);
}
</script>



<!-- ========================================================= -->
<!-- PREVIEW TABLE RENDER -->
<!-- ========================================================= -->
<script>
function renderPreviewTable(data) {
    const area = document.getElementById("previewArea");
    const tbl = document.getElementById("previewTable");

    if (data.length === 0) {
        tbl.innerHTML = "<p>No data loaded.</p>";
        return;
    }

    let html = `
    <table class="min-w-full border text-sm">
        <thead>
            <tr class="bg-gray-200">
                <th class="border px-2 py-2">Use</th>
                ${Object.keys(data[0]).map(h => `<th class="border px-3 py-2">${h}</th>`).join("")}
            </tr>
        </thead>
        <tbody>
    `;

    data.forEach((row, idx) => {
        html += `
        <tr class="bg-white">
            <td class="border px-2 py-2 text-center">
                <input type="checkbox" class="select-q" data-index="${idx}" checked>
            </td>
            ${Object.values(row).map(v => `<td class="border px-3 py-2">${v}</td>`).join("")}
        </tr>`;
    });

    html += `</tbody></table>`;

    tbl.innerHTML = html;
    area.classList.remove("hidden");
}

function clearPreview() {
    previewData = [];
    document.getElementById("previewArea").classList.add("hidden");
    document.getElementById("previewTable").innerHTML = "";
}
</script>



<!-- ========================================================= -->
<!-- UPLOAD CSV + VERSIONING + BACKUP -->
<!-- ========================================================= -->
<script>
async function uploadCSV() {
    if (previewData.length === 0)
        return alert("Preview data first.");

    const questions = previewData.map(row => ({
        id: row.id,
        text: row.question,
        options: [row.opt1, row.opt2, row.opt3, row.opt4],
        answer: parseInt(row.answer)
    }));

    await saveQuestionsToFirestore(questions);
}
</script>



<!-- ========================================================= -->
<!-- UPLOAD SELECTED (CHECKBOX) QUESTIONS -->
<!-- ========================================================= -->
<script>
async function uploadSelectedQuestions() {
    const checkboxes = document.querySelectorAll(".select-q");

    let selected = [];

    checkboxes.forEach(cb => {
        if (cb.checked) {
            const q = previewData[cb.dataset.index];
            selected.push({
                id: q.id,
                text: q.question,
                options: [q.opt1, q.opt2, q.opt3, q.opt4],
                answer: parseInt(q.answer)
            });
        }
    });

    if (selected.length === 0) {
        alert("No questions selected.");
        return;
    }

    await saveQuestionsToFirestore(selected);
}
</script>



<!-- ========================================================= -->
<!-- SAVE TO FIRESTORE + VERSIONING -->
<!-- ========================================================= -->
<script>
async function saveQuestionsToFirestore(questions) {
    const count = questions.length;
    const versionKey = new Date().toISOString().replace(/[-:T.Z]/g, "").slice(0, 14);

    try {
        // Save current
        await db.collection("exam_questions").doc("current").set({
            questions: questions,
            count: count,
            updatedAt: new Date().toISOString()
        });

        // Save version
        await db.collection("exam_questions")
            .doc("versions")
            .collection("history")
            .doc(versionKey)
            .set({
                questions: questions,
                count: count,
                savedAt: new Date().toISOString()
            });

        // Backup
        downloadBackupJSON(questions, versionKey);

        document.getElementById("statusMsg").innerHTML =
            `✅ Uploaded ${count} questions. Version ${versionKey} saved.`;
        document.getElementById("statusMsg").className =
            "text-green-600 text-center text-xl font-semibold";

    } catch (err) {
        console.error(err);
        alert("Upload failed.");
    }
}

function downloadBackupJSON(questions, versionKey) {
    const blob = new Blob([JSON.stringify(questions, null, 2)], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `backup_${versionKey}.json`;
    a.click();
    URL.revokeObjectURL(url);
}
</script>



<!-- ========================================================= -->
<!-- EXAMPLE CSV DOWNLOAD -->
<!-- ========================================================= -->
<script>
function downloadExampleCSV() {
    const sample =
`id,question,opt1,opt2,opt3,opt4,answer
Q1,What is variance?,Spread,Mean,Median,P-value,0
Q2,What is a p-value?,Prob under null,Mean diff,Std dev,CI,0
Q3,What is Type I error?,Reject true null,Accept true null,Bias,Sampling error,0`;

    const blob = new Blob([sample], { type: "text/csv" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = "example_questions.csv";
    a.click();

    URL.revokeObjectURL(url);
}
</script>



<!-- ========================================================= -->
<!-- RANDOM QUESTION GENERATOR -->
<!-- ========================================================= -->
<script>
function openRandomModal() {
    document.getElementById("randomModal").classList.remove("hidden");
}
function closeRandomModal() {
    document.getElementById("randomModal").classList.add("hidden");
}

/* 문제 템플릿 */
const templates = {
    "Descriptive Statistics": {
        Low: [
            { q: "What does the mean represent?", opts: ["Average", "Median", "Mode", "Range"], ans: 0 },
            { q: "Which is a measure of spread?", opts: ["Variance", "Mean", "Median", "Mode"], ans: 0 }
        ],
        Medium: [
            { q: "What is the purpose of standard deviation?", opts: ["Measure variability", "Measure center", "Test hypothesis", "Compute CI"], ans: 0 }
        ],
        High: [
            { q: "Why is variance squared but standard deviation not?", opts: ["Mathematical convenience", "Historical reason", "Statistical culture", "No reason"], ans: 0 }
        ]
    },

    "Probability": {
        Low: [
            { q: "What is the probability of a fair coin landing heads?", opts: ["1/2", "1/3", "1/4", "1"], ans: 0 }
        ],
        Medium: [
            { q: "What is conditional probability?", opts: ["Probability given another event", "Probability of everything", "Simple chance", "Impossible events"], ans: 0 }
        ],
        High: [
            { q: "Bayes' theorem connects which two probabilities?", opts: ["Prior and Posterior", "Mean and Variance", "CI and Margin of Error", "Slope and Intercept"], ans: 0 }
        ]
    },

    "Sampling & Sampling Distribution": {
        Low: [
            { q: "What is a sample?", opts: ["Subset of population", "Entire population", "Median", "Error"], ans: 0 }
        ],
        Medium: [
            { q: "Sampling distribution refers to distribution of what?", opts: ["Statistics", "Data", "Errors", "Residuals"], ans: 0 }
        ],
        High: [
            { q: "Why is the sampling distribution important?", opts: ["Basis of inference", "Improves mean", "Creates variance", "Removes error"], ans: 0 }
        ]
    },

    "Estimation (Confidence Interval)": {
        Low: [
            { q: "What does a CI estimate?", opts: ["Population parameter", "Sample mean", "Variance", "P-value"], ans: 0 }
        ],
        Medium: [
            { q: "95% CI means:", opts: ["Interval capturing true parameter 95% of time", "95% of data points included", "Mean is 95%", "Variance is small"], ans: 0 }
        ],
        High: [
            { q: "CI width depends on:", opts: ["Variability", "Season", "Color", "Time of day"], ans: 0 }
        ]
    },

    "Hypothesis Testing": {
        Low: [
            { q: "Null hypothesis symbol?", opts: ["H0", "H1", "CI", "σ²"], ans: 0 }
        ],
        Medium: [
            { q: "Type I error is:", opts: ["Reject true null", "Accept true null", "Wrong variance", "Sampling bias"], ans: 0 }
        ],
        High: [
            { q: "Power of a test is:", opts: ["1 - Type II error", "1 - Type I error", "Variance", "CI"], ans: 0 }
        ]
    },

    "Regression Basics": {
        Low: [
            { q: "Regression predicts:", opts: ["Outcome variable", "Sample size", "Variance", "Random errors"], ans: 0 }
        ],
        Medium: [
            { q: "Slope represents:", opts: ["Rate of change", "Mean", "Variance", "CI"], ans: 0 }
        ],
        High: [
            { q: "Purpose of R²:", opts: ["Explain variability", "Compute slope", "Compute CI", "Test variance"], ans: 0 }
        ]
    },

    "Practical Real-World Applications": {
        Low: [
            { q: "Which field uses statistics?", opts: ["Business", "Cooking", "Music", "Painting"], ans: 0 }
        ],
        Medium: [
            { q: "A/B testing is used for:", opts: ["Compare two strategies", "Find CI", "Compute regression", "Estimate variance"], ans: 0 }
        ],
        High: [
            { q: "Predictive analytics helps by:", opts: ["Forecasting outcomes", "Removing variance", "Reducing errors to zero", "Finding exact parameters"], ans: 0 }
        ]
    }
};

function generateRandomQuestions() {

    const topic = document.getElementById("topicSelect").value;
    const level = document.getElementById("levelSelect").value;
    const num = parseInt(document.getElementById("numQuestions").value) || 10;

    const pool = templates[topic][level];
    if (!pool || pool.length === 0) {
        alert("No templates available.");
        return;
    }

    let uniqueSet = new Set(previewData.map(q => q.question.toLowerCase()));
    let result = [];

    for (let i = 0; i < num; i++) {
        let item;
        let tries = 0;

        do {
            item = pool[Math.floor(Math.random() * pool.length)];
            tries++;
        } while (uniqueSet.has(item.q.toLowerCase()) && tries < 20);

        uniqueSet.add(item.q.toLowerCase());

        result.push({
            id: "R" + (previewData.length + result.length + 1),
            question: item.q,
            opt1: item.opts[0],
            opt2: item.opts[1],
            opt3: item.opts[2],
            opt4: item.opts[3],
            answer: item.ans
        });
    }

    previewData = previewData.concat(result);
    renderPreviewTable(previewData);
    document.getElementById("previewArea").classList.remove("hidden");
    closeRandomModal();

    document.getElementById("statusMsg").innerHTML =
        `✨ Generated ${num} questions for topic <strong>${topic}</strong> (level: ${level}).`;
    document.getElementById("statusMsg").className =
        "text-blue-600 text-center text-lg font-semibold";
}
</script>

</body>
</html>
