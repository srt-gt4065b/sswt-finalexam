<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹œí—˜ ê²°ê³¼ ë¦¬í¬íŠ¸ ìƒì„±ê¸°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .action-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .action-section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        button {
            padding: 15px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
        }

        .student-list {
            max-height: 400px;
            overflow-y: auto;
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 15px;
        }

        .student-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .student-item:last-child {
            border-bottom: none;
        }

        .student-info {
            flex: 1;
        }

        .student-name {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
        }

        .student-details {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #eee;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .log-area {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            margin-top: 20px;
        }

        .log-entry {
            margin-bottom: 5px;
        }

        /* ë¦¬í¬íŠ¸ ë¯¸ë¦¬ë³´ê¸° ìŠ¤íƒ€ì¼ */
        .report-preview {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 30px;
            background: white;
            margin: 20px 0;
            display: none;
        }

        .report-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid #667eea;
        }

        .report-title {
            font-size: 2em;
            color: #333;
            margin-bottom: 10px;
        }

        .report-subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 30px 0;
        }

        .info-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .info-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #333;
        }

        .chart-container {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .problem-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 5px;
            margin: 20px 0;
        }

        .problem-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .problem-correct {
            background: #28a745;
            color: white;
        }

        .problem-wrong {
            background: #dc3545;
            color: white;
        }

        .problem-cell:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .explanation-section {
            margin: 30px 0;
        }

        .explanation-item {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin: 15px 0;
            border-radius: 5px;
        }

        .explanation-question {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .explanation-answer {
            color: #dc3545;
            margin: 5px 0;
        }

        .explanation-correct {
            color: #28a745;
            margin: 5px 0;
        }

        .explanation-detail {
            color: #666;
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.2em;
        }

        /* ë¡œê·¸ì¸ í™”ë©´ ìŠ¤íƒ€ì¼ */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .login-container {
            background: white;
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-container h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .login-subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1em;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .login-form input[type="password"] {
            padding: 15px;
            font-size: 1.1em;
            border: 2px solid #ddd;
            border-radius: 10px;
            text-align: center;
        }

        .login-form input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
        }

        .login-form button {
            padding: 15px;
            font-size: 1.2em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .login-error {
            color: #dc3545;
            font-size: 0.9em;
            min-height: 20px;
        }
    </style>
</head>
<body>
    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="loginScreen" class="login-screen">
        <div class="login-container">
            <h1>ğŸ” ê´€ë¦¬ì ë¡œê·¸ì¸</h1>
            <p class="login-subtitle">ì‹œí—˜ ê²°ê³¼ ë¦¬í¬íŠ¸ ìƒì„±ê¸°</p>
            <div class="login-form">
                <input type="password" id="passwordInput" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" onkeypress="if(event.key==='Enter') checkPassword()">
                <button onclick="checkPassword()">ë¡œê·¸ì¸</button>
                <div id="loginError" class="login-error"></div>
            </div>
        </div>
    </div>

    <!-- ê´€ë¦¬ì í˜ì´ì§€ (ë¡œê·¸ì¸ í›„ í‘œì‹œ) -->
    <div class="container" id="adminContent" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <h1>ğŸ“Š ì‹œí—˜ ê²°ê³¼ ë¦¬í¬íŠ¸ ìƒì„±ê¸°</h1>
                <p class="subtitle">í•™ìƒë³„ ì‹œí—˜ ê²°ê³¼ ë¶„ì„ ë° PDF ë¦¬í¬íŠ¸ ìë™ ìƒì„±</p>
            </div>
            <button class="btn-danger" onclick="logout()" style="height: fit-content; background: #dc3545; color: white;">
                ğŸšª ë¡œê·¸ì•„ì›ƒ
            </button>
        </div>

        <!-- í†µê³„ ì¹´ë“œ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">ì´ ì‘ì‹œ í•™ìƒ</div>
                <div class="stat-value" id="totalStudents">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">í‰ê·  ì ìˆ˜</div>
                <div class="stat-value" id="avgScore">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ìµœê³  ì ìˆ˜</div>
                <div class="stat-value" id="maxScore">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">ìµœì € ì ìˆ˜</div>
                <div class="stat-value" id="minScore">0</div>
            </div>
        </div>

        <!-- ì•¡ì…˜ ë²„íŠ¼ -->
        <div class="action-section">
            <h2>ğŸ¯ ë¦¬í¬íŠ¸ ìƒì„±</h2>
            <div class="button-group">
                <button class="btn-primary" onclick="loadStudents()">
                    ğŸ”„ í•™ìƒ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                </button>
                <button class="btn-success" id="generateAllBtn" onclick="generateAllReports()" disabled>
                    ğŸ“„ ì „ì²´ PDF ìƒì„± (ZIP)
                </button>
                <button class="btn-warning" id="previewBtn" onclick="showPreview()" disabled>
                    ğŸ‘ï¸ ë¯¸ë¦¬ë³´ê¸°
                </button>
            </div>

            <!-- ì§„í–‰ë¥  í‘œì‹œ -->
            <div id="progressContainer" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar">0%</div>
                </div>
            </div>
        </div>

        <!-- í•™ìƒ ëª©ë¡ -->
        <div class="action-section">
            <h2>ğŸ‘¥ ì‘ì‹œ í•™ìƒ ëª©ë¡</h2>
            <div class="student-list" id="studentList">
                <div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ë ¤ë©´ 'í•™ìƒ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</div>
            </div>
        </div>

        <!-- ë¦¬í¬íŠ¸ ë¯¸ë¦¬ë³´ê¸° -->
        <div class="report-preview" id="reportPreview">
            <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
        </div>

        <!-- ë¡œê·¸ ì˜ì—­ -->
        <div class="action-section">
            <h2>ğŸ“ ì‘ì—… ë¡œê·¸</h2>
            <div class="log-area" id="logArea">
                <div class="log-entry">ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ...</div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- FileSaver.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        // âš ï¸ ë¹„ë°€ë²ˆí˜¸ ì„¤ì •
        const ADMIN_PASSWORD = "1230";

        // âš ï¸ Firebase ì„¤ì •ì„ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”
        const firebaseConfig = {
            apiKey: "AIzaSyBGd_KrhvdCfxeRPcXn7f8csLUfcZkmKVs",
  authDomain: "sswt-final.firebaseapp.com",
  projectId: "sswt-final",
  storageBucket: "sswt-final.firebasestorage.app",
  messagingSenderId: "824707188580",
  appId: "1:824707188580:web:747ba4d91ab781e1a15c71",
  measurementId: "G-VKYGVZCS2T"
        };

        // Firebase ì´ˆê¸°í™”
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let studentsData = [];
        let questionsData = {};

        // ë¹„ë°€ë²ˆí˜¸ í™•ì¸
        function checkPassword() {
            const input = document.getElementById('passwordInput').value;
            const errorDiv = document.getElementById('loginError');

            if(input === ADMIN_PASSWORD) {
                // ë¡œê·¸ì¸ ì„±ê³µ
                sessionStorage.setItem('reportLoggedIn', 'true');
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminContent').style.display = 'block';
                addLog('ğŸ”“ ê´€ë¦¬ì ë¡œê·¸ì¸ ì„±ê³µ');
            } else {
                // ë¡œê·¸ì¸ ì‹¤íŒ¨
                errorDiv.textContent = 'âŒ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                document.getElementById('passwordInput').value = '';
                document.getElementById('passwordInput').focus();
            }
        }

        // ë¡œê·¸ì•„ì›ƒ
        function logout() {
            if(confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                sessionStorage.removeItem('reportLoggedIn');
                document.getElementById('loginScreen').style.display = 'flex';
                document.getElementById('adminContent').style.display = 'none';
                document.getElementById('passwordInput').value = '';
                addLog('ğŸšª ë¡œê·¸ì•„ì›ƒ ì™„ë£Œ');
            }
        }

        // ì„¸ì…˜ í™•ì¸
        function checkSession() {
            const isLoggedIn = sessionStorage.getItem('reportLoggedIn');
            if(isLoggedIn === 'true') {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('adminContent').style.display = 'block';
                return true;
            }
            return false;
        }

        // ë¡œê·¸ ì¶”ê°€
        function addLog(message) {
            const logArea = document.getElementById('logArea');
            const time = new Date().toLocaleTimeString('ko-KR');
            logArea.innerHTML += `<div class="log-entry">[${time}] ${message}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        // í•™ìƒ ë°ì´í„° ë¡œë“œ
        async function loadStudents() {
            addLog('ğŸ“¥ í•™ìƒ ë°ì´í„° ë¡œë”© ì‹œì‘...');
            const studentList = document.getElementById('studentList');
            studentList.innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            try {
                // exam_responsesì—ì„œ í•™ìƒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const responsesSnapshot = await db.collection('exam_responses').orderBy('createdAt', 'desc').get();
                studentsData = [];

                for(const doc of responsesSnapshot.docs) {
                    const data = doc.data();
                    
                    // questions ê°€ì ¸ì˜¤ê¸°
                    let questions = [];
                    if(Array.isArray(data.questions)) {
                        questions = data.questions;
                    } else if(data.examDocId) {
                        // exam_questionsì—ì„œ ê°€ì ¸ì˜¤ê¸°
                        const bankDoc = await db.collection('exam_questions').doc(data.examDocId).get();
                        if(bankDoc.exists) {
                            const raw = bankDoc.data().questions || [];
                            questions = Array.isArray(raw) ? raw : Object.values(raw);
                        }
                    }
                    
                    // answers ë°°ì—´
                    const answers = Array.isArray(data.answers) ? data.answers : [];
                    
                    // ì •ë‹µ ê°œìˆ˜ ê³„ì‚°
                    let correctCount = 0;
                    questions.forEach((q, idx) => {
                        let a = answers.find(x => x.index === idx);
                        if(!a && q.id) a = answers.find(x => x.qId === q.id);
                        
                        const selIdx = a ? a.selected : null;
                        const qAnswer = typeof q.answer === 'number' ? q.answer : parseInt(q.answer || 0, 10);
                        
                        if(selIdx === qAnswer) {
                            correctCount++;
                        }
                    });
                    
                    // ë””ë²„ê¹…: ì²« ë²ˆì§¸ ë°ì´í„° êµ¬ì¡° í™•ì¸
                    if(studentsData.length === 0) {
                        console.log('ğŸ“Š ì²« ë²ˆì§¸ í•™ìƒ ë°ì´í„°:', data);
                        console.log('ğŸ“‹ questions ê°œìˆ˜:', questions.length);
                        console.log('ğŸ“‹ answers ê°œìˆ˜:', answers.length);
                        console.log('âœ… ê³„ì‚°ëœ ì •ë‹µ ìˆ˜:', correctCount);
                        console.log('ğŸ’¾ ì €ì¥ëœ ì ìˆ˜:', data.score);
                        addLog(`ğŸ“‹ ë°ì´í„° êµ¬ì¡°: questions=${questions.length}, answers=${answers.length}, score=${correctCount}`);
                    }
                    
                    studentsData.push({
                        id: doc.id,
                        studentId: data.studentId || '-',
                        studentName: data.studentName || '-',
                        score: correctCount, // ì¬ê³„ì‚°ëœ ì ìˆ˜ ì‚¬ìš©
                        startedAt: data.createdAt || data.startedAt || null,
                        timeUsedSeconds: data.timeUsedSeconds || 0,
                        totalQuestions: questions.length || 100,
                        questions: questions,  // ë¬¸ì œ ë°°ì—´
                        answers: answers,      // ë‹µì•ˆ ë°°ì—´
                        examDocId: data.examDocId || ''
                    });
                }

                // exam_questionsì—ì„œ ë¬¸ì œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ë³„ë„)
                const questionsSnapshot = await db.collection('exam_questions').get();
                questionsSnapshot.forEach(doc => {
                    const data = doc.data();
                    questionsData[doc.id] = data;
                });

                // í†µê³„ ê³„ì‚°
                if(studentsData.length > 0) {
                    const scores = studentsData.map(s => s.score);
                    const avgScore = (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(1);
                    const maxScore = Math.max(...scores);
                    const minScore = Math.min(...scores);

                    document.getElementById('totalStudents').textContent = studentsData.length;
                    document.getElementById('avgScore').textContent = avgScore;
                    document.getElementById('maxScore').textContent = maxScore;
                    document.getElementById('minScore').textContent = minScore;
                }

                // í•™ìƒ ëª©ë¡ í‘œì‹œ
                displayStudentList();

                // ë²„íŠ¼ í™œì„±í™”
                document.getElementById('generateAllBtn').disabled = false;
                document.getElementById('previewBtn').disabled = false;

                addLog(`âœ… ${studentsData.length}ëª…ì˜ í•™ìƒ ë°ì´í„° ë¡œë“œ ì™„ë£Œ`);
                addLog(`âœ… ${Object.keys(questionsData).length}ê°œì˜ ì‹œí—˜ ë¬¸ì œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ`);
            } catch (error) {
                addLog(`âŒ ì˜¤ë¥˜: ${error.message}`);
                console.error('Load error:', error);
                studentList.innerHTML = '<div class="loading">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>';
            }
        }

        // í•™ìƒ ëª©ë¡ í‘œì‹œ
        function displayStudentList() {
            const studentList = document.getElementById('studentList');
            
            if(studentsData.length === 0) {
                studentList.innerHTML = '<div class="loading">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                return;
            }

            studentList.innerHTML = studentsData.map((student, index) => {
                const time = student.startedAt ? new Date(student.startedAt).toLocaleString('ko-KR') : '-';
                const percentage = ((student.score / student.totalQuestions) * 100).toFixed(1);
                
                return `
                    <div class="student-item">
                        <div class="student-info">
                            <div class="student-name">${index + 1}. ${student.studentName} (${student.studentId})</div>
                            <div class="student-details">
                                ì ìˆ˜: ${student.score}/${student.totalQuestions} (${percentage}%) | 
                                ì‹œê°„: ${Math.floor(student.timeUsedSeconds / 60)}ë¶„ ${student.timeUsedSeconds % 60}ì´ˆ | 
                                ì‘ì‹œ: ${time}
                            </div>
                        </div>
                        <button class="btn-primary" onclick="generateSingleReport(${index})" style="padding: 8px 16px; font-size: 0.9em;">
                            ğŸ“„ PDF
                        </button>
                    </div>
                `;
            }).join('');
        }

        // ë¦¬í¬íŠ¸ ë¯¸ë¦¬ë³´ê¸°
        function showPreview() {
            if(studentsData.length === 0) {
                alert('í•™ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const student = studentsData[0];
            const previewDiv = document.getElementById('reportPreview');
            
            previewDiv.innerHTML = generateReportHTML(student);
            previewDiv.style.display = 'block';
            
            // ì°¨íŠ¸ ìƒì„±
            createCharts(student);
            
            addLog('ğŸ‘ï¸ ì²« ë²ˆì§¸ í•™ìƒ ë¦¬í¬íŠ¸ ë¯¸ë¦¬ë³´ê¸°');
        }

        // ë¦¬í¬íŠ¸ HTML ìƒì„±
        function generateReportHTML(student) {
            const percentage = ((student.score / student.totalQuestions) * 100).toFixed(1);
            const time = student.startedAt ? new Date(student.startedAt).toLocaleString('ko-KR') : '-';
            
            // í‹€ë¦° ë¬¸ì œ ì°¾ê¸° (admin2.html ë°©ì‹)
            const wrongProblems = [];
            const questions = student.questions || [];
            const answers = student.answers || [];
            
            questions.forEach((q, idx) => {
                let a = answers.find(x => x.index === idx);
                if(!a && q.id) a = answers.find(x => x.qId === q.id);
                
                const selIdx = a ? a.selected : null;
                const qAnswer = typeof q.answer === 'number' ? q.answer : parseInt(q.answer || 0, 10);
                
                const isCorrect = (selIdx === qAnswer);
                if(!isCorrect) {
                    wrongProblems.push(idx);
                }
            });
            
            const wrongCount = wrongProblems.length;

            let html = `
                <div class="report-header">
                    <div class="report-title">ğŸ“Š ì‹œí—˜ ê²°ê³¼ ë¦¬í¬íŠ¸</div>
                    <div class="report-subtitle">ê°œì¸ë³„ ì„±ì  ë¶„ì„ ë° ì˜¤ë‹µ í•´ì„¤</div>
                </div>

                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">í•™ë²ˆ</div>
                        <div class="info-value">${student.studentId}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ì´ë¦„</div>
                        <div class="info-value">${student.studentName}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ì ìˆ˜</div>
                        <div class="info-value">${student.score} / ${student.totalQuestions}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ì •ë‹µë¥ </div>
                        <div class="info-value">${percentage}%</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ì†Œìš” ì‹œê°„</div>
                        <div class="info-value">${Math.floor(student.timeUsedSeconds / 60)}ë¶„ ${student.timeUsedSeconds % 60}ì´ˆ</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ì‘ì‹œ ì‹œê°„</div>
                        <div class="info-value">${time}</div>
                    </div>
                </div>

                <div class="chart-container">
                    <h3 style="margin-bottom: 15px;">ğŸ“ˆ ì ìˆ˜ ë¶„ì„</h3>
                    <canvas id="scoreChart" width="400" height="200"></canvas>
                </div>

                <div style="margin: 30px 0;">
                    <h3 style="margin-bottom: 15px;">ğŸ¯ ë¬¸ì œë³„ ì •ì˜¤ë‹µ í˜„í™© (ì´ ${student.totalQuestions}ë¬¸ì œ)</h3>
                    <div class="problem-grid">
            `;

            // ë¬¸ì œë³„ ì •ì˜¤ë‹µ ê·¸ë¦¬ë“œ
            for(let i = 0; i < student.totalQuestions; i++) {
                const isCorrect = student.correctAnswers[i] === 0;
                const className = isCorrect ? 'problem-correct' : 'problem-wrong';
                html += `<div class="problem-cell ${className}" title="ë¬¸ì œ ${i + 1}">${i + 1}</div>`;
            }

            html += `
                    </div>
                </div>

                <div class="explanation-section">
                    <h3 style="margin-bottom: 15px;">âŒ ì˜¤ë‹µ ë¶„ì„ (${wrongCount}ê°œ)</h3>
            `;

            if(wrongProblems.length === 0) {
                html += '<p style="text-align: center; padding: 30px; color: #28a745; font-size: 1.2em;">ğŸ‰ ëª¨ë“  ë¬¸ì œë¥¼ ë§í˜”ìŠµë‹ˆë‹¤!</p>';
            } else {
                // í‹€ë¦° ë¬¸ì œ ì¤‘ ì¼ë¶€ë§Œ í‘œì‹œ (ì¤‘ìš” ë¬¸ì œ)
                const importantWrong = wrongProblems.slice(0, Math.min(10, wrongProblems.length));
                
                importantWrong.forEach(problemNum => {
                    const userAnswer = student.userAnswers[problemNum] || '-';
                    html += `
                        <div class="explanation-item">
                            <div class="explanation-question">ğŸ“Œ ë¬¸ì œ ${problemNum + 1}</div>
                            <div class="explanation-answer">âŒ ì„ íƒí•œ ë‹µ: ${userAnswer}</div>
                            <div class="explanation-correct">âœ… ì •ë‹µ: (ë¬¸ì œ ë°ì´í„°ì—ì„œ ê°€ì ¸ì˜¤ê¸°)</div>
                            <div class="explanation-detail">
                                <strong>ğŸ’¡ í•´ì„¤:</strong><br>
                                ì´ ë¬¸ì œëŠ” [ê°œë…]ì— ëŒ€í•œ ë¬¸ì œì…ë‹ˆë‹¤. [ìƒì„¸ í•´ì„¤ ë‚´ìš©]
                            </div>
                        </div>
                    `;
                });

                if(wrongProblems.length > 10) {
                    html += `<p style="text-align: center; color: #666; margin-top: 20px;">ë‚˜ë¨¸ì§€ ${wrongProblems.length - 10}ê°œì˜ í‹€ë¦° ë¬¸ì œëŠ” PDFì—ì„œ í™•ì¸í•˜ì„¸ìš”.</p>`;
                }
            }

            html += `
                </div>
            `;

            return html;
        }

        // ì°¨íŠ¸ ìƒì„±
        function createCharts(student) {
            const ctx = document.getElementById('scoreChart');
            if(!ctx) return;

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ì •ë‹µ', 'ì˜¤ë‹µ'],
                    datasets: [{
                        label: 'ë¬¸ì œ ìˆ˜',
                        data: [student.score, student.totalQuestions - student.score],
                        backgroundColor: [
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(220, 53, 69, 0.8)'
                        ],
                        borderColor: [
                            'rgba(40, 167, 69, 1)',
                            'rgba(220, 53, 69, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 10
                            }
                        }
                    }
                }
            });
        }

        // ë‹¨ì¼ í•™ìƒ PDF ìƒì„± (ì™„ì „íˆ ìƒˆë¡œìš´ ë””ìì¸)
        async function generateSingleReport(index) {
            const student = studentsData[index];
            addLog(`ğŸ“„ ${student.studentName} í•™ìƒì˜ ë¦¬í¬íŠ¸ ìƒì„± ì¤‘...`);

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const pageWidth = 210; // A4 width in mm
                const pageHeight = 297; // A4 height in mm
                const margin = 10;

                // ========== í—¤ë” (íŒŒë€ìƒ‰) ==========
                doc.setFillColor(102, 126, 234);
                doc.rect(0, 0, pageWidth, 30, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.text('WOOSONG UNIVERSITY', pageWidth / 2, 12, { align: 'center' });
                doc.setFontSize(12);
                doc.text('AI Management Department', pageWidth / 2, 22, { align: 'center' });

                // ========== Student's Information ì„¹ì…˜ ==========
                let currentY = 35;
                
                // í…Œë‘ë¦¬
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.5);
                doc.rect(margin, currentY, pageWidth - 2 * margin, 20);
                
                // ì œëª©
                doc.setTextColor(0, 0, 0);
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text("Student's Information", pageWidth / 2, currentY + 10, { align: 'center' });
                
                // í•™ìƒ ì •ë³´ (ì‘ê²Œ)
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                const score = student.score || 0;
                const total = student.totalQuestions || 100;
                const percentage = ((score / total) * 100).toFixed(1);
                const time = student.startedAt ? new Date(student.startedAt).toLocaleString('ko-KR') : '-';
                
                doc.text(`ID: ${student.studentId}  |  Name: ${student.studentName}  |  Score: ${score}/${total} (${percentage}%)  |  Time: ${Math.floor(student.timeUsedSeconds / 60)}m ${student.timeUsedSeconds % 60}s`, pageWidth / 2, currentY + 16, { align: 'center' });

                currentY += 25;

                // ========== Answer Sheet (ì „í­) ==========
                // í…Œë‘ë¦¬
                const answerSheetHeight = 140;
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.5);
                doc.rect(margin, currentY, pageWidth - 2 * margin, answerSheetHeight);
                
                // ì œëª©
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text('Answer Sheet', margin + 3, currentY + 6);
                
                // ë§¤íŠ¸ë¦­ìŠ¤ (20í–‰ Ã— 5ì—´)
                const matrixStartY = currentY + 10;
                const rows = 20;
                const cols = 5;
                const cellSize = 6;
                const gapX = 1.5;
                const gapY = 0.8;
                
                // ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•œ ì‹œì‘ X ì¢Œí‘œ
                const matrixWidth = cols * cellSize + (cols - 1) * gapX;
                const matrixStartX = (pageWidth - matrixWidth) / 2;
                
                // í‹€ë¦° ë¬¸ì œ ìˆ˜ì§‘
                const wrongProblems = [];
                const questions = student.questions || [];
                const answers = student.answers || [];
                
                for(let i = 0; i < total; i++) {
                    const col = Math.floor(i / rows);
                    const row = i % rows;
                    const x = matrixStartX + col * (cellSize + gapX);
                    const y = matrixStartY + row * (cellSize + gapY);
                    
                    // ì •ë‹µ íŒë‹¨
                    let isCorrect = false;
                    if(i < questions.length) {
                        const q = questions[i];
                        let a = answers.find(x => x.index === i);
                        if(!a && q.id) a = answers.find(x => x.qId === q.id);
                        
                        const selIdx = a ? a.selected : null;
                        const qAnswer = typeof q.answer === 'number' ? q.answer : parseInt(q.answer || 0, 10);
                        
                        isCorrect = (selIdx === qAnswer);
                        
                        // ì˜¤ë‹µ ìˆ˜ì§‘
                        if(!isCorrect) {
                            const options = q.options || [];
                            const selectedText = selIdx != null && options[selIdx] ? options[selIdx] : 'N/A';
                            const correctText = options[qAnswer] || 'N/A';
                            
                            wrongProblems.push({
                                num: i + 1,
                                userAnswer: selectedText,
                                correctAnswer: correctText,
                                questionText: q.text || q.question || ''
                            });
                        }
                    }
                    
                    // í…Œë‘ë¦¬
                    doc.setDrawColor(200, 200, 200);
                    doc.setLineWidth(0.1);
                    doc.rect(x, y, cellSize, cellSize);
                    
                    // ë¬¸ì œ ë²ˆí˜¸
                    doc.setFontSize(5);
                    doc.setTextColor(100, 100, 100);
                    doc.text(String(i + 1), x + 0.8, y + 2.5);
                    
                    if(isCorrect) {
                        // íŒŒë€ O
                        doc.setDrawColor(0, 123, 255);
                        doc.setLineWidth(0.4);
                        doc.circle(x + cellSize - 1.5, y + cellSize - 1.5, 1.2);
                    } else {
                        // ë¹¨ê°„ X
                        doc.setDrawColor(220, 53, 69);
                        doc.setLineWidth(0.4);
                        const xSize = 1.2;
                        const cx = x + cellSize - 1.5;
                        const cy = y + cellSize - 1.5;
                        doc.line(cx - xSize, cy - xSize, cx + xSize, cy + xSize);
                        doc.line(cx - xSize, cy + xSize, cx + xSize, cy - xSize);
                    }
                }

                currentY += answerSheetHeight + 5;

                // ========== Wrong Answers (2ë‹¨ ë ˆì´ì•„ì›ƒ) ==========
                // ì¢Œìš° í…Œë‘ë¦¬
                const columnWidth = (pageWidth - 2 * margin - 5) / 2; // ì¤‘ê°„ ê°„ê²© 5mm
                
                // ì™¼ìª½ ì»¬ëŸ¼ í…Œë‘ë¦¬
                doc.setDrawColor(0, 0, 0);
                doc.setLineWidth(0.5);
                const leftColX = margin;
                const rightColX = margin + columnWidth + 5;
                const wrongSectionHeight = pageHeight - currentY - 15; // í•˜ë‹¨ ì—¬ë°±
                
                doc.rect(leftColX, currentY, columnWidth, wrongSectionHeight);
                doc.rect(rightColX, currentY, columnWidth, wrongSectionHeight);
                
                // ì œëª©
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text(`Wrong Answers (${wrongProblems.length})`, leftColX + 3, currentY + 6);
                doc.text(`Wrong Answers (${wrongProblems.length})`, rightColX + 3, currentY + 6);
                
                // 2ë‹¨ìœ¼ë¡œ ë¬¸ì œ ë°°ì¹˜
                let leftY = currentY + 12;
                let rightY = currentY + 12;
                const maxY = currentY + wrongSectionHeight - 5;
                
                doc.setFontSize(6);
                doc.setFont(undefined, 'normal');
                
                wrongProblems.forEach((problem, idx) => {
                    // ì¢Œìš° êµëŒ€ë¡œ ë°°ì¹˜
                    const isLeft = idx % 2 === 0;
                    const colX = isLeft ? leftColX + 3 : rightColX + 3;
                    let itemY = isLeft ? leftY : rightY;
                    
                    // í˜ì´ì§€ ë„˜ê¹€ ì²´í¬
                    if(itemY > maxY) {
                        doc.addPage();
                        currentY = margin + 10;
                        leftY = currentY + 12;
                        rightY = currentY + 12;
                        itemY = isLeft ? leftY : rightY;
                        
                        // ìƒˆ í˜ì´ì§€ í…Œë‘ë¦¬
                        doc.setDrawColor(0, 0, 0);
                        doc.setLineWidth(0.5);
                        doc.rect(leftColX, currentY, columnWidth, pageHeight - currentY - 15);
                        doc.rect(rightColX, currentY, columnWidth, pageHeight - currentY - 15);
                    }
                    
                    // Që²ˆí˜¸
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(0, 0, 0);
                    doc.text(`Q${problem.num}:`, colX, itemY);
                    
                    // X: í•™ìƒ ë‹µì•ˆ (ë¹¨ê°„ìƒ‰)
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(220, 53, 69);
                    const userText = problem.userAnswer.length > 35 ? problem.userAnswer.substring(0, 35) + '...' : problem.userAnswer;
                    doc.text(`X: ${userText}`, colX, itemY + 3, { maxWidth: columnWidth - 8 });
                    
                    // O: ì •ë‹µ (ì´ˆë¡ìƒ‰)
                    doc.setTextColor(40, 167, 69);
                    const correctText = problem.correctAnswer.length > 35 ? problem.correctAnswer.substring(0, 35) + '...' : problem.correctAnswer;
                    doc.text(`O: ${correctText}`, colX, itemY + 6, { maxWidth: columnWidth - 8 });
                    
                    // ë¬¸ì œ ë‚´ìš© (íšŒìƒ‰, ì‘ê²Œ)
                    doc.setTextColor(100, 100, 100);
                    doc.setFontSize(5);
                    const questionSnippet = problem.questionText.length > 70 ? problem.questionText.substring(0, 70) + '...' : problem.questionText;
                    doc.text(questionSnippet, colX, itemY + 9, { maxWidth: columnWidth - 8 });
                    
                    // ë‹¤ìŒ í•­ëª© ìœ„ì¹˜
                    doc.setFontSize(6);
                    if(isLeft) {
                        leftY += 12;
                    } else {
                        rightY += 12;
                    }
                });

                // í‘¸í„°
                doc.setFontSize(6);
                doc.setTextColor(150, 150, 150);
                doc.text('Generated by Woosong University AI Management Dept.', pageWidth / 2, pageHeight - 8, { align: 'center' });

                // PDF ì €ì¥
                doc.save(`${student.studentId}_${student.studentName}_report.pdf`);
                addLog(`âœ… ${student.studentName} í•™ìƒ ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ`);
            } catch (error) {
                addLog(`âŒ PDF ìƒì„± ì‹¤íŒ¨: ${error.message}`);
                console.error('PDF Error:', error);
            }
        }

        // ì „ì²´ í•™ìƒ ë¦¬í¬íŠ¸ ìƒì„± ë° ZIP ë‹¤ìš´ë¡œë“œ
        async function generateAllReports() {
            if(studentsData.length === 0) {
                alert('í•™ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            addLog('ğŸ“¦ ì „ì²´ í•™ìƒ ë¦¬í¬íŠ¸ ìƒì„± ì‹œì‘...');
            document.getElementById('progressContainer').style.display = 'block';
            document.getElementById('generateAllBtn').disabled = true;

            try {
                const zip = new JSZip();
                const { jsPDF } = window.jspdf;

                for(let idx = 0; idx < studentsData.length; idx++) {
                    const student = studentsData[idx];
                    const progress = ((idx + 1) / studentsData.length * 100).toFixed(0);
                    
                    const progressBar = document.getElementById('progressBar');
                    progressBar.style.width = progress + '%';
                    progressBar.textContent = progress + '%';

                    addLog(`ğŸ“„ ${idx + 1}/${studentsData.length} - ${student.studentName} ì²˜ë¦¬ ì¤‘...`);

                    const doc = new jsPDF();
                    const pageWidth = 210;
                    const pageHeight = 297;
                    const margin = 10;

                    // ë¡œê³  ë° í—¤ë”
                    doc.setFillColor(102, 126, 234);
                    doc.rect(0, 0, pageWidth, 20, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('WOOSONG UNIVERSITY', pageWidth / 2, 8, { align: 'center' });
                    doc.setFontSize(11);
                    doc.text('AI Management Department', pageWidth / 2, 15, { align: 'center' });

                    // í•™ìƒ ì •ë³´
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    
                    const infoY = 25;
                    doc.text(`ID: ${student.studentId}`, margin, infoY);
                    doc.text(`Name: ${student.studentName}`, margin + 45, infoY);
                    
                    const score = student.score || 0;
                    const total = student.totalQuestions || 100;
                    const percentage = ((score / total) * 100).toFixed(1);
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Score: ${score}/${total} (${percentage}%)`, margin, infoY + 6);
                    
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'normal');
                    const time = student.startedAt ? new Date(student.startedAt).toLocaleString('ko-KR') : '-';
                    doc.text(`Time: ${Math.floor(student.timeUsedSeconds / 60)}m ${student.timeUsedSeconds % 60}s`, margin + 50, infoY + 6);
                    doc.text(`Date: ${time}`, margin + 90, infoY + 6);

                    // Answer Sheet
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text('Answer Sheet', margin, infoY + 14);
                    
                    const matrixStartY = infoY + 18;
                    const cols = 5;
                    const rows = 20;
                    const cellSize = 6;
                    const gapX = 1.5;
                    const gapY = 0.8;
                    
                    const wrongProblems = [];
                    const questions = student.questions || [];
                    const answers = student.answers || [];

                    for(let i = 0; i < total; i++) {
                        const col = Math.floor(i / rows);
                        const row = i % rows;
                        const x = margin + col * (cellSize + gapX);
                        const y = matrixStartY + row * (cellSize + gapY);
                        
                        let isCorrect = false;
                        if(i < questions.length) {
                            const q = questions[i];
                            let a = answers.find(x => x.index === i);
                            if(!a && q.id) a = answers.find(x => x.qId === q.id);
                            
                            const selIdx = a ? a.selected : null;
                            const qAnswer = typeof q.answer === 'number' ? q.answer : parseInt(q.answer || 0, 10);
                            
                            isCorrect = (selIdx === qAnswer);
                            
                            if(!isCorrect) {
                                const options = q.options || [];
                                const selectedText = selIdx != null && options[selIdx] ? options[selIdx] : 'N/A';
                                const correctText = options[qAnswer] || 'N/A';
                                
                                wrongProblems.push({
                                    num: i + 1,
                                    userAnswer: selectedText,
                                    correctAnswer: correctText,
                                    questionText: q.text || q.question || ''
                                });
                            }
                        }
                        
                        doc.setDrawColor(200, 200, 200);
                        doc.setLineWidth(0.1);
                        doc.rect(x, y, cellSize, cellSize);
                        
                        doc.setFontSize(5);
                        doc.setTextColor(100, 100, 100);
                        doc.text(String(i + 1), x + 0.8, y + 2.5);
                        
                        if(isCorrect) {
                            doc.setDrawColor(0, 123, 255);
                            doc.setLineWidth(0.4);
                            doc.circle(x + cellSize - 1.5, y + cellSize - 1.5, 1.2);
                        } else {
                            doc.setDrawColor(220, 53, 69);
                            doc.setLineWidth(0.4);
                            const xSize = 1.2;
                            const cx = x + cellSize - 1.5;
                            const cy = y + cellSize - 1.5;
                            doc.line(cx - xSize, cy - xSize, cx + xSize, cy + xSize);
                            doc.line(cx - xSize, cy + xSize, cx + xSize, cy - xSize);
                        }
                    }

                    // Wrong Answers (Answer Sheet ì•„ë˜ë¶€í„° 3ë‹¨)
                    const answerSheetEndY = matrixStartY + rows * (cellSize + gapY) + 3;
                    
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(0, 0, 0);
                    doc.text(`Wrong Answers (${wrongProblems.length})`, margin, answerSheetEndY);
                    
                    const columns = 3;
                    const columnWidth = (pageWidth - 2 * margin) / columns;
                    
                    // ì™¼ìª½ ì»¬ëŸ¼ë¶€í„° ì‹œì‘ (Answer Sheet ì•„ë˜)
                    let currentColumn = 0;
                    let currentX = margin;
                    let currentY = answerSheetEndY + 4;
                    
                    doc.setFontSize(6);
                    doc.setFont(undefined, 'normal');
                    
                    wrongProblems.forEach((problem) => {
                        // í˜ì´ì§€ í•˜ë‹¨ ì²´í¬
                        if(currentY > pageHeight - 15) {
                            if(currentColumn < columns - 1) {
                                // ë‹¤ìŒ ì»¬ëŸ¼ìœ¼ë¡œ ì´ë™
                                currentColumn++;
                                currentX = margin + currentColumn * columnWidth;
                                currentY = infoY + 14;  // ë‹¤ìŒ ì»¬ëŸ¼ì€ í—¤ë” ì•„ë˜ë¶€í„°
                            } else {
                                // ìƒˆ í˜ì´ì§€
                                doc.addPage();
                                currentColumn = 0;
                                currentX = margin;
                                currentY = margin + 10;
                            }
                        }
                        
                        const colX = currentX;
                        
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(0, 0, 0);
                        doc.text(`Q${problem.num}:`, colX, currentY);
                        
                        doc.setFont(undefined, 'normal');
                        doc.setTextColor(220, 53, 69);
                        const userText = problem.userAnswer.length > 20 ? problem.userAnswer.substring(0, 20) + '...' : problem.userAnswer;
                        doc.text(`X: ${userText}`, colX, currentY + 2.5, { maxWidth: columnWidth - 5 });
                        
                        doc.setTextColor(40, 167, 69);
                        const correctText = problem.correctAnswer.length > 20 ? problem.correctAnswer.substring(0, 20) + '...' : problem.correctAnswer;
                        doc.text(`O: ${correctText}`, colX, currentY + 5, { maxWidth: columnWidth - 5 });
                        
                        doc.setTextColor(80, 80, 80);
                        doc.setFontSize(5);
                        const questionSnippet = problem.questionText.length > 60 ? problem.questionText.substring(0, 60) + '...' : problem.questionText;
                        doc.text(questionSnippet, colX, currentY + 7.5, { maxWidth: columnWidth - 5 });
                        
                        doc.setFontSize(6);
                        currentY += 10;
                    });

                    // í‘¸í„°
                    doc.setFontSize(6);
                    doc.setTextColor(150, 150, 150);
                    doc.text('Generated by Woosong University AI Management Dept.', pageWidth / 2, pageHeight - 8, { align: 'center' });

                    const pdfBlob = doc.output('blob');
                    zip.file(`${student.studentId}_${student.studentName}.pdf`, pdfBlob);
                }

                addLog('ğŸ“¦ ZIP íŒŒì¼ ìƒì„± ì¤‘...');
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                saveAs(zipBlob, `exam_reports_${new Date().toISOString().split('T')[0]}.zip`);
                
                addLog(`âœ… ì „ì²´ ${studentsData.length}ê°œ ë¦¬í¬íŠ¸ ZIP ë‹¤ìš´ë¡œë“œ ì™„ë£Œ!`);
            } catch (error) {
                addLog(`âŒ ì˜¤ë¥˜: ${error.message}`);
            } finally {
                document.getElementById('progressContainer').style.display = 'none';
                document.getElementById('generateAllBtn').disabled = false;
            }
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ
        window.onload = function() {
            addLog('ğŸš€ ì‹œí—˜ ê²°ê³¼ ë¦¬í¬íŠ¸ ìƒì„±ê¸° ì‹œì‘');
            
            // ì„¸ì…˜ì´ ìˆìœ¼ë©´ ìë™ ë¡œê·¸ì¸
            if(checkSession()) {
                addLog('âœ… ì„¸ì…˜ í™•ì¸ ì™„ë£Œ - ìë™ ë¡œê·¸ì¸');
            } else {
                // ë¡œê·¸ì¸ í™”ë©´ì— í¬ì»¤ìŠ¤
                document.getElementById('passwordInput').focus();
            }
        };
    </script>
</body>
</html>
