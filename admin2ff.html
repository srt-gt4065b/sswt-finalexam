<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin – Final Exam Dashboard</title>

<script src="https://cdn.tailwindcss.com"></script>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

</head>

<body class="bg-gray-100 min-h-screen p-6">

<!-- ========================================================= -->
<!-- PASSWORD GATE (UNCHANGED) -->
<!-- ========================================================= -->
<div id="passwordGate"
     class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
  <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-sm w-full text-center">

    <h2 class="text-2xl font-bold text-purple-600 mb-4">Admin Access</h2>
    <p class="text-gray-600 mb-6">Enter the admin password to continue.</p>

    <input id="adminPass"
           type="password"
           class="w-full px-4 py-3 border rounded-lg text-center text-lg focus:ring-2 focus:ring-purple-500"
           placeholder="Enter password">

    <button onclick="checkAdminPassword()"
            class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded-lg mt-4">
      Unlock
    </button>

    <p id="passError" class="text-red-500 font-semibold mt-3 hidden">
      ❌ Incorrect password
    </p>
  </div>
</div>

<script>
function checkAdminPassword() {
  const input = document.getElementById("adminPass").value.trim();
  if (input === "1230") {
    document.getElementById("passwordGate").classList.add("hidden");
  } else {
    document.getElementById("passError").classList.remove("hidden");
  }
}
</script>

<!-- ========================================================= -->
<!-- MAIN WRAPPER (UNCHANGED STRUCTURE) -->
<!-- ========================================================= -->
<div class="max-w-7xl mx-auto bg-white p-6 md:p-10 rounded-2xl shadow-xl">

  <h1 class="text-3xl md:text-4xl font-bold text-center text-purple-700 mb-6">
    Admin – Final Exam Dashboard
  </h1>

  <!-- ========================================================= -->
  <!-- TAB MENU — Student List 탭 추가됨 -->
  <!-- ========================================================= -->
  <div class="border-b mb-4 flex flex-wrap gap-2">

    <button class="tab-btn px-4 py-2 font-semibold border-b-2 border-purple-600 text-purple-700"
            data-tab="wrongTab">Wrong Questions</button>

    <button class="tab-btn px-4 py-2 font-semibold text-gray-500"
            data-tab="resultsTab">Student Results</button>

    <button class="tab-btn px-4 py-2 font-semibold text-gray-500"
            data-tab="previewTab">Preview</button>

    <button class="tab-btn px-4 py-2 font-semibold text-gray-500"
            data-tab="uploadTab">Upload</button>

    <button class="tab-btn px-4 py-2 font-semibold text-gray-500"
            data-tab="randomTab">Random</button>

    <!-- ✅ 새로 추가된 학생명단 탭 -->
    <button class="tab-btn px-4 py-2 font-semibold text-gray-500"
            data-tab="studentListTab">Student List</button>

  </div>

  <!-- ========================================================= -->
  <!-- TAB: WRONG QUESTIONS (원본 유지, 그대로 둠) -->
  <!-- ========================================================= -->
  <div id="wrongTab" class="tab-pane block">
    <h2 class="text-xl font-bold mb-3 text-purple-700">Wrong Question Summary</h2>
    <p class="text-sm text-gray-600 mb-4">Select a student to view incorrect answers.</p>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

      <div class="border rounded-xl p-4 bg-gray-50 max-h-[600px] overflow-auto">
        <h3 class="font-semibold mb-2">Students</h3>
        <div id="wrongStudentList" class="space-y-2 text-sm"></div>
      </div>

      <div class="border rounded-xl p-4 bg-gray-50 md:col-span-2">
        <h3 id="wrongTitle" class="font-semibold mb-2">Select a student</h3>
        <div id="wrongDetails" class="text-sm space-y-2"></div>
      </div>

    </div>
  </div>

  <!-- ========================================================= -->
  <!-- TAB: STUDENT RESULTS (원본 그대로 유지) -->
  <!-- ========================================================= -->
  <div id="resultsTab" class="tab-pane hidden">
    <h2 class="text-xl font-bold mb-4 text-purple-700">Student Results</h2>
    <div id="studentResultsArea"></div>
  </div>

  <!-- ========================================================= -->
  <!-- TAB: PREVIEW (원본 유지) -->
  <!-- ========================================================= -->
  <div id="previewTab" class="tab-pane hidden">
    <h2 class="text-xl font-bold mb-3 text-purple-700">Preview</h2>
    <div id="previewArea"></div>
  </div>

  <!-- ========================================================= -->
  <!-- TAB: UPLOAD (원본 유지) -->
  <!-- ========================================================= -->
  <div id="uploadTab" class="tab-pane hidden">
    <h2 class="text-xl font-bold mb-3 text-purple-700">Upload</h2>
    <div id="uploadArea"></div>
  </div>

  <!-- ========================================================= -->
  <!-- TAB: RANDOM GENERATOR (원본 유지) -->
  <!-- ========================================================= -->
  <div id="randomTab" class="tab-pane hidden">
    <h2 class="text-xl font-bold mb-3 text-purple-700">Random Question Generator</h2>
    <div id="randomArea"></div>
  </div>

  <!-- ========================================================= -->
  <!-- TAB: STUDENT LIST — NEW FEATURE -->
  <!-- ========================================================= -->
  <div id="studentListTab" class="tab-pane hidden mt-4">
    <div class="border rounded-xl p-6 bg-gray-50">

      <h2 class="text-xl font-bold mb-4 text-purple-700">Upload Student List (CSV)</h2>

      <p class="text-sm text-gray-700 mb-3">
        Format: <span class="font-mono">FullName,SID</span>
      </p>

      <input id="studentCsvFile" type="file" accept=".csv"
             class="w-full border p-3 rounded bg-white shadow-sm mb-4">

      <button onclick="previewStudentCSV()"
        class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-bold">
        Preview CSV
      </button>

      <div id="studentCsvPreview" class="mt-4 text-sm"></div>

      <button id="uploadStudentListBtn" onclick="uploadStudentList()"
        class="hidden w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg font-bold mt-4">
        Upload to Firestore
      </button>

    </div>
  </div>

  <script>
/* =========================================================
   TAB SWITCHING (원본 기능과 완전 호환)
========================================================= */
const tabButtons = document.querySelectorAll(".tab-btn");
const tabPanes   = document.querySelectorAll(".tab-pane");

tabButtons.forEach(btn => {
    btn.addEventListener("click", () => {
        const tab = btn.dataset.tab;

        tabButtons.forEach(b => {
            b.classList.remove("border-purple-600", "text-purple-700");
            b.classList.add("text-gray-500");
        });

        btn.classList.add("border-purple-600", "text-purple-700");
        btn.classList.remove("text-gray-500");

        tabPanes.forEach(p => p.classList.add("hidden"));
        document.getElementById(tab).classList.remove("hidden");
    });
});


/* =========================================================
   CSV PARSER FOR STUDENT LIST
========================================================= */
function parseStudentCSV(text) {
    const lines = text.trim().split("\n");
    const rows = [];

    for (let i = 1; i < lines.length; i++) {
        const cols = lines[i].split(",");
        if (cols.length < 2) continue;

        const name = cols[0].trim();
        const sid  = cols[1].trim();

        if (!name || !sid) continue;

        rows.push({ name, sid });
    }

    return rows;
}


let studentPreview = []; // 전역으로 CSV preview 저장


/* =========================================================
   PREVIEW CSV + FIRESTORE 중복 SID 체크
========================================================= */
async function previewStudentCSV() {
    const file = document.getElementById("studentCsvFile").files[0];
    if (!file) {
        alert("Please select a CSV file.");
        return;
    }

    const reader = new FileReader();
    reader.onload = async e => {
        const csvText = e.target.result;
        const parsedRows = parseStudentCSV(csvText);
        studentPreview = parsedRows;

        let html = `
            <h3 class="font-bold mb-2">Preview (${parsedRows.length} students)</h3>
            <table class="w-full text-left text-xs border">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="border px-2 py-1">Full Name</th>
                        <th class="border px-2 py-1">SID</th>
                        <th class="border px-2 py-1">Status</th>
                    </tr>
                </thead>
                <tbody>
        `;

        const existing = await db.collection("student_list").get();
        const existingSIDs = new Set(existing.docs.map(doc => doc.id));

        parsedRows.forEach(r => {
            const duplicate = existingSIDs.has(r.sid);

            html += `
                <tr>
                    <td class="border px-2 py-1">${r.name}</td>
                    <td class="border px-2 py-1">${r.sid}</td>
                    <td class="border px-2 py-1 ${duplicate ? "text-red-600" : "text-green-600"}">
                        ${duplicate ? "Duplicate (will overwrite)" : "New"}
                    </td>
                </tr>
            `;
        });

        html += "</tbody></table>";

        document.getElementById("studentCsvPreview").innerHTML = html;
        document.getElementById("uploadStudentListBtn").classList.remove("hidden");
    };

    reader.readAsText(file);
}
</script>

    <script>
/* =========================================================
   UPLOAD STUDENT LIST TO FIRESTORE
========================================================= */
async function uploadStudentList() {
    if (studentPreview.length === 0) {
        alert("No student data available to upload.");
        return;
    }

    if (!confirm("Upload student list to Firestore? This will overwrite existing entries with the same SID.")) {
        return;
    }

    const batch = db.batch();
    const col = db.collection("student_list");

    studentPreview.forEach(r => {
        const ref = col.doc(r.sid);
        batch.set(ref, {
            fullName: r.name,
            sid: r.sid,
            timestamp: new Date().toISOString()
        });
    });

    try {
        await batch.commit();
        document.getElementById("studentCsvPreview").innerHTML =
            `<p class="text-green-600 font-bold mt-4">✅ Successfully uploaded ${studentPreview.length} students to Firestore.</p>`;
        document.getElementById("uploadStudentListBtn").classList.add("hidden");
    } catch (err) {
        console.error(err);
        alert("Upload failed. Check console for details.");
    }
}
</script>

</body>
</html>
